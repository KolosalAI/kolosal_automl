<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Kolosal AutoML</title>
    <script src="/static/chart.min.js" defer></script>
    <link rel="preload" href="/static/remixicon.woff2" as="font" type="font/woff2" crossorigin>
    <link href="/static/remixicon.css" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="/static/remixicon.css" rel="stylesheet"></noscript>
    <style>
        /* === Reset === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-variation-settings: "slnt" 0;
            font-optical-sizing: auto;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-smooth: never;
            scrollbar-width: none;
            font-family: "Inter", sans-serif;
        }
        h1, h2, h3, h4, h5, h6, small, p, span, a { margin: 0; padding: 0; text-shadow: none; }
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; scrollbar-width: none; }
        body::-webkit-scrollbar { display: none; }
        body img { display: block; }

        /* === Color Variables === */
        :root {
            --color-text-900: #0D0E0F;
            --color-text-800: #3C3E40;
            --color-text-700: #6A6F73;
            --color-text-600: #9C9FA1;
            --color-text-500: #CECFD0;
            --color-grey-900: #DDE1E3;
            --color-grey-800: #E4E7E9;
            --color-grey-700: #EBEDEE;
            --color-grey-600: #F1F3F4;
            --color-grey-500: #F8F9F9;
            --color-information-900: #001431;
            --color-information-800: #002962;
            --color-information-700: #003D93;
            --color-information-600: #0052C4;
            --color-information-500: #0066F5;
            --color-information-400: #3C8AF7;
            --color-information-300: #78AEFA;
            --color-information-200: #B4D2FC;
            --color-information-100: #F0F6FE;
            --color-success-900: #0C260D;
            --color-success-800: #174B19;
            --color-success-700: #237126;
            --color-success-600: #2E9632;
            --color-success-500: #3ABC3F;
            --color-success-400: #68CC6C;
            --color-success-300: #97DC99;
            --color-success-200: #C5EBC6;
            --color-success-100: #F3FBF4;
            --color-danger-900: #330A0A;
            --color-danger-800: #661414;
            --color-danger-700: #991D1D;
            --color-danger-600: #CC2727;
            --color-danger-500: #FF3131;
            --color-danger-400: #FF6161;
            --color-danger-300: #FF9292;
            --color-danger-200: #FFC2C2;
            --color-danger-100: #FFF3F3;
            --color-warning-900: #33220A;
            --color-warning-800: #664414;
            --color-warning-700: #99651D;
            --color-warning-600: #CC8727;
            --color-warning-500: #FFA931;
            --color-warning-400: #FFBD61;
            --color-warning-300: #FFD192;
            --color-warning-200: #FFE6C2;
            --color-warning-100: #FFFAF3;
        }

        /* === Typography === */
        .text-12px { font-size: 12px; line-height: 16px; letter-spacing: -0.2px; font-family: "Inter", sans-serif; }
        .text-14px { font-size: 14px; line-height: 20px; letter-spacing: -0.2px; font-family: "Inter", sans-serif; }
        .text-16px { font-size: 16px; line-height: 24px; letter-spacing: -0.2px; font-family: "Inter", sans-serif; }
        .text-18px { font-size: 18px; line-height: 28px; letter-spacing: -0.2px; font-family: "Inter", sans-serif; }
        .text-20px { font-size: 20px; line-height: 32px; letter-spacing: -0.2px; font-family: "Inter", sans-serif; }
        .text-24px { font-size: 24px; line-height: 36px; letter-spacing: 0px; font-family: "Inter", sans-serif; }
        .text-32px { font-size: 32px; line-height: 44px; letter-spacing: -0.6px; font-family: "Inter", sans-serif; }
        .mono-12px { font-size: 12px; line-height: 16px; letter-spacing: -0.4px; font-family: "Geist Mono", monospace; }
        .mono-14px { font-size: 14px; line-height: 20px; letter-spacing: -0.4px; font-family: "Geist Mono", monospace; }
        .mono-20px { font-size: 20px; line-height: 32px; letter-spacing: -0.4px; font-family: "Geist Mono", monospace; }
        .mono-32px { font-size: 32px; line-height: 44px; letter-spacing: -0.8px; font-family: "Geist Mono", monospace; }
        .regular { font-weight: 400; font-style: normal; }
        .medium { font-weight: 500; font-style: normal; }

        /* === Layout === */
        .container { max-width: 1080px; width: 100%; padding-left: 20px; padding-right: 20px; margin-left: auto; margin-right: auto; }
        .container-fluid { max-width: 100%; width: 100%; margin-left: auto; margin-right: auto; }
        .col-fill { flex: 1 0 0; }

        /* === Buttons === */
        .btn-xs { display: flex; flex-direction: row; justify-content: center; align-items: center; gap: 4px; height: 28px; font-size: 12px; font-weight: 500; line-height: 16px; letter-spacing: 0.3px; border-radius: 6px; outline: none; border: none; padding-left: 8px; padding-right: 8px; text-decoration: none; cursor: pointer; }
        .btn-xs i { font-size: 14px; }
        .btn-sm { display: flex; flex-direction: row; justify-content: center; align-items: center; gap: 4px; height: 32px; font-size: 14px; font-weight: 500; line-height: 20px; letter-spacing: 0.3px; border-radius: 8px; outline: none; border: none; padding-left: 10px; padding-right: 10px; text-decoration: none; cursor: pointer; }
        .btn-sm i { font-size: 16px; }
        .btn-md { display: flex; flex-direction: row; justify-content: center; align-items: center; gap: 6px; height: 36px; font-size: 14px; font-weight: 500; line-height: 20px; letter-spacing: 0.3px; border-radius: 10px; outline: none; border: none; padding-left: 14px; padding-right: 14px; text-decoration: none; cursor: pointer; }
        .btn-md i { font-size: 20px; }
        .btn-lg { display: flex; flex-direction: row; justify-content: center; align-items: center; gap: 8px; height: 40px; font-size: 14px; font-weight: 500; line-height: 20px; letter-spacing: 0.3px; border-radius: 12px; outline: none; border: none; padding-left: 16px; padding-right: 16px; text-decoration: none; cursor: pointer; }
        .btn-lg i { font-size: 24px; }
        .btn-sm-icon { display: flex; flex-direction: row; justify-content: center; align-items: center; height: 32px; width: 32px; border-radius: 8px; outline: none; border: none; text-decoration: none; cursor: pointer; }
        .btn-sm-icon i { font-size: 16px; }
        .btn-primary { background-color: var(--color-text-900); color: #FFFFFF; box-shadow: inset 0px 2px 0px 0px rgba(255,255,255,0.25); border: 1px solid var(--color-text-900); }
        .btn-primary:hover { background: linear-gradient(90deg, #0D0E0F, #FF3131, #0066F5); background-size: 300% 300%; animation: gradientMove 3s ease infinite; }
        @keyframes gradientMove { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .btn-secondary { background-color: var(--color-information-500); color: #FFFFFF; box-shadow: inset 0px 2px 0px 0px rgba(255,255,255,0.25); border: 1px solid var(--color-information-500); }
        .btn-secondary:hover { background-color: var(--color-information-600); border-color: var(--color-information-600); }
        .btn-outline { background-color: #FFFFFF; border: 1px solid var(--color-grey-800); box-shadow: 0px 3px 4px -4px rgba(0,0,0,0.15); color: var(--color-text-900); }
        .btn-outline:hover { background-color: var(--color-grey-500); border: 1px solid var(--color-grey-900); }
        .btn-danger { background-color: var(--color-danger-500); border: 1px solid var(--color-danger-500); color: #FFFFFF; box-shadow: inset 0px 2px 0px 0px rgba(255,255,255,0.25); }
        .btn-danger:hover { background-color: var(--color-danger-600); border-color: var(--color-danger-600); }
        .btn-ghost { background-color: transparent; color: var(--color-text-900); border: none; }
        .btn-ghost:hover { background-color: var(--color-grey-600); }
        .btn-primary:disabled, .btn-secondary:disabled, .btn-outline:disabled, .btn-danger:disabled, .btn-ghost:disabled { pointer-events: none; opacity: 0.65; cursor: not-allowed; }

        /* === Inputs === */
        .input-text-sm { font-size: 14px; line-height: 20px; font-weight: 400; height: 32px; padding-left: 10px; padding-right: 10px; border: 1px solid var(--color-grey-900); border-radius: 8px; width: 100%; box-shadow: 0px 3px 4px -4px rgba(0,0,0,0.15); }
        .input-text-md { font-size: 14px; line-height: 20px; font-weight: 400; height: 36px; padding-left: 14px; padding-right: 14px; border: 1px solid var(--color-grey-900); border-radius: 10px; width: 100%; box-shadow: 0px 3px 4px -4px rgba(0,0,0,0.15); }
        .input-text-lg { font-size: 14px; line-height: 20px; font-weight: 400; height: 40px; padding-left: 16px; padding-right: 16px; border: 1px solid var(--color-grey-900); border-radius: 12px; width: 100%; box-shadow: 0px 3px 4px -4px rgba(0,0,0,0.15); }
        .input-text-sm:hover, .input-text-md:hover, .input-text-lg:hover { border-color: var(--color-text-500); box-shadow: none; }
        .input-text-sm::placeholder, .input-text-md::placeholder, .input-text-lg::placeholder { color: var(--color-text-600); }
        .input-text-sm:focus-visible, .input-text-md:focus-visible, .input-text-lg:focus-visible { border: 1px solid var(--color-text-600); outline: none; box-shadow: 0px 0px 0px 2px var(--color-grey-800); }
        select.input-text-sm, select.input-text-md, select.input-text-lg { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236A6F73' viewBox='0 0 24 24'%3E%3Cpath d='M12 16l-6-6h12z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 36px; }
        .input-textarea { font-size: 14px; line-height: 24px; font-weight: 400; padding: 8px 12px; width: 100%; min-height: 156px; border: 1px solid var(--color-grey-900); box-shadow: 0px 3px 4px -4px rgba(0,0,0,0.15); border-radius: 12px; resize: none; font-family: "Inter", sans-serif; }
        .input-textarea:hover { border-color: var(--color-text-500); box-shadow: none; }
        .input-textarea::placeholder { color: var(--color-text-600); }
        .input-textarea:focus-visible { border: 1px solid var(--color-text-600); outline: none; box-shadow: 0px 0px 0px 2px var(--color-grey-800); }

        /* === Badge === */
        .badge-sm { display: flex; flex-direction: row; justify-content: center; align-items: center; height: 24px; border-radius: 6px; width: fit-content; padding: 0px 8px; font-size: 12px; font-weight: 500; line-height: 16px; }
        .badge-information { color: var(--color-information-600); background-color: var(--color-information-100); }
        .badge-success { color: var(--color-success-600); background-color: var(--color-success-100); }
        .badge-danger { color: var(--color-danger-600); background-color: var(--color-danger-100); }
        .badge-warning { color: var(--color-warning-600); background-color: var(--color-warning-100); }

        /* === Switch === */
        .switch-sm { position: relative; display: flex; align-items: center; justify-content: center; width: 28px; height: 16px; border-radius: 24px; overflow: hidden; }
        .switch-sm input { opacity: 0; width: 0; height: 0; }
        .switch-sm .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; padding: 1px; background-color: var(--color-grey-700); border: 1px solid var(--color-grey-900); border-radius: 999px; transition: all 0.25s ease; }
        .switch-sm .slider::before { content: ""; position: absolute; height: 12px; width: 12px; background-color: #FFFFFF; border-radius: 999px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); transition: transform 0.4s ease, background-color 0.4s ease; }
        .switch-sm input:checked + .slider { background-color: var(--color-text-700); border-color: var(--color-text-800); }
        .switch-sm input:checked + .slider::before { background-color: var(--color-text-900); transform: translateX(12px); }

        /* === Ornament === */
        .ornament-icon-grey { display: flex; flex-direction: row; justify-content: center; align-items: center; height: 40px; width: 40px; background-color: var(--color-grey-500); border: 1px solid var(--color-grey-700); border-radius: 12px; }
        .ornament-icon-grey i { font-size: 20px; color: var(--color-text-600); }

        /* === App Layout === */
        body { background-color: var(--color-grey-500); color: var(--color-text-900); min-height: 100vh; }

        /* Header */
        .app-header { position: sticky; top: 0; z-index: 15; background-color: #FFFFFF; border-bottom: 1px solid var(--color-grey-900); }
        .app-header-inner { display: flex; flex-direction: row; justify-content: space-between; align-items: center; padding-top: 16px; padding-bottom: 16px; }
        .app-header-logo { display: flex; flex-direction: row; align-items: center; gap: 10px; }
        .app-header-logo .divider { height: 16px; border-right: 1px solid var(--color-grey-900); margin-left: 4px; margin-right: 4px; }
        .app-header-status { display: flex; flex-direction: row; align-items: center; gap: 8px; }
        .status-dot { width: 8px; height: 8px; border-radius: 999px; }
        .status-dot.healthy { background-color: var(--color-success-500); }
        .status-dot.error { background-color: var(--color-danger-500); }

        /* Navigation */
        .app-nav { background-color: #FFFFFF; border-bottom: 1px solid var(--color-grey-800); }
        .app-nav-inner { display: flex; flex-direction: row; align-items: center; gap: 4px; }
        .nav-tab { display: flex; flex-direction: row; justify-content: center; align-items: center; gap: 6px; height: 40px; padding: 0 12px; font-size: 14px; font-weight: 500; line-height: 20px; color: var(--color-text-700); background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; transition: all 0.15s ease; border-radius: 0; }
        .nav-tab:hover { color: var(--color-text-900); background-color: var(--color-grey-600); }
        .nav-tab.active { color: var(--color-text-900); border-bottom-color: var(--color-text-900); }
        .nav-tab i { font-size: 16px; }

        /* Cards */
        .card { background-color: #FFFFFF; border: 1px solid var(--color-grey-800); border-radius: 12px; padding: 24px; }
        .card-header { display: flex; flex-direction: row; justify-content: space-between; align-items: center; margin-bottom: 16px; }

        /* Grid */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
        .grid-1-2 { display: grid; grid-template-columns: 1fr 2fr; gap: 16px; }
        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-1-2 { grid-template-columns: 1fr; }
        }

        /* Content area */
        .app-content { padding-top: 24px; padding-bottom: 24px; }
        .section-gap { display: flex; flex-direction: column; gap: 16px; }

        /* Dropzone */
        .dropzone { border: 2px dashed var(--color-grey-900); border-radius: 12px; padding: 40px 24px; text-align: center; cursor: pointer; transition: all 0.15s ease; }
        .dropzone:hover { border-color: var(--color-text-500); background-color: var(--color-grey-600); }
        .dropzone.drag-over { border-color: var(--color-information-500); background-color: var(--color-information-100); }
        .dropzone i { font-size: 40px; color: var(--color-text-600); margin-bottom: 12px; }

        /* Table */
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { padding: 8px 12px; text-align: left; font-size: 12px; font-weight: 500; line-height: 16px; color: var(--color-text-700); background-color: var(--color-grey-500); border-bottom: 1px solid var(--color-grey-800); text-transform: uppercase; letter-spacing: 0.3px; }
        .data-table td { padding: 8px 12px; font-size: 14px; line-height: 20px; color: var(--color-text-800); border-bottom: 1px solid var(--color-grey-700); }
        .data-table tr:hover td { background-color: var(--color-grey-500); }
        .table-wrap { overflow-x: auto; border: 1px solid var(--color-grey-800); border-radius: 10px; }

        /* Progress bar */
        .progress-bar { width: 100%; height: 6px; background-color: var(--color-grey-800); border-radius: 999px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background-color: var(--color-information-500); border-radius: 999px; transition: width 0.3s ease; }

        /* Form */
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-label { font-size: 14px; font-weight: 500; line-height: 20px; color: var(--color-text-800); }
        .form-hint { font-size: 12px; line-height: 16px; color: var(--color-text-600); }
        .form-stack { display: flex; flex-direction: column; gap: 20px; }

        /* Range input */
        input[type="range"] { width: 100%; height: 6px; appearance: none; background: var(--color-grey-800); border-radius: 999px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { appearance: none; width: 16px; height: 16px; border-radius: 999px; background: var(--color-text-900); cursor: pointer; border: 2px solid #FFFFFF; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }

        /* Checkbox */
        .checkbox-row { display: flex; flex-direction: row; align-items: center; gap: 10px; cursor: pointer; padding: 6px 0; }
        .checkbox-row input[type="checkbox"] { width: 16px; height: 16px; accent-color: var(--color-text-900); cursor: pointer; }

        /* Multiselect Dropdown */
        .multiselect { position: relative; width: 100%; }
        .multiselect-trigger { display: flex; align-items: center; justify-content: space-between; gap: 8px; width: 100%; min-height: 40px; padding: 6px 12px; background: var(--color-grey-600); border: 1px solid var(--color-grey-700); border-radius: 8px; cursor: pointer; transition: border-color 0.15s; }
        .multiselect-trigger:hover { border-color: var(--color-grey-800); }
        .multiselect.open .multiselect-trigger { border-color: var(--color-text-900); }
        .multiselect-tags { display: flex; flex-wrap: wrap; gap: 4px; flex: 1; min-width: 0; }
        .multiselect-tag { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; background: var(--color-grey-800); border-radius: 4px; font-size: 12px; line-height: 20px; color: var(--color-text-900); white-space: nowrap; }
        .multiselect-tag-remove { cursor: pointer; opacity: 0.6; font-size: 14px; line-height: 1; }
        .multiselect-tag-remove:hover { opacity: 1; }
        .multiselect-placeholder { color: var(--color-text-600); font-size: 14px; }
        .multiselect-arrow { flex-shrink: 0; color: var(--color-text-600); transition: transform 0.15s; font-size: 16px; }
        .multiselect.open .multiselect-arrow { transform: rotate(180deg); }
        .multiselect-dropdown { position: absolute; top: calc(100% + 4px); left: 0; right: 0; background: var(--color-grey-500); border: 1px solid var(--color-grey-700); border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.25); z-index: 50; display: none; max-height: 280px; overflow: hidden; flex-direction: column; }
        .multiselect.open .multiselect-dropdown { display: flex; }
        .multiselect-search { padding: 8px; border-bottom: 1px solid var(--color-grey-700); }
        .multiselect-search input { width: 100%; padding: 6px 8px; background: var(--color-grey-600); border: 1px solid var(--color-grey-700); border-radius: 6px; color: var(--color-text-900); font-size: 13px; outline: none; }
        .multiselect-search input:focus { border-color: var(--color-text-900); }
        .multiselect-actions { display: flex; gap: 8px; padding: 6px 8px; border-bottom: 1px solid var(--color-grey-700); }
        .multiselect-actions button { padding: 2px 8px; font-size: 12px; background: none; border: 1px solid var(--color-grey-700); border-radius: 4px; color: var(--color-text-700); cursor: pointer; }
        .multiselect-actions button:hover { color: var(--color-text-900); border-color: var(--color-text-900); }
        .multiselect-options { overflow-y: auto; max-height: 200px; padding: 4px; }
        .multiselect-option { display: flex; align-items: center; gap: 8px; padding: 6px 8px; border-radius: 6px; cursor: pointer; font-size: 13px; color: var(--color-text-800); transition: background 0.1s; }
        .multiselect-option:hover { background: var(--color-grey-600); }
        .multiselect-option.selected { color: var(--color-text-900); font-weight: 500; }
        .multiselect-option .ms-check { width: 16px; height: 16px; border: 1.5px solid var(--color-grey-800); border-radius: 4px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.1s; }
        .multiselect-option.selected .ms-check { background: var(--color-text-900); border-color: var(--color-text-900); }
        .multiselect-option.selected .ms-check::after { content: '✓'; font-size: 11px; color: var(--color-grey-500); }
        .multiselect-group-label { padding: 6px 8px 2px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--color-text-600); }

        /* Column Select (single-select searchable dropdown) */
        .column-select { position: relative; width: 100%; }
        .column-select-trigger { display: flex; align-items: center; justify-content: space-between; gap: 8px; width: 100%; height: 36px; padding: 0 12px; background: #FFFFFF; border: 1px solid var(--color-grey-900); border-radius: 10px; cursor: pointer; transition: border-color 0.15s; box-shadow: 0px 3px 4px -4px rgba(0,0,0,0.15); }
        .column-select-trigger:hover { border-color: var(--color-text-500); box-shadow: none; }
        .column-select.open .column-select-trigger { border-color: var(--color-text-600); box-shadow: 0px 0px 0px 2px var(--color-grey-800); }
        .column-select-value { flex: 1; min-width: 0; font-size: 14px; line-height: 20px; color: var(--color-text-900); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .column-select-value.placeholder { color: var(--color-text-600); }
        .column-select-clear { flex-shrink: 0; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 12px; color: var(--color-text-600); cursor: pointer; transition: all 0.1s; }
        .column-select-clear:hover { background: var(--color-grey-700); color: var(--color-text-900); }
        .column-select-arrow { flex-shrink: 0; color: var(--color-text-600); transition: transform 0.15s; font-size: 16px; }
        .column-select.open .column-select-arrow { transform: rotate(180deg); }
        .column-select-dropdown { position: absolute; top: calc(100% + 4px); left: 0; right: 0; background: #FFFFFF; border: 1px solid var(--color-grey-800); border-radius: 10px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); z-index: 50; display: none; max-height: 260px; overflow: hidden; flex-direction: column; }
        .column-select.open .column-select-dropdown { display: flex; }
        .column-select-search { padding: 8px; border-bottom: 1px solid var(--color-grey-700); }
        .column-select-search input { width: 100%; padding: 6px 10px; background: var(--color-grey-600); border: 1px solid var(--color-grey-700); border-radius: 8px; color: var(--color-text-900); font-size: 13px; outline: none; }
        .column-select-search input:focus { border-color: var(--color-text-600); }
        .column-select-search input::placeholder { color: var(--color-text-600); }
        .column-select-options { overflow-y: auto; max-height: 200px; padding: 4px; }
        .column-select-option { display: flex; align-items: center; gap: 8px; padding: 7px 10px; border-radius: 8px; cursor: pointer; font-size: 13px; color: var(--color-text-800); transition: background 0.1s; }
        .column-select-option:hover { background: var(--color-grey-600); }
        .column-select-option.selected { color: var(--color-text-900); font-weight: 500; background: var(--color-grey-600); }
        .column-select-option .col-dtype { margin-left: auto; font-size: 11px; color: var(--color-text-600); font-family: "Geist Mono", monospace; }
        .column-select-option .col-icon { font-size: 14px; color: var(--color-text-600); width: 16px; text-align: center; }
        .column-select-empty { padding: 12px; text-align: center; font-size: 13px; color: var(--color-text-600); }

        /* Feature Columns Multiselect */
        .feature-select-info { display: flex; align-items: center; justify-content: space-between; margin-top: 4px; }
        .feature-select-count { font-size: 12px; color: var(--color-text-600); }
        .feature-select-count strong { color: var(--color-text-800); font-weight: 600; }

        /* Stat card */
        .stat-value { font-size: 32px; line-height: 44px; letter-spacing: -0.6px; font-family: "Geist Mono", monospace; font-weight: 500; }
        .stat-value.info { color: var(--color-information-500); }
        .stat-value.success { color: var(--color-success-500); }

        /* Job card */
        .job-card { border: 1px solid var(--color-grey-800); border-radius: 10px; padding: 16px; display: flex; flex-direction: column; gap: 10px; }

        /* Pre/Code */
        .code-block { background-color: var(--color-grey-500); border: 1px solid var(--color-grey-800); border-radius: 10px; padding: 16px; font-size: 13px; line-height: 20px; font-family: "Geist Mono", monospace; overflow: auto; color: var(--color-text-800); }

        /* Toast notifications */
        .toast-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 8px; z-index: 100; }
        .toast { padding: 10px 16px; border-radius: 10px; font-size: 14px; font-weight: 500; line-height: 20px; box-shadow: 0px 4px 12px rgba(0,0,0,0.15); }
        .toast-success { background-color: var(--color-success-500); color: #FFFFFF; }
        .toast-error { background-color: var(--color-danger-500); color: #FFFFFF; }
        .toast-info { background-color: var(--color-text-900); color: #FFFFFF; }

        /* Sample dataset pills */
        .pill { display: inline-flex; align-items: center; height: 28px; padding: 0 10px; font-size: 12px; font-weight: 500; border-radius: 999px; border: none; cursor: pointer; transition: all 0.15s ease; background-color: var(--color-information-100); color: var(--color-information-600); }
        .pill:hover { background-color: var(--color-information-200); }

        /* Separator */
        .separator { border: none; border-top: 1px solid var(--color-grey-800); margin: 4px 0; }

        /* Empty state */
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; color: var(--color-text-600); gap: 8px; }
        .empty-state i { font-size: 32px; color: var(--color-text-500); }

        /* Spinner */
        .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid var(--color-grey-800); border-top-color: var(--color-text-900); border-radius: 50%; animation: spin 0.6s linear infinite; }
        .spinner-lg { width: 32px; height: 32px; border-width: 3px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Loading overlay */
        .loading-overlay { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px 20px; gap: 12px; color: var(--color-text-600); }

        /* Skeleton loader */
        .skeleton { background: linear-gradient(90deg, var(--color-grey-700) 25%, var(--color-grey-600) 50%, var(--color-grey-700) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 6px; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* Scrollable nav for many tabs */
        .app-nav-inner { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .app-nav-inner::-webkit-scrollbar { display: none; }

        /* Alert banner */
        .alert-banner { padding: 10px 16px; border-radius: 10px; font-size: 13px; line-height: 18px; display: flex; align-items: center; gap: 8px; }
        .alert-warning { background-color: var(--color-warning-100); color: var(--color-warning-700); border: 1px solid var(--color-warning-200); }
        .alert-danger { background-color: var(--color-danger-100); color: var(--color-danger-700); border: 1px solid var(--color-danger-200); }

        /* Utility */
        .w-full { width: 100%; }
        .hidden { display: none; }
        .flex-row { display: flex; flex-direction: row; }
        .flex-col { display: flex; flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-4 { gap: 4px; }
        .gap-6 { gap: 6px; }
        .gap-8 { gap: 8px; }
        .gap-12 { gap: 12px; }
        .gap-16 { gap: 16px; }
        .gap-24 { gap: 24px; }
        .flex-wrap { flex-wrap: wrap; }
        .text-center { text-align: center; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        .sub-tabs { display: flex; flex-direction: row; gap: 4px; margin-bottom: 20px; border-bottom: 1px solid var(--color-grey-800); padding-bottom: 0; }
        .sub-tab { display: flex; align-items: center; gap: 4px; height: 32px; padding: 0 10px; font-size: 13px; font-weight: 500; color: var(--color-text-700); background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; transition: all 0.15s ease; }
        .sub-tab:hover { color: var(--color-text-900); background-color: var(--color-grey-600); }
        .sub-tab.active { color: var(--color-text-900); border-bottom-color: var(--color-text-900); }
        .sub-panel { display: none; }
        .sub-panel.active { display: block; }

        /* === Visual Enhancements === */

        /* Card hover lift */
        .card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }

        /* Tab fade-in */
        @keyframes fadeSlideIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
        .tab-panel.active { animation: fadeSlideIn 0.3s ease both; }
        .sub-panel.active { animation: fadeSlideIn 0.25s ease both; }

        /* Progress bar gradient + pulse */
        .progress-bar-fill.active {
            background: linear-gradient(90deg, var(--color-information-500), var(--color-information-300), var(--color-information-500));
            background-size: 200% 100%;
            animation: progressPulse 1.5s ease infinite;
        }
        @keyframes progressPulse { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* Striped progress bar */
        .progress-bar-fill.striped {
            background-image: linear-gradient(
                45deg,
                rgba(255,255,255,0.2) 25%, transparent 25%,
                transparent 50%, rgba(255,255,255,0.2) 50%,
                rgba(255,255,255,0.2) 75%, transparent 75%, transparent
            );
            background-size: 20px 20px;
            animation: progressStripe 0.6s linear infinite;
        }
        @keyframes progressStripe { from { background-position: 20px 0; } to { background-position: 0 0; } }

        /* Table row alternating colors */
        .data-table tbody tr:nth-child(even) td { background-color: var(--color-grey-500); }
        .data-table tbody tr:nth-child(even):hover td { background-color: var(--color-grey-600); }

        /* Toast slide-in/out */
        @keyframes toastSlideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes toastSlideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        .toast { animation: toastSlideIn 0.3s ease both; }
        .toast.removing { animation: toastSlideOut 0.25s ease both; }

        /* Badge pulse for Live */
        .badge-live { animation: badgePulse 1.5s ease-in-out infinite; }
        @keyframes badgePulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* Empty state floating icon */
        .empty-state i { animation: emptyFloat 3s ease-in-out infinite; }
        @keyframes emptyFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }

        /* Dropzone hover enhancements */
        .dropzone { transition: all 0.2s ease; }
        .dropzone:hover { transform: scale(1.01); border-color: var(--color-information-400); background-color: var(--color-information-100); }
        .dropzone:hover i { transform: translateY(-3px); transition: transform 0.2s ease; }

        /* Button press effect */
        .btn-primary:active, .btn-secondary:active, .btn-outline:active, .btn-danger:active { transform: scale(0.97); }

        /* Status ring pulse */
        #status-ring.healthy-pulse { animation: statusPulse 2s ease-in-out infinite; }
        @keyframes statusPulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(58,188,63,0.4); } 50% { box-shadow: 0 0 0 8px rgba(58,188,63,0); } }

        /* Medal colors for leaderboard */
        .medal-gold { color: #F59E0B; }
        .medal-silver { color: #9CA3AF; }
        .medal-bronze { color: #D97706; }

        /* Best model card glassmorphism */
        .best-model-card {
            background: linear-gradient(135deg, var(--color-information-500), var(--color-information-600));
            border-radius: 12px; padding: 20px; color: #fff;
            position: relative; overflow: hidden;
        }
        .best-model-card::before {
            content: ''; position: absolute; top: -50%; right: -50%;
            width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
            pointer-events: none;
        }
    </style>
</head>
<body style="background-color:#F8F9F9;color:#0D0E0F;font-family:Inter,system-ui,-apple-system,sans-serif;margin:0;padding:0;min-height:100vh;display:block;visibility:visible;opacity:1;">
    <!-- Header -->
    <header class="app-header">
        <div class="container app-header-inner">
            <div class="app-header-logo">
                <i class="ri-brain-line" style="font-size: 24px; color: var(--color-text-900);"></i>
                <span class="mono-20px medium">Kolosal AutoML</span>
                <div class="divider"></div>
                <span class="text-14px regular" style="color: var(--color-text-700);">Rust-Powered</span>
            </div>
            <div class="app-header-status">
                <div id="status-badge" class="badge-sm badge-success">healthy</div>
                <div id="status-dot" class="status-dot healthy"></div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="app-nav">
        <div class="container app-nav-inner">
            <button class="nav-tab active" onclick="switchTab('data')" data-tab="data">
                <i class="ri-folder-upload-line"></i> Data
            </button>
            <button class="nav-tab" onclick="switchTab('automl')" data-tab="automl">
                <i class="ri-magic-line"></i> AutoML
            </button>
            <button class="nav-tab" onclick="switchTab('train')" data-tab="train">
                <i class="ri-rocket-line"></i> Train
            </button>
            <button class="nav-tab" onclick="switchTab('predict')" data-tab="predict">
                <i class="ri-cursor-line"></i> Predict
            </button>
            <button class="nav-tab" onclick="switchTab('analyze')" data-tab="analyze">
                <i class="ri-search-eye-line"></i> Analyze
            </button>
            <button class="nav-tab" onclick="switchTab('serve')" data-tab="serve">
                <i class="ri-server-line"></i> Serve
            </button>
            <button class="nav-tab" onclick="switchTab('system')" data-tab="system">
                <i class="ri-dashboard-3-line"></i> System
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container app-content">
        <noscript>
            <div class="card" style="text-align: center; padding: 40px;">
                <p class="text-16px medium" style="color: var(--color-text-800);">JavaScript is required to use Kolosal AutoML.</p>
                <p class="text-14px regular" style="color: var(--color-text-700); margin-top: 8px;">Please enable JavaScript in your browser settings.</p>
            </div>
        </noscript>

        <!-- Data Upload Tab -->
        <div id="tab-data" class="tab-panel active">
            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <h2 class="text-16px medium">Upload Data</h2>
                    </div>
                    <div id="dropzone" class="dropzone">
                        <input type="file" id="fileInput" accept=".csv,.json,.parquet" class="hidden">
                        <i class="ri-upload-cloud-2-line"></i>
                        <p class="text-14px regular" style="color: var(--color-text-800);">Drop your CSV, JSON, or Parquet file here</p>
                        <p class="text-12px regular" style="color: var(--color-text-600); margin-top: 4px;">or click to browse</p>
                    </div>
                    <div style="margin-top: 20px;">
                        <p class="text-12px medium" style="color: var(--color-text-700); margin-bottom: 8px;">Or load a sample dataset:</p>
                        <div id="sample-pills" class="flex-row flex-wrap gap-8"></div>
                    </div>
                    <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--color-grey-800);">
                        <p class="text-12px medium" style="color: var(--color-text-700); margin-bottom: 8px;">Or import from URL:</p>
                        <div class="flex-row gap-8" style="align-items: stretch;">
                            <input type="text" id="import-url" class="input-text-md" placeholder="Paste URL (Kaggle, GitHub, CSV, Google Sheets, HuggingFace...)" style="flex:1;">
                            <button id="btn-import-url" onclick="importFromUrl()" class="btn-sm btn-primary" style="white-space:nowrap;">
                                <i class="ri-download-2-line"></i> Import
                            </button>
                        </div>
                        <div id="import-url-status" style="margin-top: 8px;"></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2 class="text-16px medium">Data Preview</h2>
                        <div id="data-meta" class="flex-row items-center gap-12" style="display:none;">
                            <span class="text-12px regular" style="color: var(--color-text-700);">
                                <span id="data-rows">0</span> rows &times; <span id="data-cols">0</span> columns
                            </span>
                            <button onclick="refreshPreview()" class="btn-xs btn-ghost"><i class="ri-refresh-line"></i> Refresh</button>
                        </div>
                    </div>
                    <div id="preview-table" style="display:none;"></div>
                    <div id="preview-empty" class="empty-state">
                        <i class="ri-database-2-line"></i>
                        <p class="text-14px regular">No data loaded</p>
                    </div>
                </div>
            </div>
            <div class="card" style="margin-top: 16px; grid-column: 1 / -1;">
                <div class="card-header">
                    <h2 class="text-16px medium">Data Summary</h2>
                </div>
                <div id="data-summary-chart-wrap" style="display:none;">
                    <div class="grid-2">
                        <div style="max-height: 280px;">
                            <canvas id="columnTypesChart" width="300" height="200"></canvas>
                        </div>
                        <div id="data-col-stats" class="flex-col gap-8"></div>
                    </div>
                </div>
                <div id="data-summary-empty" class="empty-state" style="padding: 20px;">
                    <i class="ri-pie-chart-line"></i>
                    <p class="text-14px regular">Load data to see summary</p>
                </div>
            </div>
        </div>

        <!-- AutoML Tab -->
        <div id="tab-automl" class="tab-panel">
            <div class="card">
                <div class="card-header">
                    <h2 class="text-16px medium"><i class="ri-magic-line"></i> One-Click AutoML</h2>
                    <span class="badge" style="background: var(--color-information-500); color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 11px;">NEW</span>
                </div>
                <p class="text-14px regular" style="color: var(--color-text-700); margin-bottom: 16px;">
                    Automatically detect task type, preprocess data, train multiple models, optimize the best one, and generate a full report — all with a single click.
                </p>

                <!-- Target Column Selection -->
                <div class="flex-col gap-8" style="margin-bottom: 16px;">
                    <label class="text-14px medium">Target Column *</label>
                    <div id="automl-target-wrap"></div>
                    <input type="hidden" id="automl-target" value="">
                </div>

                <!-- One-Click Button -->
                <button id="btn-automl-run" onclick="runAutoML()" class="btn-md btn-primary w-full" disabled style="margin-bottom: 24px; font-size: 16px; padding: 14px;">
                    <i class="ri-rocket-2-line"></i> Run AutoML Pipeline
                </button>

                <!-- Advanced Settings (Collapsible) -->
                <details style="margin-bottom: 20px;">
                    <summary class="text-14px medium" style="cursor: pointer; color: var(--color-text-800); padding: 8px 0;">
                        <i class="ri-settings-3-line"></i> Advanced Settings (Optional)
                    </summary>
                    <div class="flex-col gap-12" style="padding: 16px; background: var(--color-grey-600); border-radius: 8px; margin-top: 8px;">
                        <div class="grid-2" style="gap: 16px;">
                            <div class="flex-col gap-4">
                                <label class="text-13px regular">Task Type</label>
                                <select id="automl-task-type" class="input-text-md">
                                    <option value="">Auto-Detect</option>
                                    <option value="classification">Classification</option>
                                    <option value="regression">Regression</option>
                                </select>
                            </div>
                            <div class="flex-col gap-4">
                                <label class="text-13px regular">Scaler</label>
                                <select id="automl-scaler" class="input-text-md">
                                    <option value="">Auto (Standard)</option>
                                    <option value="standard">Standard</option>
                                    <option value="minmax">MinMax</option>
                                    <option value="robust">Robust</option>
                                    <option value="none">None</option>
                                </select>
                            </div>
                            <div class="flex-col gap-4">
                                <label class="text-13px regular">Imputation</label>
                                <select id="automl-imputation" class="input-text-md">
                                    <option value="">Auto (Mean)</option>
                                    <option value="mean">Mean</option>
                                    <option value="median">Median</option>
                                    <option value="mode">Mode</option>
                                    <option value="drop">Drop</option>
                                </select>
                            </div>
                            <div class="flex-col gap-4">
                                <label class="text-13px regular">Max Models</label>
                                <input type="number" id="automl-max-models" class="input-text-md" value="8" min="1" max="20">
                            </div>
                            <div class="flex-col gap-4">
                                <label class="text-13px regular">HyperOpt Trials</label>
                                <input type="number" id="automl-hyperopt-trials" class="input-text-md" value="20" min="0" max="200">
                                <span class="text-12px regular" style="color: var(--color-text-600);">Set to 0 to skip</span>
                            </div>
                            <div class="flex-col gap-4">
                                <label class="text-13px regular">CV Folds</label>
                                <input type="number" id="automl-cv-folds" class="input-text-md" value="5" min="2" max="20">
                            </div>
                            <div class="flex-col gap-4">
                                <label class="text-13px regular">Time Budget (seconds)</label>
                                <input type="number" id="automl-time-budget" class="input-text-md" value="0" min="0">
                                <span class="text-12px regular" style="color: var(--color-text-600);">0 = no limit</span>
                            </div>
                        </div>
                        <!-- Model Selection -->
                        <div class="flex-col gap-4" style="margin-top: 8px;">
                            <label class="text-13px regular">Select Models (leave empty for auto)</label>
                            <div id="automl-model-checkboxes"></div>
                        </div>
                    </div>
                </details>

                <!-- Pipeline Progress -->
                <div id="automl-progress" style="display: none;">
                    <div class="flex-col gap-12">
                        <div class="flex items-center gap-8">
                            <div class="spinner" style="width: 20px; height: 20px;"></div>
                            <span id="automl-status-text" class="text-14px medium" style="color: var(--color-information-500);">Starting...</span>
                        </div>
                        <div style="background: var(--color-grey-800); border-radius: 8px; height: 8px; overflow: hidden;">
                            <div id="automl-progress-bar" class="progress-bar-fill" style="width: 0%;"></div>
                        </div>
                        <span id="automl-progress-pct" class="text-12px regular" style="color: var(--color-text-600);">0%</span>
                    </div>
                </div>

                <!-- Results -->
                <div id="automl-results" style="display: none; margin-top: 24px;">
                    <div class="flex-col gap-16">
                        <!-- Best Model Card -->
                        <div class="best-model-card">
                            <div class="flex items-center gap-8" style="margin-bottom: 8px;">
                                <i class="ri-trophy-line" style="font-size: 24px;"></i>
                                <span class="text-16px medium">Best Model</span>
                            </div>
                            <div class="text-24px medium" id="automl-best-model">—</div>
                            <div class="text-14px regular" id="automl-best-score" style="opacity: 0.9;">—</div>
                        </div>

                        <!-- Summary -->
                        <div class="grid-2" style="gap: 12px;">
                            <div style="background: var(--color-grey-600); border-radius: 8px; padding: 12px; text-align: center;">
                                <div class="text-20px medium" id="automl-models-tested">0</div>
                                <div class="text-12px regular" style="color: var(--color-text-600);">Models Tested</div>
                            </div>
                            <div style="background: var(--color-grey-600); border-radius: 8px; padding: 12px; text-align: center;">
                                <div class="text-20px medium" id="automl-total-time">0s</div>
                                <div class="text-12px regular" style="color: var(--color-text-600);">Total Time</div>
                            </div>
                        </div>

                        <!-- Leaderboard -->
                        <div>
                            <h3 class="text-14px medium" style="margin-bottom: 8px;">Leaderboard</h3>
                            <div id="automl-leaderboard" class="table-wrap"></div>
                        </div>

                        <!-- HyperOpt Results -->
                        <div id="automl-hyperopt-result" style="display: none;">
                            <h3 class="text-14px medium" style="margin-bottom: 8px;">Hyperparameter Optimization</h3>
                            <div id="automl-hyperopt-details" style="background: var(--color-grey-600); border-radius: 8px; padding: 12px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Auto-Tune (Quick Mode) -->
            <div class="card" style="margin-top: 16px;">
                <div class="card-header">
                    <h2 class="text-16px medium"><i class="ri-robot-line"></i> Quick Auto-Tune</h2>
                </div>
                <p class="text-14px regular" style="color: var(--color-text-700); margin-bottom: 16px;">
                    Quickly train and rank multiple models without advanced configuration.
                </p>
                <div class="flex-row gap-12 items-center" style="margin-bottom: 16px;">
                    <div class="form-group" style="flex:1;">
                        <label class="form-label">Max Models to Test</label>
                        <input type="number" id="at-max-models" class="input-text-md" value="6" min="2" max="10">
                    </div>
                    <button id="btn-autotune" onclick="startAutoTune()" class="btn-md btn-primary" disabled style="margin-top: 22px;">
                        <i class="ri-robot-line"></i> Start Auto-Tune
                    </button>
                </div>
                <div id="autotune-results"></div>
                <div id="autotune-empty" class="empty-state" style="padding: 20px;">
                    <i class="ri-robot-line"></i>
                    <p class="text-14px regular">Run auto-tune to see model rankings</p>
                </div>
            </div>
        </div>
        <!-- Train Tab (merged: Config + Training + Compare + HyperOpt + Ensemble + Explain) -->
        <div id="tab-train" class="tab-panel">
            <div class="sub-tabs">
                <button class="sub-tab active" onclick="switchSubTab('train', 'setup')" data-subtab="setup">
                    <i class="ri-settings-3-line"></i> Setup
                </button>
                <button class="sub-tab" onclick="switchSubTab('train', 'models')" data-subtab="models">
                    <i class="ri-rocket-line"></i> Models
                </button>
                <button class="sub-tab" onclick="switchSubTab('train', 'compare')" data-subtab="compare">
                    <i class="ri-bar-chart-grouped-line"></i> Compare
                </button>
                <button class="sub-tab" onclick="switchSubTab('train', 'hyperopt')" data-subtab="hyperopt">
                    <i class="ri-flashlight-line"></i> HyperOpt
                </button>
                <button class="sub-tab" onclick="switchSubTab('train', 'ensemble')" data-subtab="ensemble">
                    <i class="ri-stack-line"></i> Ensemble
                </button>
                <button class="sub-tab" onclick="switchSubTab('train', 'explain')" data-subtab="explain">
                    <i class="ri-lightbulb-line"></i> Explain
                </button>
            </div>

            <!-- Sub-panel: Setup (was Config tab) -->
            <div id="sub-setup" class="sub-panel active">
                <div class="card" style="max-width: 600px;">
                    <div class="card-header">
                        <h2 class="text-16px medium">Training Configuration</h2>
                    </div>
                    <div class="form-stack">
                        <div class="form-group">
                            <label class="form-label">Task Type</label>
                            <select id="cfg-taskType" class="input-text-md">
                                <option value="classification">Classification</option>
                                <option value="regression">Regression</option>
                                <option value="clustering">Clustering</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Target Column</label>
                            <div id="cfg-targetColumn-wrap"></div>
                            <input type="hidden" id="cfg-targetColumn" value="">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Feature Columns</label>
                            <span class="form-hint">Select which columns to use as features. All columns are included by default.</span>
                            <div id="cfg-featureColumns-wrap"></div>
                            <div class="feature-select-info">
                                <span id="cfg-featureColumns-count" class="feature-select-count"></span>
                            </div>
                        </div>
                        <hr class="separator">
                        <div class="form-group">
                            <label class="form-label">Preprocessing</label>
                            <div class="grid-2">
                                <div class="form-group">
                                    <label class="form-hint">Scaler</label>
                                    <select id="cfg-scaler" class="input-text-sm">
                                        <option value="none">None</option>
                                        <option value="standard" selected>Standard</option>
                                        <option value="minmax">MinMax</option>
                                        <option value="robust">Robust</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-hint">Missing Values</label>
                                    <select id="cfg-imputation" class="input-text-sm">
                                        <option value="drop">Drop</option>
                                        <option value="mean" selected>Mean</option>
                                        <option value="median">Median</option>
                                        <option value="mode">Mode</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                Cross-Validation Folds: <span id="cv-folds-display" class="mono-14px">5</span>
                            </label>
                            <input type="range" id="cfg-cvFolds" min="2" max="10" value="5" oninput="document.getElementById('cv-folds-display').textContent=this.value">
                        </div>
                        <button id="btn-preprocess" onclick="applyPreprocessing()" class="btn-md btn-primary w-full" disabled>
                            <i class="ri-check-line"></i> Apply Preprocessing
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sub-panel: Models (was Training tab) -->
            <div id="sub-models" class="sub-panel">
                <div class="grid-1-2">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="text-16px medium">Select Models</h2>
                        </div>
                        <div id="model-checkboxes"></div>
                        <button id="btn-train" onclick="startTraining()" class="btn-md btn-primary w-full" style="margin-top: 20px;" disabled>
                            <i class="ri-rocket-line"></i> Start Training
                        </button>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h2 class="text-16px medium">Training Progress</h2>
                        </div>
                        <div id="jobs-list"></div>
                        <div id="jobs-empty" class="empty-state">
                            <i class="ri-flask-line"></i>
                            <p class="text-14px regular">No training jobs yet</p>
                        </div>
                    </div>
                </div>
                <div class="card" style="margin-top: 16px;">
                    <div class="card-header">
                        <h2 class="text-16px medium">Training Metrics</h2>
                    </div>
                    <div id="training-chart-wrap" style="display:none;">
                        <div style="max-height: 300px;">
                            <canvas id="trainingMetricsChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                    <div id="training-chart-empty" class="empty-state" style="padding: 20px;">
                        <i class="ri-bar-chart-2-line"></i>
                        <p class="text-14px regular">Complete training to see metrics visualization</p>
                    </div>
                </div>
                <!-- Live UMAP Visualization (shown during training) -->
                <div id="train-umap-card" class="card" style="margin-top: 16px; display: none;">
                    <div class="card-header">
                        <h2 class="text-16px medium"><i class="ri-scatter-chart-line"></i> Data Projection</h2>
                        <span id="train-umap-badge" class="badge-sm badge-info badge-live" style="display:none;">Live</span>
                    </div>
                    <div id="train-umap-status" style="margin-bottom: 8px;"></div>
                    <div style="max-height: 380px;">
                        <canvas id="trainUmapChart" width="500" height="320"></canvas>
                    </div>
                </div>
            </div>

            <!-- Sub-panel: Compare (was Compare tab) -->
            <div id="sub-compare" class="sub-panel">
                <div class="card">
                    <div class="card-header">
                        <h2 class="text-16px medium">Model Comparison</h2>
                        <button id="btn-compare" onclick="compareAllModels()" class="btn-sm btn-primary" disabled>
                            <i class="ri-bar-chart-grouped-line"></i> Compare All Models
                        </button>
                    </div>
                    <div id="compare-results" style="display:none;">
                        <div class="flex-col gap-24">
                            <div id="compare-table-wrap" class="table-wrap"></div>
                            <div style="max-height: 300px;">
                                <canvas id="comparisonChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div id="compare-empty" class="empty-state">
                        <i class="ri-bar-chart-grouped-line"></i>
                        <p class="text-14px regular">Run a comparison to see results</p>
                    </div>
                </div>
            </div>

            <!-- Sub-panel: HyperOpt (was HyperOpt tab) -->
            <div id="sub-hyperopt" class="sub-panel">
                <div class="grid-1-2">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="text-16px medium">Optimization Config</h2>
                        </div>
                        <div class="form-stack">
                            <div class="form-group">
                                <label class="form-label">Model</label>
                                <select id="ho-model" class="input-text-md">
                                    <option value="random_forest">Random Forest</option>
                                    <option value="xgboost">XGBoost</option>
                                    <option value="lightgbm">LightGBM</option>
                                    <option value="catboost">CatBoost</option>
                                    <option value="gradient_boosting">Gradient Boosting</option>
                                    <option value="extra_trees">Extra Trees</option>
                                    <option value="decision_tree">Decision Tree</option>
                                    <option value="knn">K-Nearest Neighbors</option>
                                    <option value="svm">SVM</option>
                                    <option value="adaboost">AdaBoost</option>
                                    <option value="sgd">SGD</option>
                                    <option value="neural_network">Neural Network</option>
                                    <option value="ridge">Ridge Regression</option>
                                    <option value="lasso">Lasso Regression</option>
                                    <option value="elastic_net">Elastic Net</option>
                                    <option value="polynomial">Polynomial Regression</option>
                                    <option value="gaussian_process">Gaussian Process</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Sampler</label>
                                <select id="ho-sampler" class="input-text-md">
                                    <option value="tpe">TPE (Bayesian)</option>
                                    <option value="random">Random Search</option>
                                    <option value="gp">Gaussian Process</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Number of Trials: <span id="ho-trials-display" class="mono-14px">20</span></label>
                                <input type="range" id="ho-trials" min="5" max="100" value="20" oninput="document.getElementById('ho-trials-display').textContent=this.value">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Timeout (seconds, 0 = none)</label>
                                <input type="number" id="ho-timeout" class="input-text-md" value="0" min="0" step="10">
                            </div>
                            <button id="btn-hyperopt" onclick="startHyperopt()" class="btn-md btn-primary w-full" disabled>
                                <i class="ri-flashlight-line"></i> Start Optimization
                            </button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h2 class="text-16px medium">Optimization Results</h2>
                        </div>
                        <div id="hyperopt-results"></div>
                        <div id="hyperopt-empty" class="empty-state">
                            <i class="ri-flashlight-line"></i>
                            <p class="text-14px regular">Run hyperparameter optimization to see results</p>
                        </div>
                    </div>
                </div>
                <div class="grid-1-2" style="margin-top: 16px;">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="text-16px medium">Search Space</h2>
                        </div>
                        <div id="ho-search-space" class="empty-state">
                            <p class="text-14px regular">Select a model to see its search space</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h2 class="text-16px medium">Convergence</h2>
                        </div>
                        <div style="max-height: 300px;">
                            <canvas id="convergenceChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
                <div class="card" style="margin-top: 16px;">
                    <div class="card-header">
                        <h2 class="text-16px medium">Study History</h2>
                        <button onclick="loadHyperoptHistory()" class="btn-xs btn-ghost"><i class="ri-refresh-line"></i> Refresh</button>
                    </div>
                    <div id="ho-history" class="empty-state">
                        <p class="text-14px regular">No completed studies yet</p>
                    </div>
                </div>
            </div>

            <!-- Sub-panel: Ensemble (was Ensemble tab) -->
            <div id="sub-ensemble" class="sub-panel">
                <div class="grid-1-2">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="text-16px medium">Ensemble Config</h2>
                        </div>
                        <div class="form-stack">
                            <div class="form-group">
                                <label class="form-label">Strategy</label>
                                <select id="ens-strategy" class="input-text-md">
                                    <option value="voting">Voting</option>
                                    <option value="averaging">Averaging</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Select Models</label>
                                <div id="ens-model-checkboxes"></div>
                            </div>
                            <button id="btn-ensemble" onclick="startEnsemble()" class="btn-md btn-primary w-full" disabled>
                                <i class="ri-stack-line"></i> Train Ensemble
                            </button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h2 class="text-16px medium">Ensemble Results</h2>
                        </div>
                        <div id="ensemble-results"></div>
                        <div id="ensemble-empty" class="empty-state">
                            <i class="ri-stack-line"></i>
                            <p class="text-14px regular">Train an ensemble to see results</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sub-panel: Explain (was Explain tab) -->
            <div id="sub-explain" class="sub-panel">
                <div class="section-gap">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="text-16px medium">Feature Importance</h2>
                            <button id="btn-explain" onclick="getFeatureImportance()" class="btn-sm btn-primary" disabled>
                                <i class="ri-lightbulb-line"></i> Analyze
                            </button>
                        </div>
                        <div id="explain-results"></div>
                        <div id="explain-empty" class="empty-state">
                            <i class="ri-lightbulb-line"></i>
                            <p class="text-14px regular">Train a model first, then analyze feature importance</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h2 class="text-16px medium">Feature Importance Chart</h2>
                        </div>
                        <div style="max-height: 400px;">
                            <canvas id="importanceChart" width="400" height="250"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Predict Tab (unchanged) -->
        <div id="tab-predict" class="tab-panel">
            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <h2 class="text-16px medium">Input Data</h2>
                    </div>
                    <div class="form-stack">
                        <textarea id="prediction-input" class="input-textarea" placeholder="Enter values as JSON or comma-separated..."></textarea>
                        <button onclick="makePrediction()" class="btn-md btn-primary w-full">
                            <i class="ri-magic-line"></i> Predict
                        </button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2 class="text-16px medium">Predictions</h2>
                    </div>
                    <div id="prediction-output"></div>
                    <div id="prediction-empty" class="empty-state">
                        <i class="ri-magic-line"></i>
                        <p class="text-14px regular">No predictions yet</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analyze Tab (merged: Anomaly + Clustering) -->
        <div id="tab-analyze" class="tab-panel">
            <div class="section-gap">
                <!-- Anomaly Detection -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="text-16px medium"><i class="ri-error-warning-line"></i> Anomaly Detection</h2>
                        <button id="btn-anomaly" onclick="runAnomalyDetection()" class="btn-sm btn-primary" disabled>
                            <i class="ri-error-warning-line"></i> Detect Anomalies
                        </button>
                    </div>
                    <div class="form-stack" style="margin-bottom: 16px;">
                        <div class="grid-3">
                            <div class="form-group">
                                <label class="form-label">Method</label>
                                <select id="anomaly-method" class="input-text-sm">
                                    <option value="isolation_forest">Isolation Forest</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contamination</label>
                                <input type="number" id="anomaly-contamination" class="input-text-sm" value="0.1" min="0.01" max="0.5" step="0.01">
                                <span class="form-hint">Expected anomaly fraction (0.01–0.5)</span>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Estimators</label>
                                <input type="number" id="anomaly-estimators" class="input-text-sm" value="100" min="10" max="1000" step="10">
                            </div>
                        </div>
                    </div>
                    <div id="anomaly-results"></div>
                    <div id="anomaly-chart-wrap" style="display:none; margin-top: 16px;">
                        <div style="max-height: 250px;">
                            <canvas id="anomalyChart" width="400" height="180"></canvas>
                        </div>
                    </div>
                    <div id="anomaly-empty" class="empty-state">
                        <i class="ri-error-warning-line"></i>
                        <p class="text-14px regular">Load a dataset and run anomaly detection to find outliers</p>
                    </div>
                </div>

                <!-- Clustering -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="text-16px medium"><i class="ri-bubble-chart-line"></i> Clustering</h2>
                        <button id="btn-clustering" onclick="runClustering()" class="btn-sm btn-primary" disabled>
                            <i class="ri-play-line"></i> Run Clustering
                        </button>
                    </div>
                    <div class="form-stack" style="margin-bottom: 16px;">
                        <div class="grid-3">
                            <div class="form-group">
                                <label class="form-label">Algorithm</label>
                                <select id="cluster-algo" class="input-text-sm" onchange="toggleClusterParams()">
                                    <option value="kmeans">KMeans</option>
                                    <option value="dbscan">DBSCAN</option>
                                </select>
                            </div>
                            <div class="form-group" id="cluster-k-group">
                                <label class="form-label">Number of Clusters (k)</label>
                                <input type="number" id="cluster-k" class="input-text-sm" value="3" min="2" max="50">
                            </div>
                            <div class="form-group" id="cluster-eps-group" style="display:none;">
                                <label class="form-label">Epsilon (eps)</label>
                                <input type="number" id="cluster-eps" class="input-text-sm" value="0.5" min="0.01" step="0.1">
                            </div>
                            <div class="form-group" id="cluster-minsamp-group" style="display:none;">
                                <label class="form-label">Min Samples</label>
                                <input type="number" id="cluster-minsamp" class="input-text-sm" value="5" min="1" max="100">
                            </div>
                        </div>
                    </div>
                    <div id="clustering-results"></div>
                    <div id="clustering-chart-wrap" style="display:none; margin-top: 16px;">
                        <div style="max-height: 250px;">
                            <canvas id="clusteringChart" width="400" height="180"></canvas>
                        </div>
                    </div>
                    <div id="clustering-empty" class="empty-state">
                        <i class="ri-bubble-chart-line"></i>
                        <p class="text-14px regular">Load a dataset and run clustering to discover groups in your data</p>
                    </div>
                </div>

                <!-- UMAP Visualization -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="text-16px medium"><i class="ri-scatter-chart-line"></i> UMAP Visualization</h2>
                        <button id="btn-umap" onclick="runUmap()" class="btn-sm btn-primary" disabled>
                            <i class="ri-play-line"></i> Run UMAP
                        </button>
                    </div>
                    <div class="form-stack" style="margin-bottom: 16px;">
                        <div class="grid-3">
                            <div class="form-group">
                                <label class="form-label">Neighbors (k)</label>
                                <input type="number" id="umap-neighbors" class="input-text-sm" value="15" min="2" max="200">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Min Distance</label>
                                <input type="number" id="umap-mindist" class="input-text-sm" value="0.1" min="0.01" max="1.0" step="0.05">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Color By</label>
                                <select id="umap-colorby" class="input-text-sm">
                                    <option value="">None</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div id="umap-results"></div>
                    <div id="umap-chart-wrap" style="display:none; margin-top: 16px;">
                        <div style="max-height: 360px;">
                            <canvas id="umapChart" width="500" height="300"></canvas>
                        </div>
                    </div>
                    <div id="umap-empty" class="empty-state">
                        <i class="ri-scatter-chart-line"></i>
                        <p class="text-14px regular">Load a dataset and run UMAP to visualize high-dimensional data in 2D</p>
                    </div>
                </div>

                <!-- PCA Visualization -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="text-16px medium"><i class="ri-line-chart-line"></i> PCA Visualization</h2>
                        <button id="btn-pca" onclick="runPca()" class="btn-sm btn-primary" disabled>
                            <i class="ri-play-line"></i> Run PCA
                        </button>
                    </div>
                    <div class="form-stack" style="margin-bottom: 16px;">
                        <div class="grid-3">
                            <div class="form-group">
                                <label class="form-label">Scale Features</label>
                                <select id="pca-scale" class="input-text-sm">
                                    <option value="true" selected>Yes (recommended)</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Color By</label>
                                <select id="pca-colorby" class="input-text-sm">
                                    <option value="">None</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Variance</label>
                                <span id="pca-variance" class="mono-12px" style="line-height: 32px; color:var(--color-text-700);">--</span>
                            </div>
                        </div>
                    </div>
                    <div id="pca-results"></div>
                    <div id="pca-chart-wrap" style="display:none; margin-top: 16px;">
                        <div style="max-height: 360px;">
                            <canvas id="pcaChart" width="500" height="300"></canvas>
                        </div>
                    </div>
                    <div id="pca-empty" class="empty-state">
                        <i class="ri-line-chart-line"></i>
                        <p class="text-14px regular">Load a dataset and run PCA for fast linear 2D projection</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Serve Tab: Deploy & API Docs -->
        <div id="tab-serve" class="tab-panel">
            <div class="section-gap">
                <!-- Deployed Models -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="text-16px medium"><i class="ri-server-line"></i> Model Serving</h2>
                        <button onclick="loadServeModels()" class="btn-xs btn-ghost"><i class="ri-refresh-line"></i> Refresh</button>
                    </div>
                    <div id="serve-models-list"></div>
                    <div id="serve-empty" class="empty-state" style="padding: 24px;">
                        <i class="ri-server-line" style="font-size: 28px;"></i>
                        <p class="text-14px regular">No models available</p>
                        <p class="text-12px regular" style="color: var(--color-text-600);">Train a model first, then come back to serve it</p>
                    </div>
                </div>

                <!-- Quick Test -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="text-16px medium"><i class="ri-terminal-box-line"></i> Quick Test</h2>
                    </div>
                    <div class="form-stack">
                        <div class="form-group">
                            <label class="form-label">Model</label>
                            <select id="serve-test-model" class="input-text-md">
                                <option value="">Select a model</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Input (JSON array of arrays)</label>
                            <textarea id="serve-test-input" class="input-textarea" rows="3" placeholder='[[5.1, 3.5, 1.4, 0.2]]'></textarea>
                        </div>
                        <button onclick="serveTestPredict()" class="btn-md btn-primary w-full">
                            <i class="ri-play-line"></i> Send Request
                        </button>
                        <div id="serve-test-result" style="display:none;">
                            <pre id="serve-test-output" class="mono-14px" style="background:var(--color-grey-600);padding:12px;border-radius:8px;overflow-x:auto;white-space:pre-wrap;max-height:200px;"></pre>
                        </div>
                    </div>
                </div>

                <!-- API Reference -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="text-16px medium"><i class="ri-book-open-line"></i> API Reference</h2>
                    </div>
                    <p class="text-12px regular" style="color:var(--color-text-600);margin-bottom:16px;">
                        Base URL: <code id="serve-base-url" class="mono-12px" style="background:var(--color-grey-600);padding:2px 6px;border-radius:4px;"></code>
                    </p>

                    <!-- Predict -->
                    <div class="api-endpoint" style="margin-bottom:20px;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                            <span style="background:#0066F5;color:#fff;font-size:11px;font-weight:600;padding:2px 8px;border-radius:4px;">POST</span>
                            <code class="mono-14px">/api/predict</code>
                        </div>
                        <p class="text-12px regular" style="color:var(--color-text-700);margin-bottom:8px;">Single or multi-row prediction. Uses latest model if <code>model_id</code> is omitted.</p>
                        <div style="background:var(--color-grey-600);border-radius:8px;padding:12px;margin-bottom:8px;">
                            <p class="text-12px medium" style="margin-bottom:4px;">Request</p>
                            <pre class="mono-12px" style="white-space:pre-wrap;">{
  "model_id": "optional-model-id",
  "data": [[5.1, 3.5, 1.4, 0.2], [6.7, 3.0, 5.2, 2.3]]
}</pre>
                        </div>
                        <div style="background:var(--color-grey-600);border-radius:8px;padding:12px;margin-bottom:8px;">
                            <p class="text-12px medium" style="margin-bottom:4px;">Response</p>
                            <pre class="mono-12px" style="white-space:pre-wrap;">{
  "success": true,
  "predictions": [0.0, 2.0],
  "latency_ms": 0.42
}</pre>
                        </div>
                        <div style="background:var(--color-grey-600);border-radius:8px;padding:12px;">
                            <p class="text-12px medium" style="margin-bottom:4px;">cURL</p>
                            <pre class="mono-12px" style="white-space:pre-wrap;">curl -X POST <span class="serve-curl-base">http://localhost:8080</span>/api/predict \
  -H "Content-Type: application/json" \
  -d '{"data": [[5.1, 3.5, 1.4, 0.2]]}'</pre>
                        </div>
                    </div>

                    <!-- Batch Predict -->
                    <div class="api-endpoint" style="margin-bottom:20px;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                            <span style="background:#0066F5;color:#fff;font-size:11px;font-weight:600;padding:2px 8px;border-radius:4px;">POST</span>
                            <code class="mono-14px">/api/predict/batch</code>
                        </div>
                        <p class="text-12px regular" style="color:var(--color-text-700);margin-bottom:8px;">Batch prediction optimized for large payloads (max 10,000 rows).</p>
                        <div style="background:var(--color-grey-600);border-radius:8px;padding:12px;margin-bottom:8px;">
                            <p class="text-12px medium" style="margin-bottom:4px;">Request</p>
                            <pre class="mono-12px" style="white-space:pre-wrap;">{
  "model_id": "optional-model-id",
  "data": [[5.1, 3.5, 1.4, 0.2], [6.7, 3.0, 5.2, 2.3], ...]
}</pre>
                        </div>
                        <div style="background:var(--color-grey-600);border-radius:8px;padding:12px;margin-bottom:8px;">
                            <p class="text-12px medium" style="margin-bottom:4px;">Response</p>
                            <pre class="mono-12px" style="white-space:pre-wrap;">{
  "success": true,
  "predictions": [0.0, 2.0, ...],
  "count": 2,
  "avg_latency_ms": 0.31
}</pre>
                        </div>
                        <div style="background:var(--color-grey-600);border-radius:8px;padding:12px;">
                            <p class="text-12px medium" style="margin-bottom:4px;">cURL</p>
                            <pre class="mono-12px" style="white-space:pre-wrap;">curl -X POST <span class="serve-curl-base">http://localhost:8080</span>/api/predict/batch \
  -H "Content-Type: application/json" \
  -d '{"data": [[5.1, 3.5, 1.4, 0.2], [6.7, 3.0, 5.2, 2.3]]}'</pre>
                        </div>
                    </div>

                    <!-- Predict Probabilities -->
                    <div class="api-endpoint" style="margin-bottom:20px;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                            <span style="background:#0066F5;color:#fff;font-size:11px;font-weight:600;padding:2px 8px;border-radius:4px;">POST</span>
                            <code class="mono-14px">/api/predict/proba</code>
                        </div>
                        <p class="text-12px regular" style="color:var(--color-text-700);margin-bottom:8px;">Returns class probabilities for classification models.</p>
                        <div style="background:var(--color-grey-600);border-radius:8px;padding:12px;margin-bottom:8px;">
                            <p class="text-12px medium" style="margin-bottom:4px;">Request</p>
                            <pre class="mono-12px" style="white-space:pre-wrap;">{
  "model_id": "optional-model-id",
  "data": [[5.1, 3.5, 1.4, 0.2]]
}</pre>
                        </div>
                        <div style="background:var(--color-grey-600);border-radius:8px;padding:12px;margin-bottom:8px;">
                            <p class="text-12px medium" style="margin-bottom:4px;">Response</p>
                            <pre class="mono-12px" style="white-space:pre-wrap;">{
  "success": true,
  "probabilities": [[0.95, 0.03, 0.02]],
  "count": 1
}</pre>
                        </div>
                        <div style="background:var(--color-grey-600);border-radius:8px;padding:12px;">
                            <p class="text-12px medium" style="margin-bottom:4px;">cURL</p>
                            <pre class="mono-12px" style="white-space:pre-wrap;">curl -X POST <span class="serve-curl-base">http://localhost:8080</span>/api/predict/proba \
  -H "Content-Type: application/json" \
  -d '{"data": [[5.1, 3.5, 1.4, 0.2]]}'</pre>
                        </div>
                    </div>

                    <!-- Inference Stats -->
                    <div class="api-endpoint" style="margin-bottom:20px;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                            <span style="background:#3ABC3F;color:#fff;font-size:11px;font-weight:600;padding:2px 8px;border-radius:4px;">GET</span>
                            <code class="mono-14px">/api/predict/stats/{model_id}</code>
                        </div>
                        <p class="text-12px regular" style="color:var(--color-text-700);margin-bottom:8px;">Returns latency percentiles (p50/p95/p99), throughput, and error count for a cached model.</p>
                        <div style="background:var(--color-grey-600);border-radius:8px;padding:12px;margin-bottom:8px;">
                            <p class="text-12px medium" style="margin-bottom:4px;">Response</p>
                            <pre class="mono-12px" style="white-space:pre-wrap;">{
  "success": true,
  "model_id": "abc123",
  "stats": {
    "total_predictions": 1042,
    "avg_latency_ms": 0.38,
    "p50_latency_ms": 0.32,
    "p95_latency_ms": 0.71,
    "p99_latency_ms": 1.20,
    "throughput_per_sec": 2631.5,
    "error_count": 0
  }
}</pre>
                        </div>
                        <div style="background:var(--color-grey-600);border-radius:8px;padding:12px;">
                            <p class="text-12px medium" style="margin-bottom:4px;">cURL</p>
                            <pre class="mono-12px" style="white-space:pre-wrap;">curl <span class="serve-curl-base">http://localhost:8080</span>/api/predict/stats/MODEL_ID</pre>
                        </div>
                    </div>

                    <!-- List Models -->
                    <div class="api-endpoint" style="margin-bottom:20px;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                            <span style="background:#3ABC3F;color:#fff;font-size:11px;font-weight:600;padding:2px 8px;border-radius:4px;">GET</span>
                            <code class="mono-14px">/api/models</code>
                        </div>
                        <p class="text-12px regular" style="color:var(--color-text-700);margin-bottom:8px;">List all trained models.</p>
                        <div style="background:var(--color-grey-600);border-radius:8px;padding:12px;">
                            <p class="text-12px medium" style="margin-bottom:4px;">cURL</p>
                            <pre class="mono-12px" style="white-space:pre-wrap;">curl <span class="serve-curl-base">http://localhost:8080</span>/api/models</pre>
                        </div>
                    </div>

                    <!-- Get Model -->
                    <div class="api-endpoint" style="margin-bottom:20px;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                            <span style="background:#3ABC3F;color:#fff;font-size:11px;font-weight:600;padding:2px 8px;border-radius:4px;">GET</span>
                            <code class="mono-14px">/api/models/{model_id}</code>
                        </div>
                        <p class="text-12px regular" style="color:var(--color-text-700);margin-bottom:8px;">Get details of a specific model (metrics, config, creation date).</p>
                        <div style="background:var(--color-grey-600);border-radius:8px;padding:12px;">
                            <p class="text-12px medium" style="margin-bottom:4px;">cURL</p>
                            <pre class="mono-12px" style="white-space:pre-wrap;">curl <span class="serve-curl-base">http://localhost:8080</span>/api/models/MODEL_ID</pre>
                        </div>
                    </div>

                    <!-- Download Model -->
                    <div class="api-endpoint" style="margin-bottom:20px;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                            <span style="background:#3ABC3F;color:#fff;font-size:11px;font-weight:600;padding:2px 8px;border-radius:4px;">GET</span>
                            <code class="mono-14px">/api/models/{model_id}/download</code>
                        </div>
                        <p class="text-12px regular" style="color:var(--color-text-700);margin-bottom:8px;">Download a trained model as a JSON file.</p>
                        <div style="background:var(--color-grey-600);border-radius:8px;padding:12px;">
                            <p class="text-12px medium" style="margin-bottom:4px;">cURL</p>
                            <pre class="mono-12px" style="white-space:pre-wrap;">curl -O <span class="serve-curl-base">http://localhost:8080</span>/api/models/MODEL_ID/download</pre>
                        </div>
                    </div>

                    <!-- Delete Model -->
                    <div class="api-endpoint" style="margin-bottom:20px;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                            <span style="background:#FF3131;color:#fff;font-size:11px;font-weight:600;padding:2px 8px;border-radius:4px;">DELETE</span>
                            <code class="mono-14px">/api/models/{model_id}</code>
                        </div>
                        <p class="text-12px regular" style="color:var(--color-text-700);margin-bottom:8px;">Delete a model from the server.</p>
                        <div style="background:var(--color-grey-600);border-radius:8px;padding:12px;">
                            <p class="text-12px medium" style="margin-bottom:4px;">cURL</p>
                            <pre class="mono-12px" style="white-space:pre-wrap;">curl -X DELETE <span class="serve-curl-base">http://localhost:8080</span>/api/models/MODEL_ID</pre>
                        </div>
                    </div>

                    <!-- Evict Cache -->
                    <div class="api-endpoint" style="margin-bottom:20px;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                            <span style="background:#FF3131;color:#fff;font-size:11px;font-weight:600;padding:2px 8px;border-radius:4px;">DELETE</span>
                            <code class="mono-14px">/api/predict/cache/{model_id}</code>
                        </div>
                        <p class="text-12px regular" style="color:var(--color-text-700);margin-bottom:8px;">Evict a model from the inference cache to free memory.</p>
                        <div style="background:var(--color-grey-600);border-radius:8px;padding:12px;">
                            <p class="text-12px medium" style="margin-bottom:4px;">cURL</p>
                            <pre class="mono-12px" style="white-space:pre-wrap;">curl -X DELETE <span class="serve-curl-base">http://localhost:8080</span>/api/predict/cache/MODEL_ID</pre>
                        </div>
                    </div>

                    <!-- Health -->
                    <div class="api-endpoint">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                            <span style="background:#3ABC3F;color:#fff;font-size:11px;font-weight:600;padding:2px 8px;border-radius:4px;">GET</span>
                            <code class="mono-14px">/api/health</code>
                        </div>
                        <p class="text-12px regular" style="color:var(--color-text-700);margin-bottom:8px;">Health check — use for readiness probes.</p>
                        <div style="background:var(--color-grey-600);border-radius:8px;padding:12px;">
                            <p class="text-12px medium" style="margin-bottom:4px;">cURL</p>
                            <pre class="mono-12px" style="white-space:pre-wrap;">curl <span class="serve-curl-base">http://localhost:8080</span>/api/health</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Tab (merged: Monitor + Security + Drift) -->
        <div id="tab-system" class="tab-panel">
            <div class="section-gap">
                <!-- System Stats -->
                <div class="grid-3">
                    <div class="card" style="text-align:center;">
                        <p class="text-12px medium" style="color: var(--color-text-700); margin-bottom: 8px;">CPU Usage</p>
                        <div style="width:120px;height:120px;margin:0 auto 8px;">
                            <canvas id="cpuGaugeChart" width="120" height="120"></canvas>
                        </div>
                        <p id="mon-cpu" class="mono-20px medium" style="color:var(--color-information-500);">0.0%</p>
                    </div>
                    <div class="card" style="text-align:center;">
                        <p class="text-12px medium" style="color: var(--color-text-700); margin-bottom: 8px;">Memory Usage</p>
                        <div style="width:120px;height:120px;margin:0 auto 8px;">
                            <canvas id="memGaugeChart" width="120" height="120"></canvas>
                        </div>
                        <p id="mon-mem" class="mono-20px medium" style="color:var(--color-success-500);">0.0%</p>
                        <p id="mon-mem-detail" class="text-12px regular" style="color: var(--color-text-600); margin-top: 4px;">0.0 / 0.0 GB</p>
                    </div>
                    <div class="card" style="text-align:center;">
                        <p class="text-12px medium" style="color: var(--color-text-700); margin-bottom: 8px;">Status</p>
                        <div style="width:120px;height:120px;margin:0 auto 8px;display:flex;align-items:center;justify-content:center;">
                            <div id="status-ring" style="width:80px;height:80px;border-radius:50%;border:6px solid var(--color-success-500);display:flex;align-items:center;justify-content:center;">
                                <i id="status-icon" class="ri-check-line" style="font-size:32px;color:var(--color-success-500);"></i>
                            </div>
                        </div>
                        <p id="mon-status" class="mono-20px medium" style="color:var(--color-success-500);">healthy</p>
                    </div>
                </div>

                <!-- System Overview -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="text-16px medium">System Overview</h2>
                        <button onclick="refreshSystemStatus()" class="btn-xs btn-ghost"><i class="ri-refresh-line"></i> Refresh</button>
                    </div>
                    <div class="grid-3" style="text-align: center;">
                        <div>
                            <p id="mon-datasets" class="mono-32px medium">0</p>
                            <p class="text-12px regular" style="color: var(--color-text-700);">Datasets</p>
                        </div>
                        <div>
                            <p id="mon-jobs" class="mono-32px medium">0</p>
                            <p class="text-12px regular" style="color: var(--color-text-700);">Jobs</p>
                        </div>
                        <div>
                            <p id="mon-models" class="mono-32px medium">0</p>
                            <p class="text-12px regular" style="color: var(--color-text-700);">Models</p>
                        </div>
                    </div>
                </div>

                <!-- Device + Alerts -->
                <div class="grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="text-16px medium">Device Info</h2>
                            <button onclick="loadDeviceInfo()" class="btn-xs btn-ghost"><i class="ri-cpu-line"></i> Refresh</button>
                        </div>
                        <div id="device-info">
                            <div class="loading-overlay"><div class="spinner"></div><p class="text-12px regular">Loading device info...</p></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h2 class="text-16px medium">Alerts</h2>
                        </div>
                        <div id="alerts-list">
                            <div class="empty-state" style="padding: 20px;">
                                <i class="ri-notification-line"></i>
                                <p class="text-12px regular">No alerts</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="text-16px medium">Performance</h2>
                    </div>
                    <div id="perf-stats" class="grid-3" style="text-align: center;">
                        <div>
                            <p id="perf-completed" class="mono-20px medium">0</p>
                            <p class="text-12px regular" style="color: var(--color-text-700);">Completed</p>
                        </div>
                        <div>
                            <p id="perf-failed" class="mono-20px medium" style="color: var(--color-danger-500);">0</p>
                            <p class="text-12px regular" style="color: var(--color-text-700);">Failed</p>
                        </div>
                        <div>
                            <p id="perf-throughput" class="mono-20px medium">0</p>
                            <p class="text-12px regular" style="color: var(--color-text-700);">Models/min</p>
                        </div>
                    </div>
                </div>

                <!-- Security Overview -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="text-16px medium"><i class="ri-shield-check-line"></i> Security Overview</h2>
                        <button class="btn-xs btn-ghost" onclick="loadSecurityStatus()">
                            <i class="ri-refresh-line"></i> Refresh
                        </button>
                    </div>
                    <div id="security-status" class="card-body">
                        <div class="skeleton" style="height: 120px;"></div>
                    </div>
                </div>

                <!-- Guards & Rate Limiting side by side -->
                <div class="grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="text-16px medium"><i class="ri-lock-line"></i> Active Guards</h2>
                        </div>
                        <div id="security-guards" class="card-body">
                            <div class="skeleton" style="height: 100px;"></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h2 class="text-16px medium"><i class="ri-speed-line"></i> Rate Limiting</h2>
                        </div>
                        <div id="rate-limit-stats" class="card-body">
                            <div class="skeleton" style="height: 80px;"></div>
                        </div>
                    </div>
                </div>

                <!-- Audit Log -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="text-16px medium"><i class="ri-file-list-3-line"></i> Audit Log</h2>
                        <button class="btn-xs btn-ghost" onclick="loadAuditLog()">
                            <i class="ri-refresh-line"></i> Refresh
                        </button>
                    </div>
                    <div id="audit-log" class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <div class="skeleton" style="height: 200px;"></div>
                    </div>
                </div>

                <!-- Drift (API info) -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="text-16px medium"><i class="ri-git-branch-line"></i> Data Drift Detection</h2>
                    </div>
                    <div class="empty-state" style="padding: 20px;">
                        <i class="ri-git-branch-line"></i>
                        <p class="text-14px regular">Drift detection compares a reference dataset against new data</p>
                        <p class="text-12px regular" style="color: var(--color-text-600);">Use the API endpoint <code>POST /api/drift/detect</code> with reference and test data arrays</p>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Toast Notifications -->
    <div id="toast-container" class="toast-container"></div>

    <script>
        // ── State ──
        var dataInfo = null;
        var dataPreview = { rows: 0, columns: [] };
        var trainingJobs = [];
        var pollJobsIntervalId = null;
        var comparisonResults = [];
        var selectedModels = [];
        var comparisonChartInstance = null;
        var convergenceChartInstance = null;
        var autotuneJobId = null;
        var columnTypesChartInstance = null;
        var trainingMetricsChartInstance = null;
        var anomalyChartInstance = null;
        var clusteringChartInstance = null;
        var umapChartInstance = null;
        var trainUmapChartInstance = null;
        var pcaChartInstance = null;
        var cpuGaugeInstance = null;
        var memGaugeInstance = null;

        var sampleDatasets = [
            { id: 'iris', name: 'Iris' },
            { id: 'diabetes', name: 'Diabetes' },
            { id: 'boston', name: 'Boston' },
            { id: 'wine', name: 'Wine' },
            { id: 'breast_cancer', name: 'Breast Cancer' }
        ];

        var availableModels = [
            { id: 'logistic_regression', name: 'Logistic Regression', task: 'classification' },
            { id: 'naive_bayes', name: 'Naive Bayes', task: 'classification' },
            { id: 'adaboost', name: 'AdaBoost', task: 'classification' },
            { id: 'linear_regression', name: 'Linear Regression', task: 'regression' },
            { id: 'ridge', name: 'Ridge Regression', task: 'regression' },
            { id: 'lasso', name: 'Lasso Regression', task: 'regression' },
            { id: 'elastic_net', name: 'Elastic Net', task: 'regression' },
            { id: 'polynomial', name: 'Polynomial Regression', task: 'regression' },
            { id: 'decision_tree', name: 'Decision Tree', task: 'both' },
            { id: 'random_forest', name: 'Random Forest', task: 'both' },
            { id: 'gradient_boosting', name: 'Gradient Boosting', task: 'both' },
            { id: 'xgboost', name: 'XGBoost', task: 'both' },
            { id: 'lightgbm', name: 'LightGBM', task: 'both' },
            { id: 'catboost', name: 'CatBoost', task: 'both' },
            { id: 'extra_trees', name: 'Extra Trees', task: 'both' },
            { id: 'sgd', name: 'SGD', task: 'both' },
            { id: 'knn', name: 'K-Nearest Neighbors', task: 'both' },
            { id: 'svm', name: 'SVM', task: 'both' },
            { id: 'neural_network', name: 'Neural Network', task: 'both' },
            { id: 'gaussian_process', name: 'Gaussian Process', task: 'both' },
            { id: 'kmeans', name: 'KMeans Clustering', task: 'clustering' },
            { id: 'dbscan', name: 'DBSCAN Clustering', task: 'clustering' }
        ];

        // ── Helpers ──
        function $(id) { return document.getElementById(id); }

        function notify(message, type) {
            type = type || 'info';
            var container = $('toast-container');
            var toast = document.createElement('div');
            toast.className = 'toast toast-' + type;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(function() {
                toast.classList.add('removing');
                setTimeout(function() { toast.remove(); }, 250);
            }, 3000);
        }

        function escHtml(s) {
            var d = document.createElement('div');
            d.textContent = s;
            return d.innerHTML;
        }
        function escAttr(s) {
            return String(s).replace(/&/g,'&amp;').replace(/'/g,'&#39;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        }

        function animateCount(el, endValue, duration, suffix, decimals) {
            if (!el) return;
            duration = duration || 800;
            suffix = suffix || '';
            decimals = decimals || 0;
            var startValue = parseFloat(el.textContent) || 0;
            var startTime = null;
            function easeOutCubic(t) { return 1 - Math.pow(1 - t, 3); }
            function step(timestamp) {
                if (!startTime) startTime = timestamp;
                var progress = Math.min((timestamp - startTime) / duration, 1);
                var eased = easeOutCubic(progress);
                var current = startValue + (endValue - startValue) * eased;
                el.textContent = current.toFixed(decimals) + suffix;
                if (progress < 1) requestAnimationFrame(step);
            }
            requestAnimationFrame(step);
        }

        // ── Tabs ──
        function switchTab(name) {
            var panels = document.querySelectorAll('.tab-panel');
            for (var i = 0; i < panels.length; i++) panels[i].classList.remove('active');
            var tabs = document.querySelectorAll('.nav-tab');
            for (var i = 0; i < tabs.length; i++) tabs[i].classList.remove('active');
            $('tab-' + name).classList.add('active');
            document.querySelector('[data-tab="' + name + '"]').classList.add('active');
            var appContent = document.querySelector('.app-content');
            if (appContent) appContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
            if (name === 'serve') loadServeModels();
            if (name === 'system') {
                refreshSystemStatus();
                loadDeviceInfo();
                loadAlerts();
                loadPerformanceStats();
                loadSecurityStatus();
                loadRateLimitStats();
                loadAuditLog();
            }
        }

        function switchSubTab(parentTab, name) {
            var parent = $('tab-' + parentTab);
            if (!parent) return;
            var panels = parent.querySelectorAll('.sub-panel');
            for (var i = 0; i < panels.length; i++) panels[i].classList.remove('active');
            var tabs = parent.querySelectorAll('.sub-tab');
            for (var i = 0; i < tabs.length; i++) tabs[i].classList.remove('active');
            var panel = $('sub-' + name);
            if (panel) panel.classList.add('active');
            var tab = parent.querySelector('[data-subtab="' + name + '"]');
            if (tab) tab.classList.add('active');
        }

        // ── File Upload ──
        function setupDropzone() {
            var dz = $('dropzone');
            var fi = $('fileInput');
            dz.addEventListener('click', function() { fi.click(); });
            dz.addEventListener('dragover', function(e) { e.preventDefault(); dz.classList.add('drag-over'); });
            dz.addEventListener('dragleave', function() { dz.classList.remove('drag-over'); });
            dz.addEventListener('drop', function(e) {
                e.preventDefault();
                dz.classList.remove('drag-over');
                var file = e.dataTransfer.files[0];
                if (file) uploadFile(file);
            });
            fi.addEventListener('change', function(e) {
                if (e.target.files[0]) uploadFile(e.target.files[0]);
            });
        }

        function uploadFile(file) {
            var formData = new FormData();
            formData.append('file', file);
            fetch('/api/data/upload', { method: 'POST', body: formData })
                .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
                .then(function(data) {
                    if (data.success) {
                        dataInfo = data;
                        updateDataUI();
                        refreshPreview();
                        notify('Data uploaded successfully!', 'success');
                    } else {
                        notify(data.message || 'Upload failed', 'error');
                    }
                })
                .catch(function(e) { notify('Upload failed: ' + e.message, 'error'); });
        }

        // ── Sample Datasets ──
        function setupSamplePills() {
            var container = $('sample-pills');
            sampleDatasets.forEach(function(s) {
                var btn = document.createElement('button');
                btn.className = 'pill';
                btn.textContent = s.name;
                btn.onclick = function() { loadSampleData(s.id); };
                container.appendChild(btn);
            });
        }

        function loadSampleData(name) {
            fetch('/api/data/sample/' + name)
                .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
                .then(function(data) {
                    if (data.success) {
                        dataInfo = data;
                        updateDataUI();
                        refreshPreview();
                        notify('Loaded ' + name + ' dataset!', 'success');
                    }
                })
                .catch(function(e) { notify('Failed to load sample: ' + e.message, 'error'); });
        }

        // ── Data UI Updates ──
        function updateDataUI() {
            if (dataInfo) {
                $('data-meta').style.display = '';
                $('data-rows').textContent = dataInfo.rows || 0;
                $('data-cols').textContent = dataInfo.columns || 0;
                $('preview-empty').style.display = 'none';
                $('btn-preprocess').disabled = false;
                $('btn-anomaly').disabled = false;
                $('btn-clustering').disabled = false;
                $('btn-umap').disabled = false;
                $('btn-pca').disabled = false;
                // Populate UMAP and PCA color-by dropdowns
                if (dataInfo && dataInfo.column_names) {
                    var sel = $('umap-colorby');
                    sel.innerHTML = '<option value="">None</option>';
                    var selPca = $('pca-colorby');
                    selPca.innerHTML = '<option value="">None</option>';
                    for (var ci = 0; ci < dataInfo.column_names.length; ci++) {
                        sel.innerHTML += '<option value="' + escAttr(dataInfo.column_names[ci]) + '">' + escHtml(dataInfo.column_names[ci]) + '</option>';
                        selPca.innerHTML += '<option value="' + escAttr(dataInfo.column_names[ci]) + '">' + escHtml(dataInfo.column_names[ci]) + '</option>';
                    }
                }
                updateTargetOptions();
                updateAutoMLTargetColumns();
                updateTrainButton();
                $('btn-compare').disabled = !getConfig().targetColumn;
                // Auto-run UMAP on data load for instant 2D overview
                if (dataInfo.rows >= 3 && dataInfo.columns >= 2) {
                    setTimeout(function() { runUmap(); }, 200);
                }
            }
        }

        // ── Column Select Components ──
        var targetColumnSelect = null;
        var featureColumnSelect = null;
        var automlTargetSelect = null;
        var selectedFeatureColumns = [];

        function getColumnDtype(colName) {
            if (!dataPreview || !dataPreview.columns) return '';
            var col = dataPreview.columns.find(function(c) { return c.name === colName; });
            return col ? (col.dtype || '') : '';
        }

        function getColumnIcon(dtype) {
            if (!dtype) return 'ri-hashtag';
            var d = dtype.toLowerCase();
            if (d.indexOf('int') !== -1 || d.indexOf('float') !== -1 || d.indexOf('num') !== -1) return 'ri-hashtag';
            if (d.indexOf('bool') !== -1) return 'ri-toggle-line';
            if (d.indexOf('date') !== -1 || d.indexOf('time') !== -1) return 'ri-calendar-line';
            return 'ri-text';
        }

        function createColumnSelect(container, hiddenInput, opts) {
            var selectedValue = opts.value || '';
            var placeholder = opts.placeholder || 'Select column...';
            var columns = opts.columns || [];
            var onChange = opts.onChange || function() {};

            container.innerHTML = '';
            var wrap = document.createElement('div');
            wrap.className = 'column-select';

            var trigger = document.createElement('div');
            trigger.className = 'column-select-trigger';
            var valueSpan = document.createElement('span');
            valueSpan.className = 'column-select-value' + (selectedValue ? '' : ' placeholder');
            valueSpan.textContent = selectedValue || placeholder;
            var clearBtn = document.createElement('span');
            clearBtn.className = 'column-select-clear';
            clearBtn.innerHTML = '&times;';
            clearBtn.style.display = selectedValue ? '' : 'none';
            var arrow = document.createElement('i');
            arrow.className = 'ri-arrow-down-s-line column-select-arrow';
            trigger.appendChild(valueSpan);
            trigger.appendChild(clearBtn);
            trigger.appendChild(arrow);

            var dropdown = document.createElement('div');
            dropdown.className = 'column-select-dropdown';
            var searchWrap = document.createElement('div');
            searchWrap.className = 'column-select-search';
            var searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.placeholder = 'Search columns...';
            searchWrap.appendChild(searchInput);

            var optionsDiv = document.createElement('div');
            optionsDiv.className = 'column-select-options';

            dropdown.appendChild(searchWrap);
            dropdown.appendChild(optionsDiv);
            wrap.appendChild(trigger);
            wrap.appendChild(dropdown);
            container.appendChild(wrap);

            function setValue(val) {
                selectedValue = val;
                hiddenInput.value = val;
                valueSpan.textContent = val || placeholder;
                valueSpan.className = 'column-select-value' + (val ? '' : ' placeholder');
                clearBtn.style.display = val ? '' : 'none';
                onChange(val);
            }

            function renderOptions() {
                var query = searchInput.value.toLowerCase();
                optionsDiv.innerHTML = '';
                var filtered = columns.filter(function(n) { return n.toLowerCase().indexOf(query) !== -1; });
                if (filtered.length === 0) {
                    var empty = document.createElement('div');
                    empty.className = 'column-select-empty';
                    empty.textContent = query ? 'No columns match "' + query + '"' : 'No columns available';
                    optionsDiv.appendChild(empty);
                    return;
                }
                filtered.forEach(function(colName) {
                    var opt = document.createElement('div');
                    opt.className = 'column-select-option' + (colName === selectedValue ? ' selected' : '');
                    var icon = document.createElement('i');
                    var dtype = getColumnDtype(colName);
                    icon.className = getColumnIcon(dtype) + ' col-icon';
                    var name = document.createElement('span');
                    name.textContent = colName;
                    opt.appendChild(icon);
                    opt.appendChild(name);
                    if (dtype) {
                        var dtypeSpan = document.createElement('span');
                        dtypeSpan.className = 'col-dtype';
                        dtypeSpan.textContent = dtype;
                        opt.appendChild(dtypeSpan);
                    }
                    opt.onclick = function(e) {
                        e.stopPropagation();
                        setValue(colName);
                        wrap.classList.remove('open');
                    };
                    optionsDiv.appendChild(opt);
                });
            }

            trigger.onclick = function(e) {
                e.stopPropagation();
                var isOpen = wrap.classList.contains('open');
                closeAllColumnSelects();
                closeAllMultiselects();
                if (!isOpen) {
                    wrap.classList.add('open');
                    searchInput.value = '';
                    renderOptions();
                    searchInput.focus();
                }
            };

            clearBtn.onclick = function(e) {
                e.stopPropagation();
                setValue('');
            };

            searchInput.oninput = function() { renderOptions(); };
            searchInput.onclick = function(e) { e.stopPropagation(); };

            return {
                setValue: setValue,
                getValue: function() { return selectedValue; },
                setColumns: function(cols) {
                    columns = cols;
                    if (selectedValue && cols.indexOf(selectedValue) === -1) {
                        setValue('');
                    }
                    renderOptions();
                }
            };
        }

        function closeAllColumnSelects() {
            document.querySelectorAll('.column-select.open').forEach(function(el) {
                el.classList.remove('open');
            });
        }

        function createFeatureColumnSelect(container, opts) {
            var selected = opts.selected || [];
            var columns = opts.columns || [];
            var placeholder = opts.placeholder || 'All columns included';
            var onChange = opts.onChange || function() {};

            container.innerHTML = '';
            var wrap = document.createElement('div');
            wrap.className = 'multiselect';

            var trigger = document.createElement('div');
            trigger.className = 'multiselect-trigger';
            var tagsDiv = document.createElement('div');
            tagsDiv.className = 'multiselect-tags';
            var arrow = document.createElement('i');
            arrow.className = 'ri-arrow-down-s-line multiselect-arrow';
            trigger.appendChild(tagsDiv);
            trigger.appendChild(arrow);

            var dropdown = document.createElement('div');
            dropdown.className = 'multiselect-dropdown';

            var searchWrap = document.createElement('div');
            searchWrap.className = 'multiselect-search';
            var searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.placeholder = 'Search columns...';
            searchWrap.appendChild(searchInput);

            var actionsWrap = document.createElement('div');
            actionsWrap.className = 'multiselect-actions';
            var btnAll = document.createElement('button');
            btnAll.textContent = 'Select All';
            btnAll.type = 'button';
            var btnNone = document.createElement('button');
            btnNone.textContent = 'Clear';
            btnNone.type = 'button';
            actionsWrap.appendChild(btnAll);
            actionsWrap.appendChild(btnNone);

            var optionsDiv = document.createElement('div');
            optionsDiv.className = 'multiselect-options';

            dropdown.appendChild(searchWrap);
            dropdown.appendChild(actionsWrap);
            dropdown.appendChild(optionsDiv);
            wrap.appendChild(trigger);
            wrap.appendChild(dropdown);
            container.appendChild(wrap);

            function renderTags() {
                tagsDiv.innerHTML = '';
                if (selected.length === 0 || selected.length === columns.length) {
                    var ph = document.createElement('span');
                    ph.className = 'multiselect-placeholder';
                    ph.textContent = placeholder;
                    tagsDiv.appendChild(ph);
                } else if (selected.length > 3) {
                    var countTag = document.createElement('span');
                    countTag.className = 'multiselect-tag';
                    countTag.textContent = selected.length + ' columns selected';
                    tagsDiv.appendChild(countTag);
                } else {
                    selected.forEach(function(colName) {
                        var tag = document.createElement('span');
                        tag.className = 'multiselect-tag';
                        tag.textContent = colName;
                        var rm = document.createElement('span');
                        rm.className = 'multiselect-tag-remove';
                        rm.innerHTML = '&times;';
                        rm.onclick = function(e) {
                            e.stopPropagation();
                            selected = selected.filter(function(x) { return x !== colName; });
                            renderTags();
                            renderOptions();
                            updateCount();
                            onChange(selected);
                        };
                        tag.appendChild(rm);
                        tagsDiv.appendChild(tag);
                    });
                }
            }

            function renderOptions() {
                var query = searchInput.value.toLowerCase();
                optionsDiv.innerHTML = '';
                var filtered = columns.filter(function(n) { return n.toLowerCase().indexOf(query) !== -1; });
                if (filtered.length === 0) {
                    var empty = document.createElement('div');
                    empty.className = 'column-select-empty';
                    empty.textContent = 'No columns match "' + query + '"';
                    optionsDiv.appendChild(empty);
                    return;
                }
                filtered.forEach(function(colName) {
                    var opt = document.createElement('div');
                    opt.className = 'multiselect-option' + (selected.indexOf(colName) !== -1 ? ' selected' : '');
                    var check = document.createElement('span');
                    check.className = 'ms-check';
                    var icon = document.createElement('i');
                    var dtype = getColumnDtype(colName);
                    icon.className = getColumnIcon(dtype) + ' col-icon';
                    icon.style.fontSize = '13px';
                    icon.style.color = 'var(--color-text-600)';
                    icon.style.width = '14px';
                    var name = document.createElement('span');
                    name.textContent = colName;
                    name.style.flex = '1';
                    opt.appendChild(check);
                    opt.appendChild(icon);
                    opt.appendChild(name);
                    if (dtype) {
                        var dtypeSpan = document.createElement('span');
                        dtypeSpan.className = 'col-dtype';
                        dtypeSpan.textContent = dtype;
                        opt.appendChild(dtypeSpan);
                    }
                    opt.onclick = function(e) {
                        e.stopPropagation();
                        if (selected.indexOf(colName) !== -1) {
                            selected = selected.filter(function(x) { return x !== colName; });
                        } else {
                            selected.push(colName);
                        }
                        renderTags();
                        renderOptions();
                        updateCount();
                        onChange(selected);
                    };
                    optionsDiv.appendChild(opt);
                });
            }

            function updateCount() {
                var countEl = $('cfg-featureColumns-count');
                if (countEl) {
                    if (selected.length === 0 || selected.length === columns.length) {
                        countEl.innerHTML = 'Using all <strong>' + columns.length + '</strong> columns as features';
                    } else {
                        countEl.innerHTML = '<strong>' + selected.length + '</strong> of <strong>' + columns.length + '</strong> columns selected';
                    }
                }
            }

            trigger.onclick = function(e) {
                e.stopPropagation();
                var isOpen = wrap.classList.contains('open');
                closeAllMultiselects();
                closeAllColumnSelects();
                if (!isOpen) {
                    wrap.classList.add('open');
                    searchInput.value = '';
                    renderOptions();
                    searchInput.focus();
                }
            };

            searchInput.oninput = function() { renderOptions(); };
            searchInput.onclick = function(e) { e.stopPropagation(); };

            btnAll.onclick = function(e) {
                e.stopPropagation();
                var query = searchInput.value.toLowerCase();
                columns.forEach(function(n) {
                    if (n.toLowerCase().indexOf(query) !== -1 && selected.indexOf(n) === -1) {
                        selected.push(n);
                    }
                });
                renderTags();
                renderOptions();
                updateCount();
                onChange(selected);
            };

            btnNone.onclick = function(e) {
                e.stopPropagation();
                selected.length = 0;
                renderTags();
                renderOptions();
                updateCount();
                onChange(selected);
            };

            renderTags();
            updateCount();

            return {
                getSelected: function() { return selected.slice(); },
                setColumns: function(cols, targetCol) {
                    columns = cols.filter(function(c) { return c !== targetCol; });
                    selected = columns.slice();
                    renderTags();
                    renderOptions();
                    updateCount();
                    onChange(selected);
                }
            };
        }

        function updateTargetOptions(columns) {
            var names = columns || (dataInfo && dataInfo.column_names) || [];
            targetColumnSelect = createColumnSelect(
                $('cfg-targetColumn-wrap'),
                $('cfg-targetColumn'),
                {
                    columns: names,
                    placeholder: 'Select target...',
                    onChange: function(val) {
                        updateTrainButton();
                        $('btn-compare').disabled = !val;
                        if ($('btn-hyperopt')) $('btn-hyperopt').disabled = !val;
                        if ($('btn-autotune')) $('btn-autotune').disabled = !val;
                        if ($('btn-ensemble')) $('btn-ensemble').disabled = ensembleSelectedModels.length < 2 || !val;
                        if ($('btn-explain')) $('btn-explain').disabled = !val;
                        // Update feature columns to exclude target
                        if (featureColumnSelect) {
                            featureColumnSelect.setColumns(names, val);
                        }
                    }
                }
            );
            // Initialize feature column select
            featureColumnSelect = createFeatureColumnSelect(
                $('cfg-featureColumns-wrap'),
                {
                    columns: names,
                    selected: names.slice(),
                    placeholder: 'All columns included',
                    onChange: function(sel) {
                        selectedFeatureColumns = sel;
                    }
                }
            );
            selectedFeatureColumns = names.slice();
        }

        function refreshPreview() {
            fetch('/api/data/preview?rows=10')
                .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
                .then(function(data) {
                    dataPreview = data;
                    renderPreviewTable();
                    renderDataSummary();
                })
                .catch(function(e) { console.error('Preview failed:', e); });
        }

        function renderPreviewTable() {
            var cols = dataPreview.columns || [];
            var rows = dataPreview.rows || 0;
            if (cols.length === 0) { $('preview-table').style.display = 'none'; return; }

            var html = '<div class="table-wrap"><table class="data-table"><thead><tr>';
            cols.forEach(function(c) { html += '<th>' + escHtml(c.name) + (c.dtype ? ' <span class="badge-sm badge-information" style="display:inline-flex;vertical-align:middle;margin-left:4px;font-size:10px;height:18px;">' + escHtml(c.dtype) + '</span>' : '') + '</th>'; });
            html += '</tr></thead><tbody>';
            for (var r = 0; r < rows; r++) {
                html += '<tr>';
                cols.forEach(function(c) {
                    var val = (c.values && c.values[r] != null) ? c.values[r] : '';
                    html += '<td>' + escHtml(String(val)) + '</td>';
                });
                html += '</tr>';
            }
            html += '</tbody></table></div>';
            $('preview-table').innerHTML = html;
            $('preview-table').style.display = '';
        }

        // ── Config ──
        function getConfig() {
            var allCols = (dataInfo && dataInfo.column_names) || [];
            var featureCols = featureColumnSelect ? featureColumnSelect.getSelected() : [];
            // Only include feature_columns if user has deselected some
            var includeFeatures = featureCols.length > 0 && featureCols.length < allCols.length;
            return {
                taskType: $('cfg-taskType').value,
                targetColumn: $('cfg-targetColumn').value,
                featureColumns: includeFeatures ? featureCols : null,
                scaler: $('cfg-scaler').value,
                imputation: $('cfg-imputation').value,
                cvFolds: parseInt($('cfg-cvFolds').value)
            };
        }

        function applyPreprocessing() {
            var cfg = getConfig();
            fetch('/api/preprocess', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ scaler: cfg.scaler, imputation: cfg.imputation })
            })
            .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
            .then(function(data) {
                if (data.success) {
                    refreshPreview();
                    notify('Preprocessing applied!', 'success');
                }
            })
            .catch(function(e) { notify('Preprocessing failed: ' + e.message, 'error'); });
        }

        // ── Model Selection ──
        function getModelsForTask(taskType, excludeClustering) {
            return availableModels.filter(function(m) {
                if (excludeClustering && m.task === 'clustering') return false;
                if (taskType === 'classification') return m.task === 'classification' || m.task === 'both';
                if (taskType === 'regression') return m.task === 'regression' || m.task === 'both';
                if (taskType === 'clustering') return m.task === 'clustering';
                return true;
            });
        }

        function createMultiselect(container, opts) {
            var selected = opts.selected || [];
            var placeholder = opts.placeholder || 'Select models...';
            var onChange = opts.onChange || function() {};
            var getItems = opts.getItems || function() { return availableModels; };

            container.innerHTML = '';
            var wrap = document.createElement('div');
            wrap.className = 'multiselect';

            var trigger = document.createElement('div');
            trigger.className = 'multiselect-trigger';
            var tagsDiv = document.createElement('div');
            tagsDiv.className = 'multiselect-tags';
            var arrow = document.createElement('i');
            arrow.className = 'ri-arrow-down-s-line multiselect-arrow';
            trigger.appendChild(tagsDiv);
            trigger.appendChild(arrow);

            var dropdown = document.createElement('div');
            dropdown.className = 'multiselect-dropdown';

            var searchWrap = document.createElement('div');
            searchWrap.className = 'multiselect-search';
            var searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.placeholder = 'Search models...';
            searchWrap.appendChild(searchInput);

            var actionsWrap = document.createElement('div');
            actionsWrap.className = 'multiselect-actions';
            var btnAll = document.createElement('button');
            btnAll.textContent = 'Select All';
            btnAll.type = 'button';
            var btnNone = document.createElement('button');
            btnNone.textContent = 'Clear';
            btnNone.type = 'button';
            actionsWrap.appendChild(btnAll);
            actionsWrap.appendChild(btnNone);

            var optionsDiv = document.createElement('div');
            optionsDiv.className = 'multiselect-options';

            dropdown.appendChild(searchWrap);
            dropdown.appendChild(actionsWrap);
            dropdown.appendChild(optionsDiv);
            wrap.appendChild(trigger);
            wrap.appendChild(dropdown);
            container.appendChild(wrap);

            function renderTags() {
                tagsDiv.innerHTML = '';
                if (selected.length === 0) {
                    var ph = document.createElement('span');
                    ph.className = 'multiselect-placeholder';
                    ph.textContent = placeholder;
                    tagsDiv.appendChild(ph);
                } else {
                    selected.forEach(function(id) {
                        var model = availableModels.find(function(m) { return m.id === id; });
                        if (!model) return;
                        var tag = document.createElement('span');
                        tag.className = 'multiselect-tag';
                        tag.textContent = model.name;
                        var rm = document.createElement('span');
                        rm.className = 'multiselect-tag-remove';
                        rm.innerHTML = '&times;';
                        rm.onclick = function(e) {
                            e.stopPropagation();
                            selected = selected.filter(function(x) { return x !== id; });
                            syncBack();
                            renderTags();
                            renderOptions();
                            onChange(selected);
                        };
                        tag.appendChild(rm);
                        tagsDiv.appendChild(tag);
                    });
                }
            }

            function renderOptions() {
                var query = searchInput.value.toLowerCase();
                optionsDiv.innerHTML = '';
                var items = getItems();
                var groups = {};
                items.forEach(function(m) {
                    var lbl = m.task === 'classification' ? 'Classification' : m.task === 'regression' ? 'Regression' : m.task === 'clustering' ? 'Clustering' : 'Universal';
                    if (!groups[lbl]) groups[lbl] = [];
                    groups[lbl].push(m);
                });
                var order = ['Classification', 'Regression', 'Universal', 'Clustering'];
                order.forEach(function(grp) {
                    if (!groups[grp]) return;
                    var filtered = groups[grp].filter(function(m) { return m.name.toLowerCase().indexOf(query) !== -1; });
                    if (filtered.length === 0) return;
                    var label = document.createElement('div');
                    label.className = 'multiselect-group-label';
                    label.textContent = grp;
                    optionsDiv.appendChild(label);
                    filtered.forEach(function(m) {
                        var opt = document.createElement('div');
                        opt.className = 'multiselect-option' + (selected.indexOf(m.id) !== -1 ? ' selected' : '');
                        var check = document.createElement('span');
                        check.className = 'ms-check';
                        var name = document.createElement('span');
                        name.textContent = m.name;
                        opt.appendChild(check);
                        opt.appendChild(name);
                        opt.onclick = function(e) {
                            e.stopPropagation();
                            if (selected.indexOf(m.id) !== -1) {
                                selected = selected.filter(function(x) { return x !== m.id; });
                            } else {
                                selected.push(m.id);
                            }
                            syncBack();
                            renderTags();
                            renderOptions();
                            onChange(selected);
                        };
                        optionsDiv.appendChild(opt);
                    });
                });
            }

            function syncBack() {
                if (opts.selected !== undefined && opts.syncArray) {
                    opts.syncArray(selected);
                }
            }

            trigger.onclick = function(e) {
                e.stopPropagation();
                var isOpen = wrap.classList.contains('open');
                closeAllMultiselects();
                if (!isOpen) {
                    wrap.classList.add('open');
                    searchInput.value = '';
                    renderOptions();
                    searchInput.focus();
                }
            };

            searchInput.oninput = function() { renderOptions(); };
            searchInput.onclick = function(e) { e.stopPropagation(); };

            btnAll.onclick = function(e) {
                e.stopPropagation();
                var items = getItems();
                var query = searchInput.value.toLowerCase();
                items.forEach(function(m) {
                    if (m.name.toLowerCase().indexOf(query) !== -1 && selected.indexOf(m.id) === -1) {
                        selected.push(m.id);
                    }
                });
                syncBack();
                renderTags();
                renderOptions();
                onChange(selected);
            };

            btnNone.onclick = function(e) {
                e.stopPropagation();
                selected.length = 0;
                syncBack();
                renderTags();
                renderOptions();
                onChange(selected);
            };

            renderTags();

            return {
                refresh: function(newTaskType) {
                    var items = getItems();
                    var validIds = items.map(function(m) { return m.id; });
                    selected = selected.filter(function(id) { return validIds.indexOf(id) !== -1; });
                    syncBack();
                    renderTags();
                    renderOptions();
                    onChange(selected);
                },
                getSelected: function() { return selected.slice(); }
            };
        }

        function closeAllMultiselects() {
            document.querySelectorAll('.multiselect.open').forEach(function(el) {
                el.classList.remove('open');
            });
        }
        document.addEventListener('click', function() {
            closeAllMultiselects();
            closeAllColumnSelects();
        });

        var modelMultiselect = null;

        function setupModelCheckboxes() {
            var container = $('model-checkboxes');
            var taskType = getConfig().taskType;
            modelMultiselect = createMultiselect(container, {
                placeholder: 'Select models to train...',
                getItems: function() { return getModelsForTask(getConfig().taskType, false); },
                syncArray: function(arr) { selectedModels = arr; },
                onChange: function(sel) {
                    selectedModels = sel;
                    updateTrainButton();
                }
            });
        }

        function updateTrainButton() {
            var cfg = getConfig();
            $('btn-train').disabled = selectedModels.length === 0 || !cfg.targetColumn;
        }

        // ── Training ──
        function startTraining() {
            var cfg = getConfig();
            selectedModels.forEach(function(modelId) {
                fetch('/api/train', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(Object.assign({
                        target_column: cfg.targetColumn,
                        task_type: cfg.taskType,
                        model_type: modelId,
                        cv_folds: cfg.cvFolds
                    }, cfg.featureColumns ? { feature_columns: cfg.featureColumns } : {}))
                })
                .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
                .then(function(data) {
                    if (data.success) {
                        trainingJobs.push({
                            id: data.job_id,
                            model_type: modelId,
                            status: { Running: { progress: 0, message: 'Starting...' } }
                        });
                        renderJobs();
                        startJobPolling();
                        notify('Training started for ' + modelId, 'info');
                    }
                })
                .catch(function(e) { notify('Training failed: ' + e.message, 'error'); });
            });
            // Launch live UMAP visualization while training runs async
            if (cfg.targetColumn && dataInfo) {
                launchTrainUmap(cfg.targetColumn);
            }
        }

        // Launch UMAP in the training panel (runs async alongside training)
        function launchTrainUmap(colorBy) {
            var card = $('train-umap-card');
            card.style.display = '';
            $('train-umap-badge').style.display = '';
            $('train-umap-status').innerHTML = '<div class="loading-overlay" style="padding:12px 0;"><div class="spinner"></div><p class="text-12px regular">Projecting data to 2D while models train...</p></div>';
            if (trainUmapChartInstance) { trainUmapChartInstance.destroy(); trainUmapChartInstance = null; }

            var body = { n_neighbors: 15, min_dist: 0.1 };
            if (colorBy) body.color_by = colorBy;

            fetch('/api/visualization/umap', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            }).then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); }).then(function(data) {
                if (!data.success) {
                    $('train-umap-status').innerHTML = '<p class="text-12px regular" style="color:var(--color-text-700);">UMAP projection unavailable</p>';
                    return;
                }
                var modeLabel = data.color_mode === 'classification' ? 'Classification' : data.color_mode === 'regression' ? 'Regression' : 'Projection';
                var html = '<div class="flex-row gap-16" style="margin-bottom:8px;">';
                html += '<span class="text-12px regular" style="color:var(--color-text-700);">' + (data.n_samples || 0) + ' samples</span>';
                html += '<span class="text-12px regular" style="color:var(--color-text-700);">' + escHtml(modeLabel) + ' mode</span>';
                if (data.params.color_by) html += '<span class="text-12px regular" style="color:var(--color-text-700);">by <strong>' + escHtml(data.params.color_by) + '</strong></span>';
                html += '</div>';
                $('train-umap-status').innerHTML = html;
                renderTrainUmapChart(data);
            }).catch(function(e) {
                $('train-umap-status').innerHTML = '<p class="text-12px regular" style="color:var(--color-text-700);">UMAP: ' + escHtml(e.message) + '</p>';
            });
        }

        function renderTrainUmapChart(data) {
            if (!data || !data.points || typeof Chart === 'undefined') return;
            var ctx = $('trainUmapChart');
            if (trainUmapChartInstance) trainUmapChartInstance.destroy();

            var colors = ['#0066F5', '#3ABC3F', '#FFA931', '#FF3131', '#9C27B0', '#00BCD4', '#FF9800', '#795548', '#607D8B', '#E91E63'];
            var datasets = [];
            var points = data.points;
            var labels = data.labels;
            var labelNames = data.label_names;
            var colorValues = data.color_values;
            var colorMode = data.color_mode || 'none';
            var nPoints = points.length;

            if (colorMode === 'classification' && labels && labelNames && labelNames.length > 0) {
                for (var li = 0; li < labelNames.length; li++) {
                    var pts = [];
                    for (var pi = 0; pi < nPoints; pi++) {
                        if (labels[pi] === li) pts.push({ x: points[pi][0], y: points[pi][1] });
                    }
                    var c = colors[li % colors.length];
                    datasets.push({
                        label: labelNames[li], data: pts, type: 'scatter',
                        backgroundColor: c + '80', borderColor: c, borderWidth: 1,
                        pointRadius: 3, pointHoverRadius: 5, order: 2
                    });
                    if (pts.length >= 3) {
                        var hull = convexHull(pts);
                        if (hull.length > 0) hull.push(hull[0]);
                        datasets.push({
                            label: labelNames[li] + ' boundary', data: hull, type: 'line',
                            borderColor: c, borderWidth: 2, borderDash: [6, 4],
                            backgroundColor: c + '18', fill: true,
                            pointRadius: 0, pointHitRadius: 0, tension: 0.3, order: 1
                        });
                    }
                }
            } else if (colorMode === 'regression' && colorValues && colorValues.length > 0) {
                var minVal = colorValues[0], maxVal = colorValues[0];
                for (var i = 1; i < colorValues.length; i++) {
                    if (colorValues[i] < minVal) minVal = colorValues[i];
                    if (colorValues[i] > maxVal) maxVal = colorValues[i];
                }
                var range = maxVal - minVal || 1;
                var ptColors = []; var allPts = [];
                for (var pi = 0; pi < nPoints; pi++) {
                    var t = (colorValues[pi] - minVal) / range;
                    ptColors.push(lerpColor('#0066F5', '#FF3131', t));
                    allPts.push({ x: points[pi][0], y: points[pi][1], v: colorValues[pi] });
                }
                datasets.push({
                    label: 'Data', data: allPts, type: 'scatter',
                    backgroundColor: ptColors, borderColor: ptColors.map(function(c) { return c; }),
                    borderWidth: 1, pointRadius: 3, pointHoverRadius: 5, order: 2
                });
                var sorted = allPts.slice().sort(function(a, b) { return a.x - b.x; });
                var nBins = Math.min(30, Math.max(8, Math.floor(nPoints / 10)));
                var binSize = Math.ceil(sorted.length / nBins);
                var trendPts = [];
                for (var b = 0; b < nBins; b++) {
                    var start = b * binSize, end = Math.min(start + binSize, sorted.length);
                    if (start >= sorted.length) break;
                    var sx = 0, sy = 0, cnt = 0;
                    for (var j = start; j < end; j++) { sx += sorted[j].x; sy += sorted[j].y; cnt++; }
                    trendPts.push({ x: sx / cnt, y: sy / cnt });
                }
                datasets.push({
                    label: 'Trend', data: trendPts, type: 'line',
                    borderColor: '#FF313180', borderWidth: 3, backgroundColor: 'transparent',
                    pointRadius: 0, tension: 0.4, borderDash: [8, 4], order: 1
                });
            } else {
                var allPts = [];
                for (var pi = 0; pi < nPoints; pi++) allPts.push({ x: points[pi][0], y: points[pi][1] });
                datasets.push({
                    label: 'Data', data: allPts, backgroundColor: '#0066F580',
                    borderColor: '#0066F5', borderWidth: 1, pointRadius: 3, pointHoverRadius: 5
                });
            }

            trainUmapChartInstance = new Chart(ctx, {
                type: 'scatter',
                data: { datasets: datasets },
                options: {
                    responsive: true, maintainAspectRatio: true,
                    animation: {
                        duration: 2500, easing: 'easeOutQuart',
                        delay: function(context) {
                            var idx = context.dataIndex || 0;
                            var total = context.dataset ? context.dataset.data.length : 1;
                            return idx * (2000 / Math.max(total, 1));
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: 'UMAP-1', font: { size: 11 } }, grid: { color: '#F1F3F4' } },
                        y: { title: { display: true, text: 'UMAP-2', font: { size: 11 } }, grid: { color: '#F1F3F4' } }
                    },
                    plugins: {
                        legend: {
                            display: colorMode !== 'none', position: 'top',
                            labels: {
                                usePointStyle: true, pointStyle: 'circle', boxWidth: 8, font: { size: 11 },
                                filter: function(item) { return item.text.indexOf(' boundary') === -1 && item.text !== 'Trend'; }
                            }
                        },
                        tooltip: {
                            mode: 'nearest',
                            intersect: true,
                            callbacks: {
                                label: function(ctx) {
                                    var base = (ctx.dataset.label || '') + ': (' + ctx.parsed.x.toFixed(2) + ', ' + ctx.parsed.y.toFixed(2) + ')';
                                    if (ctx.raw && ctx.raw.v !== undefined) base += ' val=' + ctx.raw.v.toFixed(3);
                                    return base;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderJobs() {
            var container = $('jobs-list');
            if (trainingJobs.length === 0) {
                container.innerHTML = '';
                $('jobs-empty').style.display = '';
                return;
            }
            $('jobs-empty').style.display = 'none';
            var html = '<div class="flex-col gap-12">';
            trainingJobs.forEach(function(job) {
                var statusKey = Object.keys(job.status)[0];
                var badgeClass = statusKey === 'Running' ? 'badge-warning' : statusKey === 'Completed' ? 'badge-success' : 'badge-danger';
                html += '<div class="job-card">';
                html += '<div class="flex-row justify-between items-center">';
                html += '<span class="text-14px medium">' + escHtml(job.model_type || 'Training') + '</span>';
                html += '<span class="badge-sm ' + badgeClass + '">' + escHtml(statusKey) + '</span>';
                html += '</div>';
                if (job.status.Running) {
                    var pct = (job.status.Running.progress * 100).toFixed(0);
                    html += '<div class="flex-col gap-6">';
                    html += '<div class="progress-bar"><div class="progress-bar-fill active" style="width:' + pct + '%"></div></div>';
                    html += '<p class="text-12px regular" style="color:var(--color-text-700);">' + escHtml(job.status.Running.message || '') + '</p>';
                    html += '</div>';
                }
                if (job.status.Completed) {
                    html += '<div class="flex-col gap-4">';
                    var metrics = job.status.Completed.metrics || {};
                    Object.keys(metrics).forEach(function(k) {
                        var v = metrics[k];
                        var display = typeof v === 'number' ? v.toFixed(4) : JSON.stringify(v);
                        html += '<p class="text-12px regular" style="color:var(--color-text-700);"><strong>' + escHtml(k) + ':</strong> <span class="mono-12px">' + escHtml(display) + '</span></p>';
                    });
                    if (job.autotuning) {
                        html += '<div class="flex-row items-center gap-6" style="margin-top:8px;padding:8px 12px;background:var(--color-information-100);border-radius:8px;">';
                        html += '<div class="spinner" style="width:14px;height:14px;"></div>';
                        html += '<span class="text-12px medium" style="color:var(--color-information-600);">Auto-tuning hyperparameters...</span>';
                        html += '</div>';
                    }
                    if (job.hyperopt_status === 'completed' && job.hyperopt_metrics) {
                        var hm = job.hyperopt_metrics;
                        html += '<div style="margin-top:8px;padding:10px 12px;background:var(--color-success-100);border-radius:8px;">';
                        html += '<p class="text-12px medium" style="color:var(--color-success-600);margin-bottom:4px;"><i class="ri-flashlight-line"></i> Auto-Tune Results</p>';
                        if (hm.best_trial) {
                            html += '<p class="mono-12px">Best score: ' + (hm.best_trial.value || 0).toFixed(6) + '</p>';
                            html += '<p class="text-12px regular" style="color:var(--color-text-700);">Trials: ' + (hm.total_trials || 0) + ' | Time: ' + (hm.total_duration_secs || 0).toFixed(1) + 's</p>';
                        }
                        html += '</div>';
                    }
                    if (job.hyperopt_status === 'failed') {
                        html += '<p class="text-12px regular" style="color:var(--color-warning-500);margin-top:4px;"><i class="ri-flashlight-line"></i> Auto-tune skipped</p>';
                    }
                    html += '<div class="flex-row gap-4" style="margin-top:8px;">';
                    html += '<button onclick="exportModel(\'' + escAttr(job.id) + '\', \'onnx\')" class="btn-xs btn-outline"><i class="ri-download-line"></i> ONNX</button>';
                    html += '<button onclick="exportModel(\'' + escAttr(job.id) + '\', \'pmml\')" class="btn-xs btn-outline"><i class="ri-download-line"></i> PMML</button>';
                    html += '</div>';
                    html += '</div>';
                }
                if (job.status.Failed) {
                    html += '<p class="text-12px regular" style="color:var(--color-danger-500);">' + escHtml(job.status.Failed.error || 'Unknown error') + '</p>';
                }
                html += '</div>';
            });
            html += '</div>';
            container.innerHTML = html;
            renderTrainingChart();
        }

        function startJobPolling() {
            if (!pollJobsIntervalId) {
                pollJobsIntervalId = setInterval(pollJobs, 2000);
            }
        }

        function stopJobPolling() {
            if (pollJobsIntervalId) {
                clearInterval(pollJobsIntervalId);
                pollJobsIntervalId = null;
            }
        }

        function pollJobs() {
            var hasActive = trainingJobs.some(function(job) {
                if (!job.status.Completed && !job.status.Failed) return true;
                if (job.hyperopt_job_id && job.hyperopt_status === 'running') return true;
                return false;
            });
            if (!hasActive) { stopJobPolling(); return; }
            trainingJobs.forEach(function(job) {
                if (job.status.Completed || job.status.Failed) {
                    // Poll hyperopt for auto-tuning jobs
                    if (job.hyperopt_job_id && job.hyperopt_status === 'running') {
                        fetch('/api/train/status/' + job.hyperopt_job_id)
                            .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
                            .then(function(hdata) {
                                if (hdata.status.Completed) {
                                    job.hyperopt_status = 'completed';
                                    job.hyperopt_metrics = hdata.status.Completed.metrics || {};
                                    job.autotuning = false;
                                    renderJobs();
                                    notify('Auto-tune complete for ' + job.model_type + '!', 'success');
                                } else if (hdata.status.Failed) {
                                    job.hyperopt_status = 'failed';
                                    job.autotuning = false;
                                    renderJobs();
                                }
                            })
                            .catch(function(e) { console.error('Request failed:', e); });
                    }
                    return;
                }
                fetch('/api/train/status/' + job.id)
                    .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
                    .then(function(data) {
                        job.status = data.status;
                        renderJobs();
                        if (data.status.Completed) {
                            // Fetch latest model ID for explainability
                            fetch('/api/models').then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); }).then(function(mdata) {
                                var models = mdata.models || [];
                                if (models.length > 0) {
                                    lastTrainedModelId = models[models.length - 1].id;
                                    $('btn-explain').disabled = false;
                                }
                            }).catch(function(e) { console.error('Request failed:', e); });
                            // Update training UMAP badge and refresh Analyze tab UMAP
                            var umapBadge = $('train-umap-badge');
                            if (umapBadge) { umapBadge.textContent = 'Complete'; umapBadge.className = 'badge-sm badge-success'; }
                            var umapCfg = getConfig();
                            if (umapCfg.targetColumn && dataInfo) {
                                runUmap(umapCfg.targetColumn);
                            }
                            // Auto-tune: run hyperopt for the completed model
                            var cfg = getConfig();
                            if (cfg.targetColumn && job.model_type) {
                                job.autotuning = true;
                                renderJobs();
                                fetch('/api/hyperopt', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(Object.assign({
                                        target_column: cfg.targetColumn,
                                        task_type: cfg.taskType,
                                        model_type: job.model_type,
                                        n_trials: 15,
                                        sampler: 'tpe'
                                    }, cfg.featureColumns ? { feature_columns: cfg.featureColumns } : {}))
                                })
                                .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
                                .then(function(hdata) {
                                    if (hdata.success) {
                                        job.hyperopt_job_id = hdata.job_id;
                                        job.hyperopt_status = 'running';
                                        notify('Auto-tuning ' + job.model_type + '...', 'info');
                                    }
                                })
                                .catch(function(e) { console.error('Request failed:', e); });
                            }
                        }
                    })
                    .catch(function(e) { console.error('Request failed:', e); });
            });
        }

        // ── Compare ──
        function compareAllModels() {
            var cfg = getConfig();
            var models = cfg.taskType === 'classification'
                ? ['logistic_regression', 'decision_tree', 'random_forest', 'svm', 'xgboost', 'gradient_boosting', 'extra_trees', 'adaboost', 'knn']
                : ['linear_regression', 'ridge', 'lasso', 'decision_tree', 'random_forest', 'svm', 'xgboost', 'gradient_boosting', 'extra_trees', 'knn'];

            notify('Running model comparison...', 'info');
            $('btn-compare').disabled = true;

            fetch('/api/train/compare', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(Object.assign({
                    target_column: cfg.targetColumn,
                    task_type: cfg.taskType,
                    models: models,
                    cv_folds: cfg.cvFolds
                }, cfg.featureColumns ? { feature_columns: cfg.featureColumns } : {}))
            })
            .then(function(r) {
                if (!r.ok) throw new Error('Server returned ' + r.status);
                return r.json();
            })
            .then(function(data) {
                $('btn-compare').disabled = false;
                if (data.success) {
                    comparisonResults = data.comparison || [];
                    renderComparison();
                    var failed = comparisonResults.filter(function(r) { return r.error; }).length;
                    if (failed > 0) {
                        notify('Comparison done — ' + failed + ' model(s) failed', 'error');
                    } else {
                        notify('Comparison complete!', 'success');
                    }
                } else {
                    notify('Comparison failed: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(function(e) {
                $('btn-compare').disabled = false;
                notify('Comparison failed: ' + e.message, 'error');
            });
        }

        function renderComparison() {
            if (comparisonResults.length === 0) {
                $('compare-results').style.display = 'none';
                $('compare-empty').style.display = '';
                return;
            }
            $('compare-empty').style.display = 'none';
            $('compare-results').style.display = '';

            var cfg = getConfig();
            var isClassification = cfg.taskType === 'classification';
            var scoreLabel = isClassification ? 'Accuracy' : 'R\u00B2';

            var html = '<table class="data-table"><thead><tr><th>Model</th><th>' + scoreLabel + '</th><th>Status</th></tr></thead><tbody>';
            comparisonResults.forEach(function(r) {
                if (r.error) {
                    html += '<tr><td><span class="text-14px medium">' + escHtml(r.model) + '</span></td>';
                    html += '<td><span class="mono-14px">—</span></td>';
                    html += '<td><span class="text-14px" style="color:var(--danger,#e53e3e);" title="' + escHtml(r.error) + '">Failed</span></td></tr>';
                } else {
                    var m = r.metrics || {};
                    var score = (m.accuracy || m.r2 || 0).toFixed(4);
                    html += '<tr><td><span class="text-14px medium">' + escHtml(r.model) + '</span></td>';
                    html += '<td><span class="mono-14px">' + score + '</span></td>';
                    html += '<td><span class="text-14px" style="color:var(--success,#38a169);">OK</span></td></tr>';
                }
            });
            html += '</tbody></table>';
            $('compare-table-wrap').innerHTML = html;

            // Filter to only successful results for the chart
            var successful = comparisonResults.filter(function(r) { return !r.error && r.metrics; });
            if (successful.length === 0) return;

            // Render chart
            var ctx = $('comparisonChart');
            if (!ctx || typeof Chart === 'undefined') return;
            if (comparisonChartInstance) comparisonChartInstance.destroy();
            var cmpCanvas = ctx.getContext ? ctx : ctx.getContext('2d');
            var cmpGrad = (cmpCanvas.getContext ? cmpCanvas.getContext('2d') : cmpCanvas).createLinearGradient(0, 0, 0, 300);
            cmpGrad.addColorStop(0, 'rgba(0, 102, 245, 0.4)');
            cmpGrad.addColorStop(1, 'rgba(0, 102, 245, 0.05)');
            comparisonChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: successful.map(function(r) { return r.model; }),
                    datasets: [{
                        label: scoreLabel,
                        data: successful.map(function(r) { var m = r.metrics || {}; return m.accuracy || m.r2 || 0; }),
                        backgroundColor: cmpGrad,
                        borderColor: '#0066F5',
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true, max: 1 },
                        x: { grid: { display: false } }
                    },
                    plugins: {
                        legend: { labels: { font: { family: '"Inter", sans-serif' } } }
                    }
                }
            });
        }

        // ── Predict ──
        function makePrediction() {
            var input = $('prediction-input').value;
            fetch('/api/predict', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: input })
            })
            .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
            .then(function(data) {
                $('prediction-empty').style.display = 'none';
                $('prediction-output').innerHTML = '<pre class="code-block">' + escHtml(JSON.stringify(data, null, 2)) + '</pre>';
            })
            .catch(function(e) { notify('Prediction failed: ' + e.message, 'error'); });
        }

        // ── Monitor ──
        function refreshSystemStatus() {
            fetch('/api/system/status')
                .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
                .then(function(data) {
                    var sys = data.system || {};
                    var status = data.status || 'error';
                    $('status-badge').textContent = status;
                    $('status-badge').className = 'badge-sm ' + (status === 'healthy' ? 'badge-success' : 'badge-danger');
                    $('status-dot').className = 'status-dot ' + (status === 'healthy' ? 'healthy' : 'error');
                    animateCount($('mon-cpu'), sys.cpu_usage || 0, 800, '%', 1);
                    animateCount($('mon-mem'), sys.memory_usage_percent || 0, 800, '%', 1);
                    $('mon-mem-detail').textContent = (sys.used_memory_gb || 0).toFixed(1) + ' / ' + (sys.total_memory_gb || 0).toFixed(1) + ' GB';
                    $('mon-status').textContent = status;
                    renderGaugeChart('cpuGaugeChart', sys.cpu_usage || 0, '#0066F5');
                    renderGaugeChart('memGaugeChart', sys.memory_usage_percent || 0, '#3ABC3F');
                    var ring = $('status-ring');
                    var icon = $('status-icon');
                    if (ring && icon) {
                        var sColor = status === 'healthy' ? 'var(--color-success-500)' : 'var(--color-danger-500)';
                        ring.style.borderColor = sColor;
                        icon.style.color = sColor;
                        icon.className = status === 'healthy' ? 'ri-check-line' : 'ri-close-line';
                        if (status === 'healthy') ring.classList.add('healthy-pulse');
                        else ring.classList.remove('healthy-pulse');
                    }
                    $('mon-status').style.color = status === 'healthy' ? 'var(--color-success-500)' : 'var(--color-danger-500)';
                    animateCount($('mon-datasets'), data.datasets_count || 0, 600);
                    animateCount($('mon-jobs'), data.jobs_count || 0, 600);
                    animateCount($('mon-models'), data.models_count || 0, 600);
                })
                .catch(function() {
                    $('status-badge').textContent = 'error';
                    $('status-badge').className = 'badge-sm badge-danger';
                    $('status-dot').className = 'status-dot error';
                    $('mon-status').textContent = 'error';
                    $('mon-status').style.color = 'var(--color-danger-500)';
                    var ring = $('status-ring');
                    var icon = $('status-icon');
                    if (ring && icon) {
                        ring.style.borderColor = 'var(--color-danger-500)';
                        icon.style.color = 'var(--color-danger-500)';
                        icon.className = 'ri-close-line';
                        ring.classList.remove('healthy-pulse');
                    }
                });
        }

        // ── HyperOpt ──
        var hyperoptJobId = null;
        var importanceChartInstance = null;
        var ensembleSelectedModels = [];

        function startHyperopt() {
            var cfg = getConfig();
            if (!cfg.targetColumn) { notify('Select a target column first', 'error'); return; }
            var timeout = parseInt($('ho-timeout').value) || 0;
            $('btn-hyperopt').disabled = true;
            $('hyperopt-empty').style.display = 'none';
            $('hyperopt-results').innerHTML = '<div class="flex-col gap-8"><div class="progress-bar"><div class="progress-bar-fill active" style="width:0%"></div></div><p class="text-12px regular" style="color:var(--color-text-700);">Starting optimization...</p></div>';

            fetch('/api/hyperopt', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(Object.assign({
                    target_column: cfg.targetColumn,
                    task_type: cfg.taskType,
                    model_type: $('ho-model').value,
                    n_trials: parseInt($('ho-trials').value),
                    sampler: $('ho-sampler').value,
                    timeout_secs: timeout > 0 ? timeout : null
                }, cfg.featureColumns ? { feature_columns: cfg.featureColumns } : {}))
            })
            .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
            .then(function(data) {
                if (data.success) {
                    hyperoptJobId = data.job_id;
                    notify('Hyperparameter optimization started!', 'info');
                    pollHyperopt();
                }
            })
            .catch(function(e) {
                notify('HyperOpt failed: ' + e.message, 'error');
                $('btn-hyperopt').disabled = false;
            });
        }

        function pollHyperopt() {
            if (!hyperoptJobId) return;
            fetch('/api/train/status/' + hyperoptJobId)
                .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
                .then(function(data) {
                    var s = data.status;
                    if (s.Completed) {
                        var m = s.Completed.metrics || {};
                        var html = '';
                        if (m.best_trial) {
                            html += '<div class="flex-col gap-12">';
                            html += '<div style="padding:16px;background:var(--color-success-100);border-radius:8px;">';
                            html += '<p class="text-14px medium" style="color:var(--color-success-600);">Best Trial</p>';
                            html += '<p class="mono-14px" style="margin-top:4px;">Score: ' + (m.best_trial.value || 0).toFixed(6) + '</p>';
                            html += '<p class="text-12px regular" style="color:var(--color-text-700);margin-top:4px;">Params: ' + escHtml(m.best_trial.params || '') + '</p>';
                            html += '<p class="text-12px regular" style="color:var(--color-text-700);">Duration: ' + (m.best_trial.duration_secs || 0).toFixed(2) + 's</p>';
                            html += '</div>';
                        }
                        html += '<p class="text-12px regular" style="color:var(--color-text-700);">Total trials: ' + (m.total_trials || 0) + ' | Total time: ' + (m.total_duration_secs || 0).toFixed(2) + 's</p>';
                        if (m.trials && m.trials.length > 0) {
                            html += '<div class="table-wrap"><table class="data-table"><thead><tr><th>#</th><th>Score</th><th>Duration</th><th>Pruned</th></tr></thead><tbody>';
                            m.trials.forEach(function(t) {
                                html += '<tr><td>' + escHtml(String(t.trial_id)) + '</td><td class="mono-12px">' + (t.value === Infinity ? 'Failed' : escHtml(String(t.value.toFixed(6)))) + '</td>';
                                html += '<td class="mono-12px">' + t.duration_secs.toFixed(2) + 's</td>';
                                html += '<td>' + (t.pruned ? '<span class="badge-sm badge-warning">Yes</span>' : '<span class="badge-sm badge-success">No</span>') + '</td></tr>';
                            });
                            html += '</tbody></table></div>';
                        }
                        html += '</div>';
                        $('hyperopt-results').innerHTML = html;
                        $('btn-hyperopt').disabled = false;
                        hyperoptJobId = null;
                        notify('Optimization complete!', 'success');
                        if (m.trials) renderConvergenceChart(m.trials);
                        loadHyperoptHistory();
                    } else if (s.Failed) {
                        $('hyperopt-results').innerHTML = '<p class="text-14px regular" style="color:var(--color-danger-500);">' + escHtml(s.Failed.error || 'Failed') + '</p>';
                        $('btn-hyperopt').disabled = false;
                        hyperoptJobId = null;
                    } else {
                        var p = s.Running ? (s.Running.progress * 100).toFixed(0) : '0';
                        $('hyperopt-results').innerHTML = '<div class="flex-col gap-8"><div class="progress-bar"><div class="progress-bar-fill active" style="width:' + p + '%"></div></div><p class="text-12px regular" style="color:var(--color-text-700);">' + escHtml(s.Running ? s.Running.message || 'Optimizing...' : 'Optimizing...') + '</p></div>';
                        setTimeout(pollHyperopt, 1500);
                    }
                })
                .catch(function() { setTimeout(pollHyperopt, 3000); });
        }

        // ── Ensemble ──
        var ensembleMultiselect = null;

        function setupEnsembleCheckboxes() {
            var container = $('ens-model-checkboxes');
            ensembleMultiselect = createMultiselect(container, {
                placeholder: 'Select at least 2 models...',
                getItems: function() { return getModelsForTask(getConfig().taskType, true); },
                syncArray: function(arr) { ensembleSelectedModels = arr; },
                onChange: function(sel) {
                    ensembleSelectedModels = sel;
                    $('btn-ensemble').disabled = ensembleSelectedModels.length < 2 || !getConfig().targetColumn;
                }
            });
        }

        var ensembleJobId = null;

        function startEnsemble() {
            var cfg = getConfig();
            if (!cfg.targetColumn) { notify('Select a target column first', 'error'); return; }
            if (ensembleSelectedModels.length < 2) { notify('Select at least 2 models', 'error'); return; }

            $('btn-ensemble').disabled = true;
            $('ensemble-empty').style.display = 'none';
            $('ensemble-results').innerHTML = '<div class="flex-col gap-8"><div class="progress-bar"><div class="progress-bar-fill" style="width:0%"></div></div><p class="text-12px regular" style="color:var(--color-text-700);">Training ensemble...</p></div>';

            fetch('/api/ensemble/train', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(Object.assign({
                    target_column: cfg.targetColumn,
                    task_type: cfg.taskType,
                    models: ensembleSelectedModels,
                    strategy: $('ens-strategy').value
                }, cfg.featureColumns ? { feature_columns: cfg.featureColumns } : {}))
            })
            .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
            .then(function(data) {
                if (data.success) {
                    ensembleJobId = data.job_id;
                    notify('Ensemble training started!', 'info');
                    pollEnsemble();
                }
            })
            .catch(function(e) {
                notify('Ensemble failed: ' + e.message, 'error');
                $('btn-ensemble').disabled = false;
            });
        }

        function pollEnsemble() {
            if (!ensembleJobId) return;
            fetch('/api/train/status/' + ensembleJobId)
                .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
                .then(function(data) {
                    var s = data.status;
                    if (s.Completed) {
                        var m = s.Completed.metrics || {};
                        var html = '<div class="flex-col gap-12">';
                        html += '<div style="padding:12px;background:var(--color-information-100);border-radius:8px;">';
                        html += '<p class="text-14px medium" style="color:var(--color-information-600);">Ensemble: ' + escHtml(m.strategy || 'voting') + ' | Models: ' + (m.successful_models || 0) + '/' + (m.model_count || 0) + '</p>';
                        html += '<p class="text-12px regular" style="color:var(--color-text-700);margin-top:4px;">Training time: ' + (m.training_time_secs || 0).toFixed(2) + 's</p>';
                        html += '</div>';
                        if (m.model_results && m.model_results.length > 0) {
                            html += '<div class="table-wrap"><table class="data-table"><thead><tr><th>Model</th><th>Status</th><th>Metrics</th></tr></thead><tbody>';
                            m.model_results.forEach(function(r) {
                                html += '<tr><td class="text-14px medium">' + escHtml(r.model) + '</td>';
                                html += '<td><span class="badge-sm ' + (r.status === 'success' ? 'badge-success' : 'badge-danger') + '">' + escHtml(r.status) + '</span></td>';
                                if (r.metrics) {
                                    var metricStr = Object.keys(r.metrics).map(function(k) { return k + ': ' + (typeof r.metrics[k] === 'number' ? r.metrics[k].toFixed(4) : r.metrics[k]); }).join(', ');
                                    html += '<td class="mono-12px">' + escHtml(metricStr) + '</td>';
                                } else {
                                    html += '<td class="text-12px" style="color:var(--color-danger-500);">' + escHtml(r.error || '') + '</td>';
                                }
                                html += '</tr>';
                            });
                            html += '</tbody></table></div>';
                        }
                        html += '</div>';
                        $('ensemble-results').innerHTML = html;
                        $('btn-ensemble').disabled = false;
                        ensembleJobId = null;
                        notify('Ensemble training complete!', 'success');
                    } else if (s.Failed) {
                        $('ensemble-results').innerHTML = '<p class="text-14px regular" style="color:var(--color-danger-500);">' + escHtml(s.Failed.error || 'Failed') + '</p>';
                        $('btn-ensemble').disabled = false;
                        ensembleJobId = null;
                    } else {
                        setTimeout(pollEnsemble, 1500);
                    }
                })
                .catch(function() { setTimeout(pollEnsemble, 3000); });
        }

        // ── Explainability ──
        var lastTrainedModelId = null;

        function getFeatureImportance() {
            if (!lastTrainedModelId) { notify('Train a model first', 'error'); return; }
            $('btn-explain').disabled = true;
            $('explain-empty').style.display = 'none';

            fetch('/api/explain/importance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ model_id: lastTrainedModelId })
            })
            .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
            .then(function(data) {
                if (data.success && data.features && data.features.length > 0) {
                    var html = '<div class="table-wrap"><table class="data-table"><thead><tr><th>Feature</th><th>Importance</th><th>Bar</th></tr></thead><tbody>';
                    var maxImp = Math.max.apply(null, data.features.map(function(f) { return Math.abs(f.importance); }));
                    data.features.forEach(function(f) {
                        var pct = maxImp > 0 ? (Math.abs(f.importance) / maxImp * 100).toFixed(0) : 0;
                        html += '<tr><td class="text-14px medium">' + escHtml(f.feature) + '</td>';
                        html += '<td class="mono-14px">' + f.importance.toFixed(6) + '</td>';
                        html += '<td><div style="width:100%;background:var(--color-grey-700);border-radius:4px;height:8px;"><div style="width:' + pct + '%;background:var(--color-information-500);border-radius:4px;height:8px;"></div></div></td>';
                        html += '</tr>';
                    });
                    html += '</tbody></table></div>';
                    $('explain-results').innerHTML = html;

                    // Render chart
                    if (typeof Chart !== 'undefined') {
                        var ctx = $('importanceChart');
                        if (importanceChartInstance) importanceChartInstance.destroy();
                        var features = data.features.slice(0, 15);
                        importanceChartInstance = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: features.map(function(f) { return f.feature; }),
                                datasets: [{
                                    label: 'Feature Importance',
                                    data: features.map(function(f) { return f.importance; }),
                                    backgroundColor: 'rgba(0, 102, 245, 0.15)',
                                    borderColor: '#0066F5',
                                    borderWidth: 1,
                                    borderRadius: 6
                                }]
                            },
                            options: {
                                indexAxis: 'y',
                                scales: { x: { beginAtZero: true }, y: { grid: { display: false } } },
                                plugins: { legend: { display: false } }
                            }
                        });
                    }
                } else {
                    $('explain-results').innerHTML = '<p class="text-14px regular" style="color:var(--color-text-700);">' + escHtml(data.message || 'Feature importances not available for this model type') + '</p>';
                }
                $('btn-explain').disabled = false;
            })
            .catch(function(e) {
                notify('Explainability failed: ' + e.message, 'error');
                $('btn-explain').disabled = false;
            });
        }

        // ── URL Import ──
        function importFromUrl() {
            var url = $('import-url').value.trim();
            if (!url) { notify('Enter a URL', 'error'); return; }
            $('btn-import-url').disabled = true;
            $('import-url-status').innerHTML = '<p class="text-12px regular" style="color:var(--color-text-700);"><i class="ri-loader-4-line"></i> Detecting source and downloading...</p>';

            fetch('/api/data/import/url', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: url })
            })
            .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
            .then(function(data) {
                $('btn-import-url').disabled = false;
                if (data.success) {
                    $('import-url-status').innerHTML = '<div style="padding:8px 12px;background:var(--color-success-100);border-radius:8px;"><p class="text-12px medium" style="color:var(--color-success-600);">✓ Imported from ' + escHtml(data.source) + '</p><p class="text-12px regular" style="color:var(--color-text-700);margin-top:2px;">' + data.rows + ' rows × ' + data.columns + ' columns (' + escHtml(data.format) + ')</p></div>';
                    dataInfo = { column_names: data.column_names, rows: data.rows, columns: data.columns };
                    $('data-rows').textContent = data.rows;
                    $('data-cols').textContent = data.columns;
                    $('data-meta').style.display = '';
                    refreshPreview();
                    updateTargetOptions(data.column_names);
                    notify('Dataset imported from ' + data.source + '!', 'success');
                } else if (data.needs_credentials) {
                    $('import-url-status').innerHTML = '<div style="padding:8px 12px;background:var(--color-warning-100);border-radius:8px;"><p class="text-12px medium" style="color:var(--color-warning-600);">⚠ ' + escHtml(data.message) + '</p></div>';
                    notify('Kaggle credentials required', 'error');
                } else {
                    $('import-url-status').innerHTML = '<p class="text-12px regular" style="color:var(--color-danger-500);">' + escHtml(data.message || 'Import failed') + '</p>';
                }
            })
            .catch(function(e) {
                $('btn-import-url').disabled = false;
                $('import-url-status').innerHTML = '<p class="text-12px regular" style="color:var(--color-danger-500);">Error: ' + escHtml(e.message) + '</p>';
            });
        }

        // ── Auto-Tune ──
        function startAutoTune() {
            var cfg = getConfig();
            if (!cfg.targetColumn) { notify('Select a target column first', 'error'); return; }
            $('btn-autotune').disabled = true;
            $('autotune-empty').style.display = 'none';
            $('autotune-results').innerHTML = '<div class="flex-col gap-8"><div class="progress-bar"><div class="progress-bar-fill active" style="width:0%"></div></div><p class="text-12px regular" style="color:var(--color-text-700);">Starting auto-tune...</p></div>';

            var maxModels = parseInt($('at-max-models').value) || 6;
            fetch('/api/autotune', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(Object.assign({
                    target_column: cfg.targetColumn,
                    task_type: cfg.taskType,
                    max_models: maxModels
                }, cfg.featureColumns ? { feature_columns: cfg.featureColumns } : {}))
            })
            .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
            .then(function(data) {
                if (data.success) {
                    autotuneJobId = data.job_id;
                    notify('Auto-tune started!', 'info');
                    pollAutoTune();
                }
            })
            .catch(function(e) {
                notify('Auto-tune failed: ' + e.message, 'error');
                $('btn-autotune').disabled = false;
            });
        }

        function pollAutoTune() {
            if (!autotuneJobId) return;
            fetch('/api/train/status/' + autotuneJobId)
                .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
                .then(function(data) {
                    var s = data.status;
                    if (s.Completed) {
                        var m = s.Completed.metrics || {};
                        var html = '<div class="flex-col gap-12">';
                        if (m.best) {
                            html += '<div style="padding:12px;background:var(--color-success-100);border-radius:8px;">';
                            html += '<p class="text-14px medium" style="color:var(--color-success-600);">🏆 Best: ' + escHtml(m.best_model || '') + '</p>';
                            html += '<p class="mono-14px" style="margin-top:4px;">Score: ' + (m.best.score || 0).toFixed(6) + '</p>';
                            html += '<p class="text-12px regular" style="color:var(--color-text-700);margin-top:2px;">Time: ' + (m.total_time_secs || 0).toFixed(2) + 's | Models: ' + (m.successful_models || 0) + '/' + (m.total_models_tested || 0) + '</p>';
                            html += '</div>';
                        }
                        if (m.leaderboard && m.leaderboard.length > 0) {
                            html += '<div class="table-wrap"><table class="data-table"><thead><tr><th>#</th><th>Model</th><th>Score</th><th>Time</th><th>Status</th></tr></thead><tbody>';
                            m.leaderboard.forEach(function(r, i) {
                                var atRank = '';
                                if (i === 0) atRank = '<i class="ri-medal-fill medal-gold" style="font-size:16px;"></i>';
                                else if (i === 1) atRank = '<i class="ri-medal-fill medal-silver" style="font-size:16px;"></i>';
                                else if (i === 2) atRank = '<i class="ri-medal-fill medal-bronze" style="font-size:16px;"></i>';
                                else atRank = '' + (i + 1);
                                html += '<tr><td>' + atRank + '</td>';
                                html += '<td class="text-14px medium">' + escHtml(r.model) + '</td>';
                                html += '<td class="mono-14px">' + (r.score || 0).toFixed(6) + '</td>';
                                html += '<td class="mono-12px">' + (r.training_time_secs || 0).toFixed(2) + 's</td>';
                                html += '<td><span class="badge-sm ' + (r.status === 'success' ? 'badge-success' : 'badge-danger') + '">' + escHtml(r.status) + '</span></td></tr>';
                            });
                            html += '</tbody></table></div>';
                        }
                        html += '</div>';
                        $('autotune-results').innerHTML = html;
                        $('btn-autotune').disabled = false;
                        autotuneJobId = null;
                        if (m.best && m.best.status === 'success') {
                            var bestModelId = 'autotune_' + m.best_model + '_' + data.job_id;
                            lastTrainedModelId = bestModelId;
                            $('btn-explain').disabled = false;
                        }
                        notify('Auto-tune complete! Best: ' + (m.best_model || 'N/A'), 'success');
                    } else if (s.Failed) {
                        $('autotune-results').innerHTML = '<p class="text-14px regular" style="color:var(--color-danger-500);">' + escHtml(s.Failed.error || 'Failed') + '</p>';
                        $('btn-autotune').disabled = false;
                        autotuneJobId = null;
                    } else {
                        var p = s.Running ? (s.Running.progress * 100).toFixed(0) : '0';
                        var msg = s.Running ? s.Running.message || 'Auto-tuning...' : 'Auto-tuning...';
                        $('autotune-results').innerHTML = '<div class="flex-col gap-8"><div class="progress-bar"><div class="progress-bar-fill active" style="width:' + p + '%"></div></div><p class="text-12px regular" style="color:var(--color-text-700);">' + escHtml(msg) + '</p></div>';
                        setTimeout(pollAutoTune, 1500);
                    }
                })
                .catch(function() { setTimeout(pollAutoTune, 3000); });
        }

        // ── Enhanced HyperOpt: Search Space, Convergence, History ──
        function loadSearchSpace(modelType) {
            fetch('/api/hyperopt/search-space/' + modelType)
                .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
                .then(function(data) {
                    var params = data.parameters || [];
                    if (params.length === 0) { $('ho-search-space').innerHTML = '<p class="text-14px regular" style="color:var(--color-text-700);">No parameters defined</p>'; return; }
                    var html = '<div class="table-wrap"><table class="data-table"><thead><tr><th>Parameter</th><th>Type</th><th>Range</th><th>Default</th></tr></thead><tbody>';
                    params.forEach(function(p) {
                        html += '<tr><td class="text-14px medium">' + escHtml(p.name) + '</td>';
                        html += '<td class="mono-12px">' + escHtml(p.type) + '</td>';
                        html += '<td class="mono-12px">' + escHtml(String(p.low)) + ' – ' + escHtml(String(p.high)) + '</td>';
                        html += '<td class="mono-12px">' + (p.default !== undefined ? escHtml(String(p.default)) : '-') + '</td></tr>';
                    });
                    html += '</tbody></table></div>';
                    $('ho-search-space').innerHTML = html;
                })
                .catch(function(e) { console.error('Request failed:', e); });
        }

        function renderConvergenceChart(trials) {
            if (typeof Chart === 'undefined' || !trials || trials.length === 0) return;
            var ctx = $('convergenceChart');
            if (convergenceChartInstance) convergenceChartInstance.destroy();
            var bestSoFar = [];
            var best = Infinity;
            trials.forEach(function(t) {
                if (t.value < best) best = t.value;
                bestSoFar.push(best);
            });
            var cvCanvas = ctx.getContext ? ctx : ctx.getContext('2d');
            var cvCtx2d = cvCanvas.getContext ? cvCanvas.getContext('2d') : cvCanvas;
            var cvGrad = cvCtx2d.createLinearGradient(0, 0, 0, 200);
            cvGrad.addColorStop(0, 'rgba(0,102,245,0.25)');
            cvGrad.addColorStop(1, 'rgba(0,102,245,0)');
            convergenceChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trials.map(function(t) { return t.trial_id; }),
                    datasets: [
                        { label: 'Trial Score', data: trials.map(function(t) { return t.value === Infinity ? null : t.value; }), borderColor: '#B4D2FC', backgroundColor: 'rgba(0,102,245,0.05)', pointRadius: 3, tension: 0, fill: false },
                        { label: 'Best So Far', data: bestSoFar, borderColor: '#0066F5', backgroundColor: cvGrad, borderWidth: 2, pointRadius: 0, tension: 0.3, fill: true }
                    ]
                },
                options: { scales: { x: { title: { display: true, text: 'Trial' } }, y: { title: { display: true, text: 'Score (lower=better)' } } }, plugins: { legend: { position: 'bottom' } } }
            });
        }

        function loadHyperoptHistory() {
            fetch('/api/hyperopt/history')
                .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
                .then(function(data) {
                    var studies = data.studies || [];
                    if (studies.length === 0) { $('ho-history').innerHTML = '<p class="text-14px regular" style="color:var(--color-text-700);">No studies yet</p>'; return; }
                    var html = '<div class="table-wrap"><table class="data-table"><thead><tr><th>Model</th><th>Best Score</th><th>Trials</th><th>Time</th><th>Date</th></tr></thead><tbody>';
                    studies.forEach(function(s) {
                        html += '<tr><td class="text-14px medium">' + escHtml(s.model_type || '') + '</td>';
                        html += '<td class="mono-14px">' + (s.best_trial ? (s.best_trial.value || 0).toFixed(6) : 'N/A') + '</td>';
                        html += '<td>' + (s.total_trials || 0) + '</td>';
                        html += '<td class="mono-12px">' + (s.total_duration_secs || 0).toFixed(2) + 's</td>';
                        html += '<td class="text-12px">' + (s.timestamp ? new Date(s.timestamp).toLocaleString() : '') + '</td></tr>';
                    });
                    html += '</tbody></table></div>';
                    $('ho-history').innerHTML = html;
                })
                .catch(function(e) { console.error('Request failed:', e); });
        }

        // ── Export Model ──
        function exportModel(jobId, format) {
            // Find the model ID from the job — look for it via the models API
            fetch('/api/models')
                .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
                .then(function(data) {
                    var models = data.models || [];
                    var model = models.find(function(m) { return m.name && m.name.includes(jobId); });
                    if (!model) { notify('Model not found — it may not have been saved', 'error'); return; }
                    return fetch('/api/export/model', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model_id: model.id, format: format })
                    });
                })
                .then(function(r) { if (r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); } })
                .then(function(data) {
                    if (data && data.success) {
                        notify('Model exported as ' + format.toUpperCase() + ' to ' + data.path, 'success');
                    } else if (data) {
                        notify('Export failed: ' + (data.message || 'Unknown error'), 'error');
                    }
                })
                .catch(function(e) { notify('Export failed: ' + e.message, 'error'); });
        }

        // ── Anomaly Detection ──
        function runAnomalyDetection() {
            $('btn-anomaly').disabled = true;
            $('anomaly-empty').style.display = 'none';
            $('anomaly-results').innerHTML = '<div class="loading-overlay"><div class="spinner"></div><p class="text-12px regular">Running anomaly detection...</p></div>';

            fetch('/api/anomaly/detect', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    method: $('anomaly-method').value,
                    contamination: parseFloat($('anomaly-contamination').value),
                    n_estimators: parseInt($('anomaly-estimators').value)
                })
            })
            .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
            .then(function(data) {
                $('btn-anomaly').disabled = false;
                if (data.success) {
                    var rate = ((data.anomaly_rate || 0) * 100).toFixed(1);
                    var html = '<div class="flex-col gap-12">';
                    html += '<div class="grid-3" style="text-align:center;">';
                    html += '<div><p class="mono-20px medium">' + data.total_samples + '</p><p class="text-12px regular" style="color:var(--color-text-700);">Total Samples</p></div>';
                    html += '<div><p class="mono-20px medium" style="color:var(--color-danger-500);">' + data.anomalies_found + '</p><p class="text-12px regular" style="color:var(--color-text-700);">Anomalies</p></div>';
                    html += '<div><p class="mono-20px medium">' + rate + '%</p><p class="text-12px regular" style="color:var(--color-text-700);">Anomaly Rate</p></div>';
                    html += '</div>';
                    if (data.score_stats) {
                        html += '<div class="grid-3" style="text-align:center;">';
                        html += '<div><p class="mono-14px medium">' + (data.score_stats.min || 0).toFixed(4) + '</p><p class="text-12px regular" style="color:var(--color-text-700);">Min Score</p></div>';
                        html += '<div><p class="mono-14px medium">' + (data.score_stats.mean || 0).toFixed(4) + '</p><p class="text-12px regular" style="color:var(--color-text-700);">Mean Score</p></div>';
                        html += '<div><p class="mono-14px medium">' + (data.score_stats.max || 0).toFixed(4) + '</p><p class="text-12px regular" style="color:var(--color-text-700);">Max Score</p></div>';
                        html += '</div>';
                    }
                    html += '<p class="text-12px regular" style="color:var(--color-text-600);">Columns used: ' + (data.columns_used || []).join(', ') + '</p>';
                    html += '</div>';
                    $('anomaly-results').innerHTML = html;
                    renderAnomalyChart(data);
                    notify('Found ' + data.anomalies_found + ' anomalies', 'success');
                } else {
                    $('anomaly-results').innerHTML = '<div class="alert-banner alert-danger"><i class="ri-error-warning-line"></i> ' + escHtml(data.message || 'Detection failed') + '</div>';
                }
            })
            .catch(function(e) {
                $('btn-anomaly').disabled = false;
                $('anomaly-results').innerHTML = '';
                $('anomaly-empty').style.display = '';
                notify('Anomaly detection failed: ' + e.message, 'error');
            });
        }

        // ── Clustering ──
        function toggleClusterParams() {
            var algo = $('cluster-algo').value;
            $('cluster-k-group').style.display = algo === 'kmeans' ? '' : 'none';
            $('cluster-eps-group').style.display = algo === 'dbscan' ? '' : 'none';
            $('cluster-minsamp-group').style.display = algo === 'dbscan' ? '' : 'none';
        }

        function runClustering() {
            var algo = $('cluster-algo').value;
            var body = { algorithm: algo };
            if (algo === 'kmeans') {
                body.n_clusters = parseInt($('cluster-k').value) || 3;
            } else {
                body.eps = parseFloat($('cluster-eps').value) || 0.5;
                body.min_samples = parseInt($('cluster-minsamp').value) || 5;
            }
            $('btn-clustering').disabled = true;
            $('clustering-empty').style.display = 'none';
            $('clustering-results').innerHTML = '<div class="loading-overlay"><div class="spinner"></div><p class="text-12px regular">Running clustering...</p></div>';
            fetch('/api/clustering/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            }).then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); }).then(function(data) {
                $('btn-clustering').disabled = false;
                if (!data.success) {
                    $('clustering-results').innerHTML = '<div class="alert alert-error">Clustering failed</div>';
                    return;
                }
                var r = data.result;
                var html = '<div class="grid-3" style="margin-bottom:16px;">';
                html += '<div><p class="mono-20px medium">' + (r.n_clusters || r.n_clusters_found || 0) + '</p><p class="text-12px regular" style="color:var(--color-text-700);">Clusters Found</p></div>';
                html += '<div><p class="mono-20px medium">' + (r.total_samples || 0) + '</p><p class="text-12px regular" style="color:var(--color-text-700);">Total Samples</p></div>';
                if (r.n_noise !== undefined) {
                    html += '<div><p class="mono-20px medium">' + r.n_noise + '</p><p class="text-12px regular" style="color:var(--color-text-700);">Noise Points</p></div>';
                } else if (r.inertia !== undefined) {
                    html += '<div><p class="mono-20px medium">' + r.inertia.toFixed(2) + '</p><p class="text-12px regular" style="color:var(--color-text-700);">Inertia</p></div>';
                }
                html += '</div>';
                // Cluster sizes table
                if (r.cluster_sizes) {
                    html += '<table class="data-table"><thead><tr><th>Cluster</th><th>Size</th></tr></thead><tbody>';
                    var keys = Object.keys(r.cluster_sizes).sort(function(a,b) { return parseInt(a)-parseInt(b); });
                    for (var i = 0; i < keys.length; i++) {
                        var label = keys[i] === '-1' ? 'Noise' : 'Cluster ' + keys[i];
                        html += '<tr><td>' + label + '</td><td>' + r.cluster_sizes[keys[i]] + '</td></tr>';
                    }
                    html += '</tbody></table>';
                }
                $('clustering-results').innerHTML = html;
                renderClusteringChart(r);
                notify('Clustering complete: ' + (r.n_clusters || r.n_clusters_found || 0) + ' clusters found', 'success');
            }).catch(function(e) {
                $('btn-clustering').disabled = false;
                $('clustering-results').innerHTML = '';
                $('clustering-empty').style.display = '';
                notify('Clustering failed: ' + e.message, 'error');
            });
        }

        // ── UMAP Visualization ──
        function runUmap(autoColorBy) {
            var body = {
                n_neighbors: parseInt($('umap-neighbors').value) || 15,
                min_dist: parseFloat($('umap-mindist').value) || 0.1
            };
            var colorBy = autoColorBy || $('umap-colorby').value;
            if (colorBy) {
                body.color_by = colorBy;
                // Sync dropdown if auto-triggered
                if (autoColorBy) {
                    var sel = $('umap-colorby');
                    for (var i = 0; i < sel.options.length; i++) {
                        if (sel.options[i].value === autoColorBy) { sel.selectedIndex = i; break; }
                    }
                }
            }

            $('btn-umap').disabled = true;
            $('umap-empty').style.display = 'none';
            $('umap-results').innerHTML = '<div class="loading-overlay"><div class="spinner"></div><p class="text-12px regular">Running UMAP dimensionality reduction...</p></div>';
            $('umap-chart-wrap').style.display = 'none';

            fetch('/api/visualization/umap', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            }).then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); }).then(function(data) {
                $('btn-umap').disabled = false;
                if (!data.success) {
                    $('umap-results').innerHTML = '<div class="alert alert-error">UMAP failed</div>';
                    return;
                }
                var modeLabel = data.color_mode === 'classification' ? 'Classification' : data.color_mode === 'regression' ? 'Regression' : 'Projection';
                var html = '<div class="grid-3" style="margin-bottom:16px;">';
                html += '<div><p class="mono-20px medium">' + (data.n_samples || 0) + '</p><p class="text-12px regular" style="color:var(--color-text-700);">Samples</p></div>';
                html += '<div><p class="mono-20px medium">' + escHtml(modeLabel) + '</p><p class="text-12px regular" style="color:var(--color-text-700);">Mode</p></div>';
                html += '<div><p class="mono-20px medium">' + (data.params.n_neighbors || 15) + '</p><p class="text-12px regular" style="color:var(--color-text-700);">Neighbors</p></div>';
                html += '</div>';
                if (data.label_names && data.label_names.length > 0) {
                    html += '<p class="text-12px regular" style="color:var(--color-text-700); margin-bottom:8px;">Colored by: <strong>' + escHtml(data.params.color_by || '') + '</strong> (' + data.label_names.length + ' classes)</p>';
                } else if (data.color_mode === 'regression') {
                    html += '<p class="text-12px regular" style="color:var(--color-text-700); margin-bottom:8px;">Gradient by: <strong>' + escHtml(data.params.color_by || '') + '</strong></p>';
                }
                $('umap-results').innerHTML = html;
                renderUmapChart(data);
                notify('UMAP complete: ' + modeLabel + ' — ' + (data.n_samples || 0) + ' samples', 'success');
            }).catch(function(e) {
                $('btn-umap').disabled = false;
                $('umap-results').innerHTML = '';
                $('umap-empty').style.display = '';
                notify('UMAP failed: ' + e.message, 'error');
            });
        }

        // Compute convex hull of 2D points (Andrew's monotone chain)
        function convexHull(pts) {
            if (pts.length < 3) return pts.slice();
            var sorted = pts.slice().sort(function(a, b) { return a.x === b.x ? a.y - b.y : a.x - b.x; });
            var lower = [];
            for (var i = 0; i < sorted.length; i++) {
                while (lower.length >= 2 && cross(lower[lower.length - 2], lower[lower.length - 1], sorted[i]) <= 0) lower.pop();
                lower.push(sorted[i]);
            }
            var upper = [];
            for (var i = sorted.length - 1; i >= 0; i--) {
                while (upper.length >= 2 && cross(upper[upper.length - 2], upper[upper.length - 1], sorted[i]) <= 0) upper.pop();
                upper.push(sorted[i]);
            }
            upper.pop(); lower.pop();
            return lower.concat(upper);
        }
        function cross(o, a, b) { return (a.x - o.x) * (b.y - o.y) - (a.y - o.y) * (b.x - o.x); }

        // Interpolate between two hex colors
        function lerpColor(c1, c2, t) {
            var r1 = parseInt(c1.slice(1, 3), 16), g1 = parseInt(c1.slice(3, 5), 16), b1 = parseInt(c1.slice(5, 7), 16);
            var r2 = parseInt(c2.slice(1, 3), 16), g2 = parseInt(c2.slice(3, 5), 16), b2 = parseInt(c2.slice(5, 7), 16);
            var r = Math.round(r1 + (r2 - r1) * t), g = Math.round(g1 + (g2 - g1) * t), b = Math.round(b1 + (b2 - b1) * t);
            return 'rgb(' + r + ',' + g + ',' + b + ')';
        }

        function renderUmapChart(data) {
            if (!data || !data.points || typeof Chart === 'undefined') return;
            $('umap-chart-wrap').style.display = '';
            var ctx = $('umapChart');
            if (umapChartInstance) umapChartInstance.destroy();

            var colors = ['#0066F5', '#3ABC3F', '#FFA931', '#FF3131', '#9C27B0', '#00BCD4', '#FF9800', '#795548', '#607D8B', '#E91E63'];
            var datasets = [];
            var points = data.points;
            var labels = data.labels;
            var labelNames = data.label_names;
            var colorValues = data.color_values;
            var colorMode = data.color_mode || 'none';
            var nPoints = points.length;

            if (colorMode === 'classification' && labels && labelNames && labelNames.length > 0) {
                // ── Classification: scatter points + animated convex hull boundaries ──
                for (var li = 0; li < labelNames.length; li++) {
                    var pts = [];
                    for (var pi = 0; pi < nPoints; pi++) {
                        if (labels[pi] === li) {
                            pts.push({ x: points[pi][0], y: points[pi][1] });
                        }
                    }
                    var c = colors[li % colors.length];
                    // Scatter points
                    datasets.push({
                        label: labelNames[li],
                        data: pts,
                        type: 'scatter',
                        backgroundColor: c + '80',
                        borderColor: c,
                        borderWidth: 1,
                        pointRadius: 3.5,
                        pointHoverRadius: 6,
                        order: 2
                    });
                    // Convex hull boundary line
                    if (pts.length >= 3) {
                        var hull = convexHull(pts);
                        if (hull.length > 0) hull.push(hull[0]); // close the polygon
                        datasets.push({
                            label: labelNames[li] + ' boundary',
                            data: hull,
                            type: 'line',
                            borderColor: c,
                            borderWidth: 2.5,
                            borderDash: [6, 4],
                            backgroundColor: c + '18',
                            fill: true,
                            pointRadius: 0,
                            pointHitRadius: 0,
                            tension: 0.3,
                            order: 1
                        });
                    }
                }
            } else if (colorMode === 'regression' && colorValues && colorValues.length > 0) {
                // ── Regression: gradient-colored points + trend line ──
                var minVal = colorValues[0], maxVal = colorValues[0];
                for (var i = 1; i < colorValues.length; i++) {
                    if (colorValues[i] < minVal) minVal = colorValues[i];
                    if (colorValues[i] > maxVal) maxVal = colorValues[i];
                }
                var range = maxVal - minVal || 1;
                var gradientLow = '#0066F5', gradientHigh = '#FF3131';

                // Build individual point colors
                var ptColors = [];
                var allPts = [];
                for (var pi = 0; pi < nPoints; pi++) {
                    var t = (colorValues[pi] - minVal) / range;
                    ptColors.push(lerpColor(gradientLow, gradientHigh, t));
                    allPts.push({ x: points[pi][0], y: points[pi][1], v: colorValues[pi] });
                }
                datasets.push({
                    label: 'Data',
                    data: allPts,
                    type: 'scatter',
                    backgroundColor: ptColors,
                    borderColor: ptColors.map(function(c) { return c; }),
                    borderWidth: 1,
                    pointRadius: 3.5,
                    pointHoverRadius: 6,
                    order: 2
                });

                // Regression trend line: sort by UMAP-1, bin, average
                var sorted = allPts.slice().sort(function(a, b) { return a.x - b.x; });
                var nBins = Math.min(30, Math.max(8, Math.floor(nPoints / 10)));
                var binSize = Math.ceil(sorted.length / nBins);
                var trendPts = [];
                for (var b = 0; b < nBins; b++) {
                    var start = b * binSize;
                    var end = Math.min(start + binSize, sorted.length);
                    if (start >= sorted.length) break;
                    var sx = 0, sy = 0, cnt = 0;
                    for (var j = start; j < end; j++) { sx += sorted[j].x; sy += sorted[j].y; cnt++; }
                    trendPts.push({ x: sx / cnt, y: sy / cnt });
                }
                datasets.push({
                    label: 'Trend',
                    data: trendPts,
                    type: 'line',
                    borderColor: '#FF313180',
                    borderWidth: 3,
                    backgroundColor: 'transparent',
                    pointRadius: 0,
                    tension: 0.4,
                    borderDash: [8, 4],
                    order: 1
                });
            } else {
                // ── No color: plain scatter ──
                var allPts = [];
                for (var pi = 0; pi < nPoints; pi++) {
                    allPts.push({ x: points[pi][0], y: points[pi][1] });
                }
                datasets.push({
                    label: 'Data',
                    data: allPts,
                    backgroundColor: '#0066F580',
                    borderColor: '#0066F5',
                    borderWidth: 1,
                    pointRadius: 3.5,
                    pointHoverRadius: 6
                });
            }

            umapChartInstance = new Chart(ctx, {
                type: 'scatter',
                data: { datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    animation: {
                        duration: 2000,
                        easing: 'easeOutQuart',
                        delay: function(context) {
                            var idx = context.dataIndex || 0;
                            var total = context.dataset ? context.dataset.data.length : 1;
                            return idx * (1500 / Math.max(total, 1));
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'UMAP-1', font: { size: 11 } },
                            grid: { color: '#F1F3F4' }
                        },
                        y: {
                            title: { display: true, text: 'UMAP-2', font: { size: 11 } },
                            grid: { color: '#F1F3F4' }
                        }
                    },
                    plugins: {
                        legend: {
                            display: colorMode !== 'none',
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                boxWidth: 8,
                                font: { size: 11 },
                                filter: function(item) {
                                    // Hide boundary line entries from legend
                                    return item.text.indexOf(' boundary') === -1 && item.text !== 'Trend';
                                }
                            }
                        },
                        tooltip: {
                            mode: 'nearest',
                            intersect: true,
                            callbacks: {
                                label: function(ctx) {
                                    var base = (ctx.dataset.label || '') + ': (' + ctx.parsed.x.toFixed(2) + ', ' + ctx.parsed.y.toFixed(2) + ')';
                                    if (ctx.raw && ctx.raw.v !== undefined) base += ' val=' + ctx.raw.v.toFixed(3);
                                    return base;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ── PCA Visualization ──
        function runPca(autoColorBy) {
            var body = {
                scale: $('pca-scale').value === 'true'
            };
            var colorBy = autoColorBy || $('pca-colorby').value;
            if (colorBy) {
                body.color_by = colorBy;
                if (autoColorBy) {
                    var sel = $('pca-colorby');
                    for (var i = 0; i < sel.options.length; i++) {
                        if (sel.options[i].value === autoColorBy) { sel.selectedIndex = i; break; }
                    }
                }
            }

            $('btn-pca').disabled = true;
            $('pca-empty').style.display = 'none';
            $('pca-results').innerHTML = '<div class="loading-overlay"><div class="spinner"></div><p class="text-12px regular">Running PCA projection...</p></div>';
            $('pca-chart-wrap').style.display = 'none';
            $('pca-variance').textContent = '--';

            fetch('/api/visualization/pca', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            }).then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); }).then(function(data) {
                $('btn-pca').disabled = false;
                if (!data.success) {
                    $('pca-results').innerHTML = '<div class="alert alert-error">PCA failed</div>';
                    return;
                }
                var modeLabel = data.color_mode === 'classification' ? 'Classification' : data.color_mode === 'regression' ? 'Regression' : 'Projection';
                var evr = data.explained_variance_ratio || [];
                var totalVar = evr.reduce(function(a, b) { return a + b; }, 0);
                $('pca-variance').textContent = (totalVar * 100).toFixed(1) + '%';

                var html = '<div class="grid-3" style="margin-bottom:16px;">';
                html += '<div><p class="mono-20px medium">' + (data.n_samples || 0) + '</p><p class="text-12px regular" style="color:var(--color-text-700);">Samples</p></div>';
                html += '<div><p class="mono-20px medium">' + escHtml(modeLabel) + '</p><p class="text-12px regular" style="color:var(--color-text-700);">Mode</p></div>';
                html += '<div><p class="mono-20px medium">' + (totalVar * 100).toFixed(1) + '%</p><p class="text-12px regular" style="color:var(--color-text-700);">Variance Explained</p></div>';
                html += '</div>';
                if (evr.length >= 2) {
                    html += '<p class="text-12px regular" style="color:var(--color-text-700); margin-bottom:8px;">PC1: ' + (evr[0] * 100).toFixed(1) + '% &nbsp; PC2: ' + (evr[1] * 100).toFixed(1) + '%</p>';
                }
                $('pca-results').innerHTML = html;
                renderPcaChart(data);
                notify('PCA complete: ' + (totalVar * 100).toFixed(1) + '% variance explained', 'success');
            }).catch(function(e) {
                $('btn-pca').disabled = false;
                $('pca-results').innerHTML = '';
                $('pca-empty').style.display = '';
                notify('PCA failed: ' + e.message, 'error');
            });
        }

        function renderPcaChart(data) {
            if (!data || !data.points || typeof Chart === 'undefined') return;
            $('pca-chart-wrap').style.display = '';
            var ctx = $('pcaChart');
            if (pcaChartInstance) pcaChartInstance.destroy();

            var evr = data.explained_variance_ratio || [];
            var pc1Label = 'PC1' + (evr[0] ? ' (' + (evr[0] * 100).toFixed(1) + '%)' : '');
            var pc2Label = 'PC2' + (evr[1] ? ' (' + (evr[1] * 100).toFixed(1) + '%)' : '');

            var colors = ['#0066F5', '#3ABC3F', '#FFA931', '#FF3131', '#9C27B0', '#00BCD4', '#FF9800', '#795548', '#607D8B', '#E91E63'];
            var datasets = [];
            var points = data.points;
            var labels = data.labels;
            var labelNames = data.label_names;
            var colorValues = data.color_values;
            var colorMode = data.color_mode || 'none';
            var nPoints = points.length;

            if (colorMode === 'classification' && labels && labelNames && labelNames.length > 0) {
                for (var li = 0; li < labelNames.length; li++) {
                    var pts = [];
                    for (var pi = 0; pi < nPoints; pi++) {
                        if (labels[pi] === li) pts.push({ x: points[pi][0], y: points[pi][1] });
                    }
                    var c = colors[li % colors.length];
                    datasets.push({
                        label: labelNames[li], data: pts, type: 'scatter',
                        backgroundColor: c + '80', borderColor: c, borderWidth: 1,
                        pointRadius: 3.5, pointHoverRadius: 6, order: 2
                    });
                    if (pts.length >= 3) {
                        var hull = convexHull(pts);
                        if (hull.length > 0) hull.push(hull[0]);
                        datasets.push({
                            label: labelNames[li] + ' boundary', data: hull, type: 'line',
                            borderColor: c, borderWidth: 2.5, borderDash: [6, 4],
                            backgroundColor: c + '18', fill: true,
                            pointRadius: 0, pointHitRadius: 0, tension: 0.3, order: 1
                        });
                    }
                }
            } else if (colorMode === 'regression' && colorValues && colorValues.length > 0) {
                var minVal = colorValues[0], maxVal = colorValues[0];
                for (var i = 1; i < colorValues.length; i++) {
                    if (colorValues[i] < minVal) minVal = colorValues[i];
                    if (colorValues[i] > maxVal) maxVal = colorValues[i];
                }
                var range = maxVal - minVal || 1;
                var ptColors = []; var allPts = [];
                for (var pi = 0; pi < nPoints; pi++) {
                    var t = (colorValues[pi] - minVal) / range;
                    ptColors.push(lerpColor('#0066F5', '#FF3131', t));
                    allPts.push({ x: points[pi][0], y: points[pi][1], v: colorValues[pi] });
                }
                datasets.push({
                    label: 'Data', data: allPts, type: 'scatter',
                    backgroundColor: ptColors, borderColor: ptColors.map(function(c) { return c; }),
                    borderWidth: 1, pointRadius: 3.5, pointHoverRadius: 6, order: 2
                });
            } else {
                var allPts = [];
                for (var pi = 0; pi < nPoints; pi++) allPts.push({ x: points[pi][0], y: points[pi][1] });
                datasets.push({
                    label: 'Data', data: allPts, backgroundColor: '#0066F580',
                    borderColor: '#0066F5', borderWidth: 1, pointRadius: 3.5, pointHoverRadius: 6
                });
            }

            pcaChartInstance = new Chart(ctx, {
                type: 'scatter',
                data: { datasets: datasets },
                options: {
                    responsive: true, maintainAspectRatio: true,
                    animation: {
                        duration: 1500, easing: 'easeOutQuart',
                        delay: function(context) {
                            var idx = context.dataIndex || 0;
                            var total = context.dataset ? context.dataset.data.length : 1;
                            return idx * (1000 / Math.max(total, 1));
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: pc1Label, font: { size: 11 } }, grid: { color: '#F1F3F4' } },
                        y: { title: { display: true, text: pc2Label, font: { size: 11 } }, grid: { color: '#F1F3F4' } }
                    },
                    plugins: {
                        legend: {
                            display: colorMode !== 'none', position: 'top',
                            labels: {
                                usePointStyle: true, pointStyle: 'circle', boxWidth: 8, font: { size: 11 },
                                filter: function(item) { return item.text.indexOf(' boundary') === -1; }
                            }
                        },
                        tooltip: {
                            mode: 'nearest',
                            intersect: true,
                            callbacks: {
                                label: function(ctx) {
                                    var base = (ctx.dataset.label || '') + ': (' + ctx.parsed.x.toFixed(2) + ', ' + ctx.parsed.y.toFixed(2) + ')';
                                    if (ctx.raw && ctx.raw.v !== undefined) base += ' val=' + ctx.raw.v.toFixed(3);
                                    return base;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ── Device Info ──
        function loadDeviceInfo() {
            var container = $('device-info');
            container.innerHTML = '<div class="loading-overlay"><div class="spinner"></div><p class="text-12px regular">Loading...</p></div>';
            fetch('/api/device/info')
                .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
                .then(function(data) {
                    var html = '<div class="flex-col gap-8">';
                    if (data.cpu) {
                        html += '<div class="flex-row justify-between"><span class="text-12px medium">CPU</span><span class="mono-12px">' + escHtml(data.cpu.brand || 'Unknown') + '</span></div>';
                        html += '<div class="flex-row justify-between"><span class="text-12px medium">Cores</span><span class="mono-12px">' + (data.cpu.count || 0) + '</span></div>';
                        html += '<div class="flex-row justify-between"><span class="text-12px medium">CPU Usage</span><span class="mono-12px">' + (data.cpu.usage_percent || 0).toFixed(1) + '%</span></div>';
                    }
                    if (data.memory) {
                        html += '<div class="flex-row justify-between"><span class="text-12px medium">Memory</span><span class="mono-12px">' + (data.memory.total_gb || 0).toFixed(1) + ' GB</span></div>';
                        html += '<div class="flex-row justify-between"><span class="text-12px medium">Mem Used</span><span class="mono-12px">' + (data.memory.usage_percent || 0).toFixed(1) + '%</span></div>';
                    }
                    html += '</div>';
                    container.innerHTML = html;
                })
                .catch(function(e) {
                    container.innerHTML = '<p class="text-12px regular" style="color:var(--color-danger-500);">Failed to load device info</p>';
                });
        }

        // ── Alerts ──
        function loadAlerts() {
            fetch('/api/monitoring/alerts')
                .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
                .then(function(data) {
                    var container = $('alerts-list');
                    var alerts = data.alerts || [];
                    if (alerts.length === 0) {
                        container.innerHTML = '<div class="empty-state" style="padding:20px;"><i class="ri-checkbox-circle-line" style="color:var(--color-success-500);"></i><p class="text-12px regular" style="color:var(--color-success-600);">No alerts — all systems normal</p></div>';
                        return;
                    }
                    var html = '<div class="flex-col gap-8">';
                    alerts.forEach(function(a) {
                        var cls = a.level === 'critical' ? 'alert-danger' : 'alert-warning';
                        html += '<div class="alert-banner ' + cls + '"><i class="ri-alarm-warning-line"></i> ' + escHtml(a.message) + '</div>';
                    });
                    html += '</div>';
                    container.innerHTML = html;
                })
                .catch(function(e) { console.error('Request failed:', e); });
        }

        // ── Performance Stats ──
        function loadPerformanceStats() {
            fetch('/api/monitoring/performance')
                .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
                .then(function(data) {
                    var jobs = data.jobs || {};
                    $('perf-completed').textContent = jobs.completed || 0;
                    $('perf-failed').textContent = jobs.failed || 0;
                    var tp = data.throughput || {};
                    $('perf-throughput').textContent = (tp.models_per_minute || 0).toFixed(1);
                })
                .catch(function(e) { console.error('Request failed:', e); });
        }

        // ── Security ──
        function loadSecurityStatus() {
            fetch('/api/security/status')
                .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
                .then(function(data) {
                    var rl = data.rate_limiting || {};
                    var guards = data.guards || {};
                    $('security-status').innerHTML =
                        '<div class="grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;">' +
                        '<div style="padding:12px;background:var(--color-grey-600);border-radius:8px;">' +
                            '<div class="text-12px regular" style="color:var(--color-text-600);">Status</div>' +
                            '<div class="text-16px medium" style="color:#22c55e;"><i class="ri-shield-check-fill"></i> Active</div></div>' +
                        '<div style="padding:12px;background:var(--color-grey-600);border-radius:8px;">' +
                            '<div class="text-12px regular" style="color:var(--color-text-600);">Requests Tracked</div>' +
                            '<div class="mono-16px medium">' + (rl.total_requests || 0) + '</div></div>' +
                        '<div style="padding:12px;background:var(--color-grey-600);border-radius:8px;">' +
                            '<div class="text-12px regular" style="color:var(--color-text-600);">Blocked</div>' +
                            '<div class="mono-16px medium" style="color:#ef4444;">' + (rl.total_blocked || 0) + '</div></div>' +
                        '<div style="padding:12px;background:var(--color-grey-600);border-radius:8px;">' +
                            '<div class="text-12px regular" style="color:var(--color-text-600);">Active Clients</div>' +
                            '<div class="mono-16px medium">' + (rl.active_clients || 0) + '</div></div>' +
                        '<div style="padding:12px;background:var(--color-grey-600);border-radius:8px;">' +
                            '<div class="text-12px regular" style="color:var(--color-text-600);">Audit Entries</div>' +
                            '<div class="mono-16px medium">' + (data.audit_log_entries || 0) + '</div></div>' +
                        '</div>';

                    // Guards panel
                    var ghtml = '<div class="grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:8px;">';
                    var guardItems = [
                        { name: 'SSRF Protection', icon: 'ri-global-line', active: guards.ssrf_protection },
                        { name: 'Path Traversal Guard', icon: 'ri-folder-shield-2-line', active: guards.path_traversal_protection },
                        { name: 'Error Sanitization', icon: 'ri-eye-off-line', active: guards.error_sanitization },
                        { name: 'Input Validation', icon: 'ri-input-method-line', active: guards.input_validation },
                        { name: 'Max Rows: ' + (guards.max_dataset_rows || 0).toLocaleString(), icon: 'ri-database-2-line', active: true },
                        { name: 'Max Columns: ' + (guards.max_dataset_columns || 0).toLocaleString(), icon: 'ri-layout-column-line', active: true },
                        { name: 'Max Batch: ' + (guards.max_batch_items || 0).toLocaleString(), icon: 'ri-stack-line', active: true },
                        { name: 'Train Timeout: ' + (guards.training_timeout_secs || 0) + 's', icon: 'ri-timer-line', active: true },
                    ];
                    guardItems.forEach(function(g) {
                        var color = g.active ? '#22c55e' : '#ef4444';
                        var icon2 = g.active ? 'ri-checkbox-circle-fill' : 'ri-close-circle-fill';
                        ghtml += '<div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--color-grey-600);border-radius:6px;">' +
                            '<i class="' + g.icon + '" style="font-size:16px;color:var(--color-text-700);"></i>' +
                            '<span class="text-13px regular" style="flex:1;">' + g.name + '</span>' +
                            '<i class="' + icon2 + '" style="color:' + color + ';font-size:16px;"></i></div>';
                    });
                    ghtml += '</div>';
                    $('security-guards').innerHTML = ghtml;
                })
                .catch(function(e) {
                    $('security-status').innerHTML = '<p class="text-14px" style="color:var(--color-text-600);">Failed to load security status</p>';
                });
        }

        function loadRateLimitStats() {
            fetch('/api/security/rate-limit/stats')
                .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
                .then(function(data) {
                    var m = data.metrics || {};
                    var html = '<div class="grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;">';
                    html += '<div style="padding:12px;background:var(--color-grey-600);border-radius:8px;">' +
                        '<div class="text-12px regular" style="color:var(--color-text-600);">Total Requests</div>' +
                        '<div class="mono-16px medium">' + (m.total_requests || 0) + '</div></div>';
                    html += '<div style="padding:12px;background:var(--color-grey-600);border-radius:8px;">' +
                        '<div class="text-12px regular" style="color:var(--color-text-600);">Blocked</div>' +
                        '<div class="mono-16px medium" style="color:#ef4444;">' + (m.total_blocked || 0) + '</div></div>';
                    html += '<div style="padding:12px;background:var(--color-grey-600);border-radius:8px;">' +
                        '<div class="text-12px regular" style="color:var(--color-text-600);">Active Clients</div>' +
                        '<div class="mono-16px medium">' + (m.active_clients || 0) + '</div></div>';
                    html += '</div>';
                    $('rate-limit-stats').innerHTML = html;
                })
                .catch(function(e) { console.error('Request failed:', e); });
        }

        function loadAuditLog() {
            fetch('/api/security/audit-log?limit=50')
                .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
                .then(function(data) {
                    var entries = data.entries || [];
                    if (entries.length === 0) {
                        $('audit-log').innerHTML = '<p class="text-14px regular" style="color:var(--color-text-600);">No audit entries yet</p>';
                        return;
                    }
                    var html = '<div class="table-wrap"><table class="data-table"><thead><tr>' +
                        '<th>Time</th><th>Method</th><th>Resource</th><th>Status</th><th>IP</th></tr></thead><tbody>';
                    entries.forEach(function(e) {
                        var statusColor = e.status_code < 400 ? '#22c55e' : (e.status_code < 500 ? '#eab308' : '#ef4444');
                        html += '<tr>' +
                            '<td class="mono-12px">' + new Date(e.timestamp).toLocaleTimeString() + '</td>' +
                            '<td class="text-13px medium">' + escHtml(e.action) + '</td>' +
                            '<td class="mono-12px">' + escHtml(e.resource) + '</td>' +
                            '<td class="mono-12px" style="color:' + statusColor + ';">' + escHtml(String(e.status_code)) + '</td>' +
                            '<td class="mono-12px">' + escHtml(e.ip_address) + '</td></tr>';
                    });
                    html += '</tbody></table></div>';
                    $('audit-log').innerHTML = html;
                })
                .catch(function() {
                    $('audit-log').innerHTML = '<p class="text-14px" style="color:var(--color-text-600);">Failed to load audit log</p>';
                });
        }

        // ── AutoML Pipeline ──
        var automlJobId = null;
        var automlPollInterval = null;

        var automlMultiselect = null;
        var automlSelectedModels = [];

        function setupAutoMLModelCheckboxes() {
            var container = $('automl-model-checkboxes');
            if (!container) return;
            automlMultiselect = createMultiselect(container, {
                placeholder: 'Leave empty for auto...',
                getItems: function() {
                    var taskType = $('automl-task-type') ? $('automl-task-type').value : '';
                    if (!taskType) return availableModels.filter(function(m) { return m.task !== 'clustering'; });
                    return getModelsForTask(taskType, true);
                },
                syncArray: function(arr) { automlSelectedModels = arr; },
                onChange: function(sel) { automlSelectedModels = sel; }
            });
        }

        function updateAutoMLTargetColumns() {
            if (!dataInfo) return;
            var names = dataInfo.column_names || [];
            automlTargetSelect = createColumnSelect(
                $('automl-target-wrap'),
                $('automl-target'),
                {
                    columns: names,
                    placeholder: '-- Select target column --',
                    onChange: function(val) {
                        $('btn-automl-run').disabled = !val;
                    }
                }
            );
        }

        function runAutoML() {
            var target = $('automl-target').value;
            if (!target) { notify('Please select a target column', 'error'); return; }

            var models = automlSelectedModels.slice();

            var body = { target_column: target };
            var taskType = $('automl-task-type').value;
            if (taskType) body.task_type = taskType;
            var scaler = $('automl-scaler').value;
            if (scaler) body.scaler = scaler;
            var imputation = $('automl-imputation').value;
            if (imputation) body.imputation = imputation;
            if (models.length > 0) body.models = models;

            var maxModels = parseInt($('automl-max-models').value);
            if (maxModels > 0) body.max_models = maxModels;
            var trials = parseInt($('automl-hyperopt-trials').value);
            body.hyperopt_trials = trials || 0;
            var folds = parseInt($('automl-cv-folds').value);
            if (folds > 0) body.cv_folds = folds;
            var budget = parseInt($('automl-time-budget').value);
            if (budget > 0) body.time_budget_secs = budget;

            $('btn-automl-run').disabled = true;
            $('automl-progress').style.display = 'block';
            $('automl-results').style.display = 'none';
            $('automl-status-text').textContent = 'Starting AutoML pipeline...';
            $('automl-progress-bar').style.width = '0%';
            $('automl-progress-bar').className = 'progress-bar-fill active striped';
            $('automl-progress-pct').textContent = '0%';

            fetch('/api/automl/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            })
            .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
            .then(function(data) {
                if (data.success && data.job_id) {
                    automlJobId = data.job_id;
                    notify('AutoML pipeline started!', 'success');
                    automlPollInterval = setInterval(pollAutoMLStatus, 2000);
                } else {
                    notify('Failed to start AutoML: ' + (data.error || 'Unknown error'), 'error');
                    $('btn-automl-run').disabled = false;
                    $('automl-progress').style.display = 'none';
                }
            })
            .catch(function(err) {
                notify('AutoML request failed: ' + err, 'error');
                $('btn-automl-run').disabled = false;
                $('automl-progress').style.display = 'none';
            });
        }

        function pollAutoMLStatus() {
            if (!automlJobId) return;
            fetch('/api/automl/status/' + automlJobId)
                .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
                .then(function(data) {
                    var pct = Math.round(data.progress || 0);
                    $('automl-progress-bar').style.width = pct + '%';
                    $('automl-progress-pct').textContent = pct + '%';
                    $('automl-status-text').textContent = data.message || data.status;

                    if (data.status === 'completed') {
                        clearInterval(automlPollInterval);
                        automlPollInterval = null;
                        $('automl-progress-bar').className = 'progress-bar-fill';
                        $('automl-progress').style.display = 'none';
                        $('btn-automl-run').disabled = false;
                        displayAutoMLResults(data.result);
                    } else if (data.status === 'failed') {
                        clearInterval(automlPollInterval);
                        automlPollInterval = null;
                        $('automl-progress-bar').className = 'progress-bar-fill';
                        $('automl-progress').style.display = 'none';
                        $('btn-automl-run').disabled = false;
                        notify('AutoML pipeline failed: ' + data.message, 'error');
                    }
                })
                .catch(function(e) { console.error('Request failed:', e); });
        }

        function displayAutoMLResults(result) {
            if (!result) return;
            $('automl-results').style.display = 'block';

            $('automl-best-model').textContent = result.best_model || '—';
            var scoreText = (result.metric || 'Score') + ': ' + (result.best_score != null ? result.best_score.toFixed(4) : '—');
            $('automl-best-score').textContent = scoreText;
            $('automl-models-tested').textContent = result.models_evaluated || 0;
            var totalTime = result.total_time_secs || 0;
            $('automl-total-time').textContent = totalTime < 60 ? totalTime.toFixed(1) + 's' : (totalTime / 60).toFixed(1) + 'm';

            // Leaderboard table
            var lb = result.leaderboard || [];
            var html = '<table class="data-table"><thead><tr><th>#</th><th>Model</th><th>Score</th><th>Time</th></tr></thead><tbody>';
            lb.forEach(function(entry, i) {
                var score = entry.score != null ? parseFloat(entry.score).toFixed(4) : 'Error';
                var time = entry.training_time_secs != null ? entry.training_time_secs.toFixed(2) + 's' : '—';
                var cls = i === 0 ? ' style="background:var(--color-information-100);font-weight:600;"' : '';
                var rank = '';
                if (i === 0) rank = '<i class="ri-medal-fill medal-gold" style="font-size:16px;"></i> ';
                else if (i === 1) rank = '<i class="ri-medal-fill medal-silver" style="font-size:16px;"></i> ';
                else if (i === 2) rank = '<i class="ri-medal-fill medal-bronze" style="font-size:16px;"></i> ';
                else rank = (i + 1) + '';
                html += '<tr' + cls + '><td>' + rank + '</td><td>' + escHtml(entry.model) + '</td><td class="mono-12px">' + score + '</td><td class="mono-12px">' + time + '</td></tr>';
            });
            html += '</tbody></table>';
            $('automl-leaderboard').innerHTML = html;

            // HyperOpt results
            if (result.hyperopt && !result.hyperopt.skipped) {
                $('automl-hyperopt-result').style.display = 'block';
                var hoHtml = '<div class="text-13px regular">';
                hoHtml += '<div><strong>Trials:</strong> ' + (result.hyperopt.n_trials || 0) + '</div>';
                hoHtml += '<div><strong>Best Value:</strong> ' + (result.hyperopt.best_value != null ? result.hyperopt.best_value.toFixed(6) : '—') + '</div>';
                hoHtml += '<div><strong>Best Params:</strong> ' + escHtml(result.hyperopt.best_params || '—') + '</div>';
                hoHtml += '</div>';
                $('automl-hyperopt-details').innerHTML = hoHtml;
            } else {
                $('automl-hyperopt-result').style.display = 'none';
            }

            notify('AutoML pipeline completed! Best model: ' + result.best_model, 'success');
        }

        // ── Chart Renderers ──
        function renderDataSummary() {
            if (!dataPreview || !dataPreview.columns || dataPreview.columns.length === 0) return;
            $('data-summary-empty').style.display = 'none';
            $('data-summary-chart-wrap').style.display = '';

            var cols = dataPreview.columns;
            var types = {};
            cols.forEach(function(c) {
                var t = c.dtype || 'unknown';
                types[t] = (types[t] || 0) + 1;
            });

            var statsHtml = '<div class="grid-2" style="gap:8px;">';
            statsHtml += '<div style="padding:12px;background:var(--color-grey-600);border-radius:8px;"><p class="text-12px regular" style="color:var(--color-text-600);">Columns</p><p class="mono-20px medium">' + cols.length + '</p></div>';
            statsHtml += '<div style="padding:12px;background:var(--color-grey-600);border-radius:8px;"><p class="text-12px regular" style="color:var(--color-text-600);">Rows</p><p class="mono-20px medium">' + (dataPreview.rows || 0) + '</p></div>';
            var typeColors = { 'Float64': '#0066F5', 'Int64': '#3ABC3F', 'Utf8': '#FFA931', 'Boolean': '#FF3131', 'unknown': '#9C9FA1' };
            Object.keys(types).forEach(function(t) {
                var dotColor = typeColors[t] || '#9C9FA1';
                statsHtml += '<div style="padding:12px;background:var(--color-grey-600);border-radius:8px;"><p class="text-12px regular" style="color:var(--color-text-600);"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:' + dotColor + ';margin-right:6px;vertical-align:middle;"></span>' + escHtml(t) + '</p><p class="mono-20px medium">' + types[t] + '</p></div>';
            });
            statsHtml += '</div>';
            $('data-col-stats').innerHTML = statsHtml;

            if (typeof Chart === 'undefined') return;
            var ctx = $('columnTypesChart');
            if (columnTypesChartInstance) columnTypesChartInstance.destroy();
            var labels = Object.keys(types);
            var colors = ['#0066F5', '#3ABC3F', '#FFA931', '#FF3131', '#9C9FA1', '#0052C4', '#2E9632'];
            var totalCols = cols.length;
            var doughnutCenter = {
                id: 'doughnutCenter',
                afterDraw: function(chart) {
                    var ctx2 = chart.ctx;
                    var cx = chart.chartArea.left + (chart.chartArea.right - chart.chartArea.left) / 2;
                    var cy = chart.chartArea.top + (chart.chartArea.bottom - chart.chartArea.top) / 2;
                    ctx2.save();
                    ctx2.font = '500 22px "Geist Mono", monospace';
                    ctx2.fillStyle = '#0D0E0F';
                    ctx2.textAlign = 'center';
                    ctx2.textBaseline = 'middle';
                    ctx2.fillText(totalCols, cx, cy - 6);
                    ctx2.font = '400 11px "Inter", sans-serif';
                    ctx2.fillStyle = '#6A6F73';
                    ctx2.fillText('columns', cx, cy + 12);
                    ctx2.restore();
                }
            };
            columnTypesChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{ data: labels.map(function(l) { return types[l]; }), backgroundColor: colors.slice(0, labels.length), borderWidth: 2, borderColor: '#FFFFFF' }]
                },
                options: { responsive: true, maintainAspectRatio: true, cutout: '55%', plugins: { legend: { position: 'bottom', labels: { font: { family: '"Inter", sans-serif', size: 12 }, padding: 12 } } } },
                plugins: [doughnutCenter]
            });
        }

        function renderTrainingChart() {
            var completed = trainingJobs.filter(function(j) { return j.status.Completed; });
            if (completed.length === 0) {
                $('training-chart-wrap').style.display = 'none';
                $('training-chart-empty').style.display = '';
                return;
            }
            $('training-chart-wrap').style.display = '';
            $('training-chart-empty').style.display = 'none';

            if (typeof Chart === 'undefined') return;
            var ctx = $('trainingMetricsChart');
            if (trainingMetricsChartInstance) trainingMetricsChartInstance.destroy();

            var labels = completed.map(function(j) { return j.model_type; });
            var metrics = completed.map(function(j) {
                var m = j.status.Completed.metrics || {};
                return m.accuracy || m.r2 || m.score || 0;
            });
            var hoScores = completed.map(function(j) {
                if (j.hyperopt_metrics && j.hyperopt_metrics.best_trial) return j.hyperopt_metrics.best_trial.value || 0;
                return null;
            });
            var hasHo = hoScores.some(function(v) { return v !== null; });

            var canvas = ctx.getContext ? ctx : ctx.getContext('2d');
            var grad1 = (canvas.getContext ? canvas.getContext('2d') : canvas).createLinearGradient(0, 0, 0, 300);
            grad1.addColorStop(0, 'rgba(0, 102, 245, 0.4)');
            grad1.addColorStop(1, 'rgba(0, 102, 245, 0.05)');
            var datasets = [{
                label: 'Base Score',
                data: metrics,
                backgroundColor: grad1,
                borderColor: '#0066F5',
                borderWidth: 1.5,
                borderRadius: 6
            }];
            if (hasHo) {
                var grad2 = (canvas.getContext ? canvas.getContext('2d') : canvas).createLinearGradient(0, 0, 0, 300);
                grad2.addColorStop(0, 'rgba(58, 188, 63, 0.4)');
                grad2.addColorStop(1, 'rgba(58, 188, 63, 0.05)');
                datasets.push({
                    label: 'After Auto-Tune',
                    data: hoScores,
                    backgroundColor: grad2,
                    borderColor: '#3ABC3F',
                    borderWidth: 1.5,
                    borderRadius: 6
                });
            }
            trainingMetricsChartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: datasets },
                options: { responsive: true, maintainAspectRatio: true, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } }, plugins: { legend: { position: 'top', labels: { font: { family: '"Inter", sans-serif', size: 12 } } } } }
            });
        }

        function renderAnomalyChart(data) {
            if (!data || typeof Chart === 'undefined') return;
            $('anomaly-chart-wrap').style.display = '';
            var ctx = $('anomalyChart');
            if (anomalyChartInstance) anomalyChartInstance.destroy();
            var anomalyCount = data.anomalies_found;
            var anomalyCenterPlugin = {
                id: 'anomalyCenter',
                afterDraw: function(chart) {
                    var ctx2 = chart.ctx;
                    var cx = chart.chartArea.left + (chart.chartArea.right - chart.chartArea.left) / 2;
                    var cy = chart.chartArea.top + (chart.chartArea.bottom - chart.chartArea.top) / 2;
                    ctx2.save();
                    ctx2.font = '500 20px "Geist Mono", monospace';
                    ctx2.fillStyle = '#FF3131';
                    ctx2.textAlign = 'center';
                    ctx2.textBaseline = 'middle';
                    ctx2.fillText(anomalyCount, cx, cy - 6);
                    ctx2.font = '400 11px "Inter", sans-serif';
                    ctx2.fillStyle = '#6A6F73';
                    ctx2.fillText('anomalies', cx, cy + 12);
                    ctx2.restore();
                }
            };
            anomalyChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Normal', 'Anomaly'],
                    datasets: [{ data: [data.total_samples - data.anomalies_found, data.anomalies_found], backgroundColor: ['rgba(0, 102, 245, 0.15)', 'rgba(255, 49, 49, 0.2)'], borderColor: ['#0066F5', '#FF3131'], borderWidth: 1.5 }]
                },
                options: { responsive: true, maintainAspectRatio: true, cutout: '55%', plugins: { legend: { position: 'bottom', labels: { font: { family: '"Inter", sans-serif', size: 12 } } } } },
                plugins: [anomalyCenterPlugin]
            });
        }

        function renderClusteringChart(result) {
            if (!result || !result.cluster_sizes || typeof Chart === 'undefined') return;
            $('clustering-chart-wrap').style.display = '';
            var ctx = $('clusteringChart');
            if (clusteringChartInstance) clusteringChartInstance.destroy();
            var keys = Object.keys(result.cluster_sizes).sort(function(a,b) { return parseInt(a)-parseInt(b); });
            var labels = keys.map(function(k) { return k === '-1' ? 'Noise' : 'Cluster ' + k; });
            var values = keys.map(function(k) { return result.cluster_sizes[k]; });
            var colors = ['#0066F5', '#3ABC3F', '#FFA931', '#FF3131', '#9C9FA1', '#0052C4', '#2E9632', '#CC8727', '#3C8AF7', '#68CC6C'];
            var clCanvas = ctx.getContext ? ctx : ctx.getContext('2d');
            var clCtx2d = clCanvas.getContext ? clCanvas.getContext('2d') : clCanvas;
            var clGrads = colors.slice(0, labels.length).map(function(c) {
                var g = clCtx2d.createLinearGradient(0, 0, 0, 250);
                g.addColorStop(0, c + '66');
                g.addColorStop(1, c + '0D');
                return g;
            });
            clusteringChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ label: 'Samples', data: values, backgroundColor: clGrads, borderColor: colors.slice(0, labels.length), borderWidth: 1.5, borderRadius: 6 }]
                },
                options: { responsive: true, maintainAspectRatio: true, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } }
            });
        }

        function renderGaugeChart(canvasId, value, color) {
            if (typeof Chart === 'undefined') return;
            var ctx = $(canvasId);
            if (!ctx) return;
            var existing = canvasId === 'cpuGaugeChart' ? cpuGaugeInstance : memGaugeInstance;
            if (existing) existing.destroy();
            var gaugeCenterText = {
                id: 'gaugeCenterText',
                afterDraw: function(chart) {
                    var val = chart.data.datasets[0].data[0];
                    var ctx2 = chart.ctx;
                    var cx = chart.chartArea.left + (chart.chartArea.right - chart.chartArea.left) / 2;
                    var cy = chart.chartArea.bottom - 8;
                    ctx2.save();
                    ctx2.font = '500 18px "Geist Mono", monospace';
                    ctx2.fillStyle = chart.data.datasets[0].backgroundColor[0];
                    ctx2.textAlign = 'center';
                    ctx2.textBaseline = 'middle';
                    ctx2.fillText(Math.round(val) + '%', cx, cy);
                    ctx2.restore();
                }
            };
            var chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{ data: [value, 100 - value], backgroundColor: [color, '#F1F3F4'], borderWidth: 0 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: true, cutout: '75%', rotation: -90, circumference: 180,
                    animation: { duration: 800, easing: 'easeOutQuart' },
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                },
                plugins: [gaugeCenterText]
            });
            if (canvasId === 'cpuGaugeChart') cpuGaugeInstance = chart;
            else memGaugeInstance = chart;
        }

        // ── Serve Tab ──
        function loadServeModels() {
            fetch('/api/models').then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); }).then(function(d) {
                var models = d.models || [];
                var sel = $('serve-test-model');
                sel.innerHTML = '<option value="">Select a model</option>';
                if (models.length === 0) {
                    $('serve-models-list').style.display = 'none';
                    $('serve-empty').style.display = '';
                    return;
                }
                $('serve-empty').style.display = 'none';
                $('serve-models-list').style.display = '';
                var h = '<div class="table-wrap"><table><thead><tr><th>Model ID</th><th>Type</th><th>Task</th><th>Created</th><th>Actions</th></tr></thead><tbody>';
                models.forEach(function(m) {
                    var created = m.created_at ? new Date(m.created_at).toLocaleString() : '—';
                    var mtype = escHtml(m.model_type || m.algorithm || '—');
                    var task = escHtml(m.task_type || '—');
                    var safeId = escAttr(m.id || '');
                    sel.innerHTML += '<option value="' + safeId + '">' + escHtml((m.id||'').substring(0,8)) + ' (' + escHtml(mtype) + ')</option>';
                    h += '<tr>';
                    h += '<td class="mono-12px">' + safeId.substring(0,12) + '</td>';
                    h += '<td>' + mtype + '</td>';
                    h += '<td>' + task + '</td>';
                    h += '<td class="text-12px regular">' + escHtml(created) + '</td>';
                    h += '<td style="display:flex;gap:6px;">';
                    h += '<button class="btn-xs btn-ghost" onclick="serveViewStats(\'' + safeId + '\')" title="Stats"><i class="ri-bar-chart-line"></i></button>';
                    h += '<a class="btn-xs btn-ghost" href="/api/models/' + encodeURIComponent(m.id) + '/download" title="Download"><i class="ri-download-line"></i></a>';
                    h += '<button class="btn-xs btn-ghost" onclick="serveEvictCache(\'' + safeId + '\')" title="Evict cache"><i class="ri-delete-bin-line"></i></button>';
                    h += '</td>';
                    h += '</tr>';
                });
                h += '</tbody></table></div>';
                $('serve-models-list').innerHTML = h;
            }).catch(function() {
                $('serve-models-list').style.display = 'none';
                $('serve-empty').style.display = '';
            });
            // Set base URL in docs
            var base = window.location.origin;
            $('serve-base-url').textContent = base;
            var curlSpans = document.querySelectorAll('.serve-curl-base');
            for (var i = 0; i < curlSpans.length; i++) curlSpans[i].textContent = base;
        }

        function serveTestPredict() {
            var modelId = $('serve-test-model').value;
            var raw = $('serve-test-input').value.trim();
            if (!raw) { notify('Enter input data', 'error'); return; }
            var body;
            try {
                var parsed = JSON.parse(raw);
                body = { data: parsed };
                if (modelId) body.model_id = modelId;
            } catch(e) { notify('Invalid JSON: ' + e.message, 'error'); return; }
            $('serve-test-result').style.display = 'none';
            fetch('/api/predict', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) })
                .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
                .then(function(d) {
                    $('serve-test-result').style.display = '';
                    $('serve-test-output').textContent = JSON.stringify(d, null, 2);
                })
                .catch(function(e) {
                    $('serve-test-result').style.display = '';
                    $('serve-test-output').textContent = 'Error: ' + e.message;
                });
        }

        function serveViewStats(modelId) {
            fetch('/api/predict/stats/' + modelId)
                .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
                .then(function(d) {
                    if (d.stats) {
                        var s = d.stats;
                        notify('p50=' + (s.p50_latency_ms||0).toFixed(2) + 'ms  p95=' + (s.p95_latency_ms||0).toFixed(2) + 'ms  reqs=' + (s.total_predictions||0), 'success');
                    } else {
                        notify('Model not cached yet — send a prediction first', 'error');
                    }
                })
                .catch(function() { notify('Model not cached — send a prediction to load it', 'error'); });
        }

        function serveEvictCache(modelId) {
            fetch('/api/predict/cache/' + modelId, { method: 'DELETE' })
                .then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
                .then(function(d) { notify(d.message || 'Cache evicted', 'success'); })
                .catch(function() { notify('Failed to evict cache', 'error'); });
        }

        // ── Init ──
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Chart.js global defaults
                if (typeof Chart !== 'undefined') {
                    Chart.defaults.animation.duration = 1000;
                    Chart.defaults.animation.easing = 'easeOutQuart';
                    Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(13, 14, 15, 0.9)';
                    Chart.defaults.plugins.tooltip.titleFont = { family: '"Inter", sans-serif', size: 13, weight: '500' };
                    Chart.defaults.plugins.tooltip.bodyFont = { family: '"Geist Mono", monospace', size: 12 };
                    Chart.defaults.plugins.tooltip.cornerRadius = 8;
                    Chart.defaults.plugins.tooltip.padding = 10;
                    Chart.defaults.scale.grid = Chart.defaults.scale.grid || {};
                    Chart.defaults.scale.grid.color = 'rgba(221, 225, 227, 0.6)';
                }
                setupDropzone();
                setupSamplePills();
                setupModelCheckboxes();
                setupEnsembleCheckboxes();
                setupAutoMLModelCheckboxes();
                // automl-target change is handled by the column select onChange callback
                if ($('automl-task-type')) {
                    $('automl-task-type').addEventListener('change', function() {
                        if (automlMultiselect) automlMultiselect.refresh();
                    });
                }
                setInterval(function() { refreshSystemStatus(); loadAlerts(); loadPerformanceStats(); loadRateLimitStats(); }, 15000);

                // cfg-targetColumn change is handled by the column select onChange callback

                $('cfg-taskType').addEventListener('change', function() {
                    if (modelMultiselect) modelMultiselect.refresh();
                    if (ensembleMultiselect) ensembleMultiselect.refresh();
                });

                // Load search space when hyperopt model changes
                $('ho-model').addEventListener('change', function() {
                    loadSearchSpace(this.value);
                });
                loadSearchSpace($('ho-model').value);
                loadHyperoptHistory();
            } catch (e) {
                console.error('Init error:', e);
            }
        });
    </script>
</body>
</html>
